(function(){var t,i,e,n,o,r,s=[].slice,l=function(t,i){return function(){return t.apply(i,arguments)}},a=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1},u={}.hasOwnProperty,d=function(t,i){function e(){this.constructor=t}for(var n in i)u.call(i,n)&&(t[n]=i[n]);return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var i=this;return++this.count,function(){var e,n;return e=arguments.length>=1?s.call(arguments,0):[],null!=t&&null!=(n=t.assign_fn)&&n.apply(null,e),i._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},r="undefined"!=typeof exports&&null!==exports?exports:this,r.sortHelper=function(t,i){var e,n;return t.points===i.points?(e=t.text.replace(/[^a-z0-9]/gi,""),n=i.text.replace(/[^a-z0-9]/gi,""),e===n?0:e>n?1:-1):t.points>i.points?1:-1},$.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)},$.getParameterByName=function(t){var i,e,n;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e="[\\?&]"+t+"=([^&#]*)",i=RegExp(e),n=i.exec(window.location.search),null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))},r.SquadBuilder=function(){function t(t){this.releaseUnique=l(this.releaseUnique,this),this.claimUnique=l(this.claimUnique,this),this.onPointsUpdated=l(this.onPointsUpdated,this),this.container=$(t.container),this.faction=$.trim(t.faction),this.ships=[],this.uniques_in_use={Pilot:[],Upgrade:[],Modification:[],Title:[]},this.loading_from_serialized=!1,this.setupUI(),this.setupEventHandlers(),$.getParameterByName("f")===this.faction?this.loadFromSerialized($.getParameterByName("d")):this.addShip()}return t.prototype.setupUI=function(){return this.status_container=$(document.createElement("DIV")),this.status_container.addClass("container-fluid"),this.status_container.append($.trim('<div class="span4 points-display-container">Total Points: 0</div>\n<div class="span4 offset4 permalink-container"><a href="#">Permalink</a></div>')),this.container.append(this.status_container),this.points_container=$(this.status_container.find("div.points-display-container")),this.permalink=$(this.status_container.find("div.permalink-container a")),this.ship_container=$(document.createElement("DIV")),this.ship_container.addClass("container-fluid"),this.container.append(this.ship_container),this.button_container=$(document.createElement("DIV")),this.button_container.addClass("container-fluid"),this.container.append(this.button_container),this.button_container.append($.trim('<button class="btn">View as Text</button>')),this.view_list_button=$(this.button_container.find("button")),this.list_modal=$(document.createElement("DIV")),this.list_modal.addClass("modal hide fade"),$(document).append(this.list_modal),this.list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>'+this.faction+': <span class="total-points">0</span> Points </h3>\n</div>\n<div class="modal-body">\n    <ul></ul>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.text_ul=$(this.list_modal.find("div.modal-body ul")),this.text_total_points_container=$(this.list_modal.find("div.modal-header span.total-points"))},t.prototype.setupEventHandlers=function(){var t=this;return this.container.on("xwing:claimUnique",function(i,e,n,o){return t.claimUnique(e,n,o)}).on("xwing:releaseUnique",function(i,e,n,o){return t.releaseUnique(e,n,o)}).on("xwing:pointsUpdated",function(i,e){return null==e&&(e=$.noop),t.onPointsUpdated(e)}),this.view_list_button.click(function(i){return i.preventDefault(),t.showTextListModal()})},t.prototype.onPointsUpdated=function(t){var i,e,n,o,r,s;for(n=0,s=this.ships,i=o=0,r=s.length;r>o;i=++o)e=s[i],n+=e.getPoints();return this.points_container.text("Total Points: "+n),this.text_total_points_container.text(n),this.permalink.attr("href",""+window.location.href.split("?")[0]+"?f="+encodeURI(this.faction)+"&d="+encodeURI(this.serialize())),t(n)},t.prototype.showTextListModal=function(){var t,i,e,n,o,r,s,l,a,u,d;for(this.text_ul.text(""),a=this.ships,o=0,s=a.length;s>o;o++)if(i=a[o],null!=i.pilot){if(i.getPoints()!==i.pilot.points){for(t="<ul>",null!=i.title&&(t+="<li>"+(""+i.title)+"</li>"),u=i.upgrades,r=0,l=u.length;l>r;r++)n=u[r],null!=n.data&&(t+="<li>"+(""+n)+"</li>");null!=(null!=(d=i.modification)?d.data:void 0)&&(t+="<li>"+(""+i.modification)+"</li>"),t+="</ul>",e="Total: "+i.getPoints()}else e="",t="";this.text_ul.append($.trim("<li>\n    <strong>"+i.pilot.name+" ("+i.pilot.points+")</strong>\n    <br />\n    "+t+"\n    <em>"+e+"</em>\n</li>"))}return this.list_modal.modal("show")},t.prototype.serialize=function(){var t,i,e,n;return function(){var o,r,s,l,a,u,d,p,c,h;for(s=this.ships,h=[],o=0,r=s.length;r>o;o++)i=s[o],null!=i.pilot&&h.push(""+i.pilot.id+":"+function(){var n,o,r,s,l,a;for(r=i.pilot.slots,a=[],t=n=0,o=r.length;o>n;t=++n)e=r[t],a.push(null!=(s=null!=(l=i.upgrades[t].data)?l.id:void 0)?s:-1);return a}()+":"+(null!=(l=null!=(a=i.title)?null!=(u=a.data)?u.id:void 0:void 0)?l:-1)+":"+function(){var t,e,o,r,s,l,a,u;for(s=null!=(o=null!=(r=i.title)?r.conferredUpgrades:void 0)?o:[],u=[],t=0,e=s.length;e>t;t++)n=s[t],u.push(null!=(l=null!=(a=n.data)?a.id:void 0)?l:-1);return u}()+":"+(null!=(d=null!=(p=i.modification)?null!=(c=p.data)?c.id:void 0:void 0)?d:-1));return h}.call(this).join(";")},t.prototype.loadFromSerialized=function(t){var i,e,n,o,r,s,l,a,u,d,p,c,h,f,m,_,g,v,y;for(this.loading_from_serialized=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";for(_=t.split(";"),d=0,h=_.length;h>d;d++){for(r=_[d],g=r.split(":"),o=g[0],u=g[1],l=g[2],s=g[3],e=g[4],n=this.addShip(),n.setPilotById(parseInt(o)),v=u.split(","),i=p=0,f=v.length;f>p;i=++p)a=v[i],a=parseInt(a),a>=0&&n.upgrades[i].setById(a);if(l=parseInt(l),l>=0&&n.title.setById(l),null!=n.title&&n.title.conferredUpgrades.length>0)for(y=s.split(","),i=c=0,m=y.length;m>c;i=++c)a=y[i],a=parseInt(a),a>=0&&n.title.conferredUpgrades[i].setById(a);e=parseInt(e),e>=0&&n.modification.setById(e),n.updateSelections()}return this.loading_from_serialized=!1,this.addShip()},t.prototype.uniqueIndex=function(t,i){if(!(i in this.uniques_in_use))throw"Invalid unique type '"+i+"'";return this.uniques_in_use[i].indexOf(t)},t.prototype.claimUnique=function(t,i,e){var n,o;if(!(0>this.uniqueIndex(t,i)))throw"Unique "+i+" '"+t.name+"' already claimed";if("Pilot"===i){if(n=r.upgrades[t.name],null!=n&&null!=(null!=n?n.unique:void 0)){if(!(0>this.uniqueIndex(n,"Upgrade")))throw"Unique "+i+" '"+t.name+"' already claimed as crew";this.uniques_in_use.Upgrade.push(n)}}else if("Upgrade"===i&&"Crew"===t.slot&&(o=r.pilots[t.name],null!=o&&null!=(null!=o?o.unique:void 0))){if(!(0>this.uniqueIndex(o,"Pilot")))throw"Unique "+i+" '"+t.name+"' already claimed as pilot";this.uniques_in_use.Pilot.push(o)}return this.uniques_in_use[i].push(t),e()},t.prototype.releaseUnique=function(t,i,e){var n,o,s;if(o=this.uniqueIndex(t,i),!(o>=0))throw"Unique "+i+" '"+t.name+"' not in use";if(this.uniques_in_use[i].splice(o,1),"Pilot"===i){if(n=r.upgrades[t.name],null!=n&&null!=(null!=n?n.unique:void 0)){if(o=this.uniqueIndex(n,"Upgrade"),0>o)throw"Unique crew accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Upgrade.splice(o,1)}}else if("Upgrade"===i&&"Crew"===t.slot&&(s=r.pilots[t.name],null!=s&&null!=(null!=s?s.unique:void 0))){if(o=this.uniqueIndex(s,"Pilot"),0>o)throw"Unique pilot accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Pilot.splice(o,1)}return e()},t.prototype.addShip=function(){var t;return t=new e({builder:this,container:this.ship_container}),this.ships.push(t),t},t.prototype.removeShip=function(t){var i,e,n,o=this;n=__iced_k_noop,i=iced.findDeferral(arguments),function(n){e=new iced.Deferrals(n,{parent:i,funcname:"SquadBuilder.removeShip"}),t.destroy(e.defer({lineno:253})),e._fulfill()}(function(){e=new iced.Deferrals(n,{parent:i,funcname:"SquadBuilder.removeShip"}),o.container.trigger("xwing:pointsUpdated",e.defer({lineno:254})),e._fulfill()})},t.prototype.matcher=function(t,i){return t.toUpperCase().indexOf(i.toUpperCase())>=0},t.prototype.getAvailablePilotsIncluding=function(t,i){var e,n,o,s,l,u,d,p,c,h,f,m,_;for(null==i&&(i=""),d=function(){var t,o;t=r.pilots,o=[];for(n in t)e=t[n],r.ships[e.ship].faction===this.faction&&this.matcher(n,i)&&(null==e.unique||0>a.call(this.uniques_in_use.Pilot,e))&&o.push(e);return o}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,i)&&d.push(t),s={},m=function(){var t,i,n;for(n=[],t=0,i=d.length;i>t;t++)e=d[t],n.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points,ship:e.ship});return n}(),p=0,h=m.length;h>p;p++)o=m[p],o.ship in s||(s[o.ship]=[]),s[o.ship].push(o);for(l=[],_=Object.keys(s).sort(),c=0,f=_.length;f>c;c++)u=_[c],l.push({text:u,children:s[u].sort(r.sortHelper)});return l},t.prototype.getAvailableUpgradesIncluding=function(t,i,e){var n,o,s;return null==e&&(e=""),n=function(){var i,n;i=r.upgrades,n=[];for(s in i)o=i[s],o.slot===t&&this.matcher(s,e)&&(null==o.unique||0>a.call(this.uniques_in_use.Upgrade,o))&&(null==o.faction||o.faction===this.faction)&&n.push(o);return n}.call(this),null!=i&&null!=i.unique&&this.matcher(i.name,e)&&n.push(i),function(){var t,i,e;for(e=[],t=0,i=n.length;i>t;t++)o=n[t],e.push({id:o.id,text:""+o.name+" ("+o.points+")",points:o.points});return e}().sort(r.sortHelper)},t.prototype.getAvailableModificationsIncluding=function(t,i){var e,n,o;return null==i&&(i=""),o=function(){var t,o;t=r.modifications,o=[];for(n in t)e=t[n],this.matcher(n,i)&&(null==e.unique||0>a.call(this.uniques_in_use.Modification,e))&&(null==e.faction||e.faction===this.faction)&&o.push(e);return o}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,i)&&o.push(t),function(){var t,i,n;for(n=[],t=0,i=o.length;i>t;t++)e=o[t],n.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points});return n}().sort(r.sortHelper)},t.prototype.getAvailableTitlesIncluding=function(t,i,e){var n,o,s;return null==e&&(e=""),s=function(){var i,s;i=r.titles,s=[];for(o in i)n=i[o],n.ship===t&&this.matcher(o,e)&&0>a.call(this.uniques_in_use.Title,n)&&(null==n.faction||n.faction===this.faction)&&s.push(n);return s}.call(this),null!=i&&this.matcher(i.name,e)&&s.push(i),function(){var t,i,e;for(e=[],t=0,i=s.length;i>t;t++)n=s[t],e.push({id:n.id,text:""+n.name+" ("+n.points+")",points:n.points});return e}().sort(r.sortHelper)},t}(),e=function(){function t(t){this.builder=t.builder,this.container=t.container,this.pilot=null,this.data=null,this.upgrades=[],this.modification=null,this.title=null,this.setupUI()}return t.prototype.destroy=function(t){var i;if(this.resetPilot(),this.resetAddons(),this.teardownUI(),i=this.builder.ships.indexOf(this),0>i)throw"Ship not registered with builder";return this.builder.ships.splice(i,1),t()},t.prototype.setPilotById=function(t){return this.setPilot(r.pilotsById[parseInt(t)])},t.prototype.setPilotByName=function(t){return this.setPilot(r.pilots[$.trim(t)])},t.prototype.setPilot=function(t){var i,e,n,o=this;return n=__iced_k_noop,i=iced.findDeferral(arguments),t===this.pilot?n():(null==this.pilot&&(this.builder.loading_from_serialized||this.builder.addShip(),this.remove_button.fadeIn("fast")),this.resetPilot(),this.resetAddons(),this.data=r.ships[null!=t?t.ship:void 0],function(n){return null==(null!=t?t.unique:void 0)?n():(function(n){e=new iced.Deferrals(n,{parent:i,funcname:"Ship.setPilot"}),o.builder.container.trigger("xwing:claimUnique",[t,"Pilot",e.defer({lineno:342})]),e._fulfill()}(n),void 0)}(function(){return o.pilot=t,null!=o.pilot&&o.setupAddons(),n(o.builder.container.trigger("xwing:pointsUpdated"))}),void 0)},t.prototype.resetPilot=function(){var t,i,e,n=this;e=__iced_k_noop,t=iced.findDeferral(arguments),function(e){var o;return null==(null!=(o=n.pilot)?o.unique:void 0)?e():(function(e){i=new iced.Deferrals(e,{parent:t,funcname:"Ship.resetPilot"}),n.builder.container.trigger("xwing:releaseUnique",[n.pilot,"Pilot",i.defer({lineno:349})]),i._fulfill()}(e),void 0)}(function(){return n.pilot=null})},t.prototype.setupAddons=function(){var t,e,s,l,a;for(a=null!=(l=this.pilot.slots)?l:[],e=0,s=a.length;s>e;e++)t=a[e],this.upgrades.push(new o({ship:this,container:this.addon_container,slot:t}));return this.pilot.ship in r.titlesByShip&&(this.title=new n({ship:this,container:this.addon_container})),this.modification=new i({ship:this,container:this.addon_container})},t.prototype.resetAddons=function(){var t,i,e,n,o,r=this;o=__iced_k_noop,e=iced.findDeferral(arguments),function(o){var s,l,a;for(n=new iced.Deferrals(o,{parent:e,funcname:"Ship.resetAddons"}),a=r.upgrades,t=s=0,l=a.length;l>s;t=++s)i=a[t],i.destroy(n.defer({lineno:372}));null!=r.modification&&r.modification.destroy(n.defer({lineno:373})),null!=r.title&&r.title.destroy(n.defer({lineno:374})),n._fulfill()}(function(){return r.upgrades=[],r.modification=null,r.title=null})},t.prototype.getPoints=function(){var t,i,e,n,o,r,s,l,a,u,d;for(t=(null!=(o=null!=(r=this.pilot)?r.points:void 0)?o:0)+(null!=(s=null!=(l=this.modification)?l.getPoints():void 0)?s:0)+(null!=(a=null!=(u=this.title)?u.getPoints():void 0)?a:0),d=this.upgrades,e=0,n=d.length;n>e;e++)i=d[e],t+=i.getPoints();return this.points_container.text(t),null!=this.pilot&&this.points_container.show(),t},t.prototype.updateSelections=function(){var t,i,e,n;if(null==this.pilot)return this.pilot_selector.select2("data",null);for(this.pilot_selector.select2("data",{id:this.pilot.id,text:""+this.pilot.name+" ("+this.pilot.points+")"}),n=this.upgrades,i=0,e=n.length;e>i;i++)t=n[i],t.updateSelection();return null!=this.title&&this.title.updateSelection(),null!=this.modification?this.modification.updateSelection():void 0},t.prototype.setupUI=function(){var t=this;return this.row=$(document.createElement("DIV")),this.row.addClass("row"),this.container.append(this.row),this.row.append($.trim('<div class="span4 pilot-selector-container">\n    <input type="hidden" />\n</div>\n<div class="span1 points-display-container" />\n<div class="span6 addon-container" />\n<div class="span1 remove-btn-container">\n    <button class="btn btn-danger">&times;</button>\n</div>')),this.pilot_selector=$(this.row.find("div.pilot-selector-container input[type=hidden]")),this.pilot_selector.select2({width:"100%",placeholder:"Select a pilot",query:function(i){return i.callback({more:!1,results:t.builder.getAvailablePilotsIncluding(t.pilot,i.term)})}}),this.pilot_selector.on("change",function(){return t.setPilotById(t.pilot_selector.select2("val"))}),this.points_container=$(this.row.find("div.points-display-container")),this.points_container.hide(),this.addon_container=$(this.row.find("div.addon-container")),this.remove_button=$(this.row.find("div.remove-btn-container button")),this.remove_button.click(function(i){return i.preventDefault(),t.row.slideUp("fast",function(){return t.builder.removeShip(t)})}),this.remove_button.hide()},t.prototype.teardownUI=function(){return this.row.text(""),this.row.remove()},t}(),t=function(){function t(t){this.ship=t.ship,this.container=$(t.container),this.data=null,this.type=null,this.dataByName=null,this.dataById=null}return t.prototype.destroy=function(){var t,i,e,n,o,r=this;o=__iced_k_noop,e=iced.findDeferral(arguments),i=arguments[0],t=arguments.length>=2?s.call(arguments,1):[],function(t){var i;return null==(null!=(i=r.data)?i.unique:void 0)?t():(function(t){n=new iced.Deferrals(t,{parent:e,funcname:"GenericAddon.destroy"}),r.ship.builder.container.trigger("xwing:releaseUnique",[r.data,r.type,n.defer({lineno:459})]),n._fulfill()}(t),void 0)}(function(){return r.selector.select2("destroy"),i(t)})},t.prototype.setupSelector=function(t){var i=this;return this.selector=$(document.createElement("INPUT")),this.selector.attr("type","hidden"),this.container.append(this.selector),this.selector.select2(t),this.selector.on("change",function(){return i.setById(i.selector.select2("val"))})},t.prototype.setById=function(t){return this.setData(this.dataById[parseInt(t)])},t.prototype.setByName=function(t){return this.setData(this.dataByName[$.trim(t)])},t.prototype.setData=function(t){var i,e,n,o=this;return n=__iced_k_noop,i=iced.findDeferral(arguments),t===this.data?n():(function(t){var n;return null==(null!=(n=o.data)?n.unique:void 0)?t():(function(t){e=new iced.Deferrals(t,{parent:i,funcname:"GenericAddon.setData"}),o.ship.builder.container.trigger("xwing:releaseUnique",[o.data,o.type,e.defer({lineno:480})]),e._fulfill()}(t),void 0)}(function(){(function(n){return null==(null!=t?t.unique:void 0)?n():(function(n){e=new iced.Deferrals(n,{parent:i,funcname:"GenericAddon.setData"}),o.ship.builder.container.trigger("xwing:claimUnique",[t,o.type,e.defer({lineno:482})]),e._fulfill()}(n),void 0)})(function(){return o.data=t,n(o.ship.builder.container.trigger("xwing:pointsUpdated"))})}),void 0)},t.prototype.getPoints=function(){var t,i;return null!=(t=null!=(i=this.data)?i.points:void 0)?t:0},t.prototype.updateSelection=function(){return null!=this.data?this.selector.select2("data",{id:this.data.id,text:""+this.data.name+" ("+this.data.points+")"}):this.selector.select2("data",null)},t.prototype.toString=function(){return null!=this.data?""+this.data.name+" ("+this.data.points+")":"No "+this.type},t}(),o=function(t){function i(t){i.__super__.constructor.call(this,t),this.slot=t.slot,this.type="Upgrade",this.dataById=r.upgradesById,this.dataByName=r.upgrades,this.setupSelector()}return d(i,t),i.prototype.setupSelector=function(){var t=this;return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No "+this.slot+" Upgrade",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableUpgradesIncluding(t.slot,t.data,i.term)})}})},i}(t),i=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Modification",this.dataById=r.modificationsById,this.dataByName=r.modifications,this.setupSelector()}return d(i,t),i.prototype.setupSelector=function(){var t=this;return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Modification",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableModificationsIncluding(t.data,i.term)})}})},i}(t),n=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Title",this.dataById=r.titlesById,this.dataByName=r.titles,this.conferredUpgrades=[],this.setupSelector()}return d(i,t),i.prototype.setData=function(t){var i,e,n,r,s,l,a=this;return l=__iced_k_noop,r=iced.findDeferral(arguments),t===this.data?l():(function(t){return null==a.data?t():(function(t){s=new iced.Deferrals(t,{parent:r,funcname:"Title.setData"}),a.ship.builder.container.trigger("xwing:releaseUnique",[a.data,"Title",s.defer({lineno:557})]),s._fulfill()}(function(){(function(t){var i,e,o;for(s=new iced.Deferrals(t,{parent:r,funcname:"Title.setData"}),o=a.conferredUpgrades,i=0,e=o.length;e>i;i++)n=o[i],n.destroy(s.defer({lineno:561}));s._fulfill()})(function(){var e,o,r;for(r=a.conferredUpgrades,e=0,o=r.length;o>e;e++)n=r[e],i=a.ship.upgrades.indexOf(n),a.ship.upgrades.splice(i,1);return t(a.conferredUpgrades=[])})}),void 0)}(function(){(function(i){return null==t?i():(function(i){s=new iced.Deferrals(i,{parent:r,funcname:"Title.setData"}),a.ship.builder.container.trigger("xwing:claimUnique",[t,"Title",s.defer({lineno:566})]),s._fulfill()}(i),void 0)})(function(){var i,r,s,u;if(a.data=t,a.ship.builder.container.trigger("xwing:pointsUpdated"),null!=(null!=(s=a.data)?s.slots:void 0)&&a.data.slots.length>0)for(u=a.data.slots,i=0,r=u.length;r>i;i++)e=u[i],n=new o({ship:a.ship,container:a.container,slot:e}),a.ship.upgrades.push(n),a.conferredUpgrades.push(n);return l()})}),void 0)},i.prototype.setupSelector=function(){var t=this;return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Title",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableTitlesIncluding(t.ship.data.name,t.data,i.term)})}})},i}(t)}).call(this);