(function(){var t,e=[].slice,n=function(t,e){return function(){return t.apply(e,arguments)}};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){return++this.count,function(n){return function(){var a,i;return a=1<=arguments.length?e.call(arguments,0):[],null!=t&&null!=(i=t.assign_fn)&&i.apply(null,a),n._fulfill()}}(this)},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},t="undefined"!=typeof exports&&null!==exports?exports:this,t.SquadBuilderBackend=function(){function e(t){this.getLanguagePreference=n(this.getLanguagePreference,this),this.nameCheck=n(this.nameCheck,this),this.maybeAuthenticationChanged=n(this.maybeAuthenticationChanged,this);var e,a,i,s;for($.ajaxSetup({dataType:"json",xhrFields:{withCredentials:!0}}),this.server=t.server,this.builders=t.builders,this.login_logout_button=$(t.login_logout_button),this.auth_status=$(t.auth_status),this.authenticated=!1,this.ui_ready=!1,this.oauth_window=null,this.method_metadata={google_oauth2:{icon:"icon-google-plus-sign",text:"Google"},facebook:{icon:"icon-facebook-sign",text:"Facebook"},twitter:{icon:"icon-twitter-sign",text:"Twitter"}},this.squad_display_mode="all",this.collection_save_timer=null,this.setupHandlers(),this.setupUI(),this.authenticate(function(t){return function(){return t.auth_status.hide(),t.login_logout_button.removeClass("hidden")}}(this)),s=this.builders,a=0,i=s.length;i>a;a++)e=s[a],e.setBackend(this);this.updateAuthenticationVisibility()}return e.prototype.updateAuthenticationVisibility=function(){return this.authenticated?($(".show-authenticated").show(),$(".hide-authenticated").hide()):($(".show-authenticated").hide(),$(".hide-authenticated").show())},e.prototype.save=function(t,e,n,a,i,s){var o,d;if(null==e&&(e=null),null==i&&(i={}),""===t)return s({id:null,success:!1,error:"You cannot save an empty squad"});if(""===$.trim(n))return s({id:null,success:!1,error:"Squad name cannot be empty"});if(null==a||""===a)throw"Faction unspecified to save()";return o={name:$.trim(n),faction:$.trim(a),serialized:t,additional_data:i},null!=e?d=""+this.server+"/squads/"+e:(d=""+this.server+"/squads/new",o._method="put"),$.post(d,o,function(){return function(t){return s({id:t.id,success:t.success,error:t.error})}}(this))},e.prototype["delete"]=function(t,e){var n;return n={_method:"delete"},$.post(""+this.server+"/squads/"+t,n,function(){return function(t){return e({success:t.success,error:t.error})}}(this))},e.prototype.list=function(t,e){var n,a,i;return null==e&&(e=!1),e?this.squad_list_modal.find(".modal-header h3").text("Everyone's "+t.faction+" Squads"):this.squad_list_modal.find(".modal-header h3").text("Your "+t.faction+" Squads"),n=$(this.squad_list_modal.find("ul.squad-list")),n.text(""),n.hide(),a=$(this.squad_list_modal.find("p.squad-list-loading")),a.show(),this.show_all_squads_button.click(),this.squad_list_modal.modal("show"),i=e?""+this.server+"/all":""+this.server+"/squads/list",$.get(i,function(e){return function(i){var s,o,d,u,l;if(0===i[t.faction].length)n.append($.trim("<li>You have no squads saved.  Go save one!</li>"));else for(l=i[t.faction],d=0,u=l.length;u>d;d++)o=l[d],s=$(document.createElement("LI")),s.data("squad",o),s.data("builder",t),n.append(s),s.append($.trim('<div class="row-fluid">\n    <div class="span9">\n        <h4>'+o.name+'</h4>\n    </div>\n    <div class="span3">\n        <h5>'+o.additional_data.points+' Points</h5>\n    </div>\n</div>\n<div class="row-fluid">\n    <div class="span10">\n        '+o.additional_data.description+'\n    </div>\n    <div class="span2">\n        <button class="btn load-squad">Load</button>\n    </div>\n</div>')),s.find("button.load-squad").click(function(n){var a;return n.preventDefault(),a=$(n.target),s=a.closest("li"),t=s.data("builder"),e.squad_list_modal.modal("hide"),t.current_squad.dirty?e.warnUnsaved(t,function(){return t.container.trigger("xwing-backend:squadLoadRequested",s.data("squad"))}):t.container.trigger("xwing-backend:squadLoadRequested",s.data("squad"))});return a.fadeOut("fast"),n.fadeIn("fast")}}(this))},e.prototype.authenticate=function(t){var e;return null==t&&(t=$.noop),$(this.auth_status.find(".payload")).text("Checking auth status..."),this.auth_status.show(),e=this.authenticated,$.ajax({url:""+this.server+"/ping",success:function(n){return function(a){return n.authenticated=(null!=a?a.success:void 0)?!0:!1,n.maybeAuthenticationChanged(e,t)}}(this),error:function(n){return function(){return n.authenticated=!1,n.maybeAuthenticationChanged(e,t)}}(this)})},e.prototype.maybeAuthenticationChanged=function(t,e){return t!==this.authenticated&&$(window).trigger("xwing-backend:authenticationChanged",[this.authenticated,this]),this.oauth_window=null,this.auth_status.hide(),e(this.authenticated),this.authenticated},e.prototype.login=function(){return this.ui_ready?this.login_modal.modal("show"):void 0},e.prototype.logout=function(t){return null==t&&(t=$.noop),$(this.auth_status.find(".payload")).text("Logging out..."),this.auth_status.show(),$.get(""+this.server+"/auth/logout",function(e){return function(){return e.authenticated=!1,$(window).trigger("xwing-backend:authenticationChanged",e.authenticated),e.auth_status.hide(),t()}}(this))},e.prototype.showSaveAsModal=function(t){return this.save_as_modal.data("builder",t),this.save_as_input.val(t.current_squad.name),this.save_as_save_button.addClass("disabled"),this.nameCheck(),this.save_as_modal.modal("show")},e.prototype.showDeleteModal=function(t){return this.delete_modal.data("builder",t),this.delete_name_container.text(t.current_squad.name),this.delete_modal.modal("show")},e.prototype.nameCheck=function(){var t;return window.clearInterval(this.save_as_modal.data("timer")),t=$.trim(this.save_as_input.val()),0===t.length?(this.name_availability_container.text(""),this.name_availability_container.append($.trim('<i class="icon-thumbs-down"> A name is required'))):$.post(""+this.server+"/squads/namecheck",{name:t},function(t){return function(e){return t.name_availability_container.text(""),e.available?(t.name_availability_container.append($.trim('<i class="icon-thumbs-up"> Name is available')),t.save_as_save_button.removeClass("disabled")):(t.name_availability_container.append($.trim('<i class="icon-thumbs-down"> You already have a squad with that name')),t.save_as_save_button.addClass("disabled"))}}(this))},e.prototype.warnUnsaved=function(t,e){return this.unsaved_modal.data("builder",t),this.unsaved_modal.data("callback",e),this.unsaved_modal.modal("show")},e.prototype.setupUI=function(){var t;return this.auth_status.addClass("disabled"),this.auth_status.click(function(){return function(){return!1}}(this)),this.login_modal=$(document.createElement("DIV")),this.login_modal.addClass("modal hide fade hidden-print"),$(document.body).append(this.login_modal),this.login_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Log in with OAuth</h3>\n</div>\n<div class="modal-body">\n    <p>\n        Select one of the OAuth providers below to log in and start saving squads.\n        <a class="login-help" href="#">What\'s this?</a>\n    </p>\n    <div class="well well-small oauth-explanation">\n        <p>\n            <a href="http://en.wikipedia.org/wiki/OAuth" target="_blank">OAuth</a> is an authorization system which lets you prove your identity at a web site without having to create a new account.  Instead, you tell some provider with whom you already have an account (e.g. Google or Facebook) to prove to this web site that you say who you are.  That way, the next time you visit, this site remembers that you\'re that user from Google.\n        </p>\n        <p>\n            The best part about this is that you don\'t have to come up with a new username and password to remember.  And don\'t worry, I\'m not collecting any data from the providers about you.  I\'ve tried to set the scope of data to be as small as possible, but some places send a bunch of data at minimum.  I throw it away.  All I look at is a unique identifier (usually some giant number).\n        </p>\n        <p>\n            For more information, check out this <a href="http://hueniverse.com/oauth/guide/intro/" target="_blank">introduction to OAuth</a>.\n        </p>\n        <button class="btn">Got it!</button>\n    </div>\n    <ul class="login-providers inline"></ul>\n    <p>\n        This will open a new window to let you authenticate with the chosen provider.  You may have to allow pop ups for this site.  (Sorry.)\n    </p>\n    <p class="login-in-progress">\n        <em>OAuth login is in progress.  Please finish authorization at the specified provider using the window that was just created.</em>\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),t=$(this.login_modal.find(".oauth-explanation")),t.hide(),this.login_modal.find(".login-in-progress").hide(),this.login_modal.find("a.login-help").click(function(){return function(e){return e.preventDefault(),t.is(":visible")?void 0:t.slideDown("fast")}}(this)),t.find("button").click(function(){return function(e){return e.preventDefault(),t.slideUp("fast")}}(this)),$.get(""+this.server+"/methods",function(t){return function(e){var n,a,i,s,o,d,u;for(s=$(t.login_modal.find("ul.login-providers")),u=e.methods,o=0,d=u.length;d>o;o++)i=u[o],n=$(document.createElement("A")),n.addClass("btn btn-inverse"),n.data("url",""+t.server+"/auth/"+i),n.append('<i class="'+t.method_metadata[i].icon+'"></i>&nbsp;'+t.method_metadata[i].text),n.click(function(e){return e.preventDefault(),s.slideUp("fast"),t.login_modal.find(".login-in-progress").slideDown("fast"),t.oauth_window=window.open($(e.target).data("url"),"xwing_login")}),a=$(document.createElement("LI")),a.append(n),s.append(a);return t.ui_ready=!0}}(this)),this.squad_list_modal=$(document.createElement("DIV")),this.squad_list_modal.addClass("modal hide fade hidden-print squad-list"),$(document.body).append(this.squad_list_modal),this.squad_list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3></h3>\n</div>\n<div class="modal-body">\n    <ul class="squad-list"></ul>\n    <p class="pagination-centered squad-list-loading">\n        <i class="icon-spinner icon-spin icon-3x"></i>\n        <br />\n        Fetching squads...\n    </p>\n</div>\n<div class="modal-footer">\n    <div class="btn-group squad-display-mode">\n        <button class="btn btn-inverse show-all-squads">All</button>\n        <button class="btn show-standard-squads">Standard</button>\n        <button class="btn show-epic-squads">Epic</button>\n        <button class="btn show-team-epic-squads">Team Epic</button>\n    </div>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.squad_list_modal.find("ul.squad-list").hide(),this.show_all_squads_button=$(this.squad_list_modal.find(".show-all-squads")),this.show_all_squads_button.click(function(t){return function(){return"all"!==t.squad_display_mode?(t.squad_display_mode="all",t.squad_list_modal.find(".squad-display-mode .btn").removeClass("btn-inverse"),t.show_all_squads_button.addClass("btn-inverse"),t.squad_list_modal.find(".squad-list li").show()):void 0}}(this)),this.show_standard_squads_button=$(this.squad_list_modal.find(".show-standard-squads")),this.show_standard_squads_button.click(function(t){return function(){return"standard"!==t.squad_display_mode?(t.squad_display_mode="standard",t.squad_list_modal.find(".squad-display-mode .btn").removeClass("btn-inverse"),t.show_standard_squads_button.addClass("btn-inverse"),t.squad_list_modal.find(".squad-list li").each(function(t,e){return $(e).toggle(-1===$(e).data().squad.serialized.indexOf("v3!e")&&-1===$(e).data().squad.serialized.indexOf("v3!t"))})):void 0}}(this)),this.show_epic_squads_button=$(this.squad_list_modal.find(".show-epic-squads")),this.show_epic_squads_button.click(function(t){return function(){return"epic"!==t.squad_display_mode?(t.squad_display_mode="epic",t.squad_list_modal.find(".squad-display-mode .btn").removeClass("btn-inverse"),t.show_epic_squads_button.addClass("btn-inverse"),t.squad_list_modal.find(".squad-list li").each(function(t,e){return $(e).toggle(-1!==$(e).data().squad.serialized.indexOf("v3!e"))})):void 0}}(this)),this.show_team_epic_squads_button=$(this.squad_list_modal.find(".show-team-epic-squads")),this.show_team_epic_squads_button.click(function(t){return function(){return"team-epic"!==t.squad_display_mode?(t.squad_display_mode="team-epic",t.squad_list_modal.find(".squad-display-mode .btn").removeClass("btn-inverse"),t.show_team_epic_squads_button.addClass("btn-inverse"),t.squad_list_modal.find(".squad-list li").each(function(t,e){return $(e).toggle(-1!==$(e).data().squad.serialized.indexOf("v3!t"))})):void 0}}(this)),this.save_as_modal=$(document.createElement("DIV")),this.save_as_modal.addClass("modal hide fade hidden-print"),$(document.body).append(this.save_as_modal),this.save_as_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Save Squad As...</h3>\n</div>\n<div class="modal-body">\n    <label for="xw-be-squad-save-as">\n        New Squad Name\n        <input id="xw-be-squad-save-as"></input>\n    </label>\n    <span class="name-availability"></span>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary save" aria-hidden="true">Save</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.save_as_modal.on("shown",function(t){return function(){return window.setTimeout(function(){return t.save_as_input.focus(),t.save_as_input.select()},100)}}(this)),this.save_as_save_button=this.save_as_modal.find("button.save"),this.save_as_save_button.click(function(t){return function(e){var n,a,i,s;return e.preventDefault(),t.save_as_save_button.hasClass("disabled")?void 0:(s=t.save_as_modal.data("timer"),null!=s&&window.clearInterval(s),t.save_as_modal.modal("hide"),a=t.save_as_modal.data("builder"),n={points:a.total_points,description:a.describeSquad(),cards:a.listCards(),notes:a.getNotes()},a.backend_save_list_as_button.addClass("disabled"),a.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Saving squad...')),a.backend_status.show(),i=$.trim(t.save_as_input.val()),t.save(a.serialize(),null,i,a.faction,n,function(t){return t.success?(a.current_squad.id=t.id,a.current_squad.name=i,a.current_squad.dirty=!1,a.container.trigger("xwing-backend:squadDirtinessChanged"),a.container.trigger("xwing-backend:squadNameChanged"),a.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;New squad saved successfully.'))):a.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+t.error)),a.backend_save_list_as_button.removeClass("disabled")}))}}(this)),this.save_as_input=$(this.save_as_modal.find("input")),this.save_as_input.keypress(function(t){return function(e){var n;return 13===e.which?(t.save_as_save_button.click(),!1):(t.name_availability_container.text(""),t.name_availability_container.append($.trim('<i class="icon-spin icon-spinner"></i> Checking name availability...')),n=t.save_as_modal.data("timer"),null!=n&&window.clearInterval(n),t.save_as_modal.data("timer",window.setInterval(t.nameCheck,500)))}}(this)),this.name_availability_container=$(this.save_as_modal.find(".name-availability")),this.delete_modal=$(document.createElement("DIV")),this.delete_modal.addClass("modal hide fade hidden-print"),$(document.body).append(this.delete_modal),this.delete_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Really Delete <span class="squad-name-placeholder"></span>?</h3>\n</div>\n<div class="modal-body">\n    <p>Are you sure you want to delete this squad?</p>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-danger delete" aria-hidden="true">Yes, Delete <i class="squad-name-placeholder"></i></button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Never Mind</button>\n</div>')),this.delete_name_container=$(this.delete_modal.find(".squad-name-placeholder")),this.delete_button=$(this.delete_modal.find("button.delete")),this.delete_button.click(function(t){return function(e){var n;return e.preventDefault(),n=t.delete_modal.data("builder"),n.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Deleting squad...')),n.backend_status.show(),n.backend_delete_list_button.addClass("disabled"),t.delete_modal.modal("hide"),t["delete"](n.current_squad.id,function(t){return t.success?(n.resetCurrentSquad(),n.current_squad.dirty=!0,n.container.trigger("xwing-backend:squadDirtinessChanged"),n.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;Squad deleted.'))):(n.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+t.error)),n.backend_delete_list_button.removeClass("disabled"))})}}(this)),this.unsaved_modal=$(document.createElement("DIV")),this.unsaved_modal.addClass("modal hide fade hidden-print"),$(document.body).append(this.unsaved_modal),this.unsaved_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Unsaved Changes</h3>\n</div>\n<div class="modal-body">\n    <p>You have not saved changes to this squad.  Do you want to go back and save?</p>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary" aria-hidden="true" data-dismiss="modal">Go Back</button>\n    <button class="btn btn-danger discard" aria-hidden="true">Discard Changes</button>\n</div>')),this.unsaved_discard_button=$(this.unsaved_modal.find("button.discard")),this.unsaved_discard_button.click(function(t){return function(e){return e.preventDefault(),t.unsaved_modal.data("builder").current_squad.dirty=!1,t.unsaved_modal.data("callback")(),t.unsaved_modal.modal("hide")}}(this))},e.prototype.setupHandlers=function(){return $(window).on("xwing-backend:authenticationChanged",function(t){return function(e){return t.updateAuthenticationVisibility(),e?t.loadCollection():void 0}}(this)),this.login_logout_button.click(function(t){return function(e){return e.preventDefault(),t.authenticated?t.logout():t.login()}}(this)),$(window).on("message",function(t){return function(e){var n,a,i;if(n=e.originalEvent,n.origin!==t.server)return console.log("Message received from unapproved origin "+n.origin),window.last_ev=e;switch(null!=(a=n.data)?a.command:void 0){case"auth_successful":return t.authenticate(),t.login_modal.modal("hide"),t.login_modal.find(".login-in-progress").hide(),t.login_modal.find("ul.login-providers").show(),n.source.close();default:return console.log("Unexpected command "+(null!=(i=n.data)?i.command:void 0))}}}(this)).on("xwing-collection:changed",function(t){return function(e,n){return null!=t.collection_save_timer&&clearTimeout(t.collection_save_timer),t.collection_save_timer=setTimeout(function(){return t.saveCollection(n,function(t){return t?$(window).trigger("xwing-collection:saved",n):void 0})},1e3)}}(this))},e.prototype.getSettings=function(t){return null==t&&(t=$.noop),$.get(""+this.server+"/settings").done(function(){return function(e){return t(e.settings)}}(this))},e.prototype.set=function(t,e,n){var a;return null==n&&(n=$.noop),a={_method:"PUT"},a[t]=e,$.post(""+this.server+"/settings",a).done(function(){return function(t){return n(t.set)}}(this))},e.prototype.deleteSetting=function(t,e){return null==e&&(e=$.noop),$.post(""+this.server+"/settings/"+t,{_method:"DELETE"}).done(function(){return function(t){return e(t.deleted)}}(this))},e.prototype.getHeaders=function(t){return null==t&&(t=$.noop),$.get(""+this.server+"/headers").done(function(){return function(e){return t(e.headers)}}(this))},e.prototype.getLanguagePreference=function(e){var n,a,i,s,o,d,u,l,r;r=__iced_k_noop,u=iced.findDeferral(arguments),null==e&&(e=$.noop),function(t){return function(e){l=new iced.Deferrals(e,{parent:u,filename:"coffeescripts/backend.coffee",funcname:"SquadBuilderBackend.getLanguagePreference"}),t.getSettings(l.defer({assign_fn:function(){return function(){return d=arguments[0]}}(),lineno:587})),l._fulfill()}}(this)(function(c){return function(){return null!=("undefined"!=typeof d&&null!==d?d.language:void 0)?r(e(d.language)):(!function(t){l=new iced.Deferrals(t,{parent:u,filename:"coffeescripts/backend.coffee",funcname:"SquadBuilderBackend.getLanguagePreference"}),c.getHeaders(l.defer({assign_fn:function(){return function(){return n=arguments[0]}}(),lineno:591})),l._fulfill()}(function(){var d,u,l,c,h;if(null!=("undefined"!=typeof n&&null!==n?n.HTTP_ACCEPT_LANGUAGE:void 0))for(l=n.HTTP_ACCEPT_LANGUAGE.split(","),d=0,u=l.length;u>d;d++){i=l[d],c=i.split(";"),s=c[0],o=c[1],"*"===s?e("English"):(a=s.split("-")[0],e(null!=(h=t.codeToLanguage[a])?h:"English"));break}else e("English");return r()}),void 0)}}(this))},e.prototype.saveCollection=function(t,e){var n;return null==e&&(e=$.noop),n={expansions:t.expansions},$.post(""+this.server+"/collection",n).done(function(t){return e(t.success)})},e.prototype.loadCollection=function(){return $.get(""+this.server+"/collection").done(function(e){var n;return n=e.collection,new t.Collection({expansions:n.expansions})})},e}()}).call(this);
//@ sourceMappingURL=backend.min.map