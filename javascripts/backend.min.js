(function(){var t,e=[].slice;window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var n=this;return++this.count,function(){var i,a;return i=arguments.length>=1?e.call(arguments,0):[],null!=t&&null!=(a=t.assign_fn)&&a.apply(null,i),n._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},t="undefined"!=typeof exports&&null!==exports?exports:this,t.SquadBuilderBackend=function(){function t(t){var e,n,i,a;for($.ajaxSetup({dataType:"json",xhrFields:{withCredentials:!0}}),this.server=t.server,this.builders=t.builders,this.authenticated=!1,this.ui_ready=!1,this.oauth_window=null,this.method_metadata={google_oauth2:{icon:"icon-google-plus-sign",text:"Google"},facebook:{icon:"icon-facebook-sign",text:"Facebook"}},this.setupHandlers(),this.setupUI(),this.authenticate(),a=this.builders,n=0,i=a.length;i>n;n++)e=a[n],e.setBackend(this)}return t.prototype.save=function(t,e,n,i,a,o){var s,d;return null==e&&(e=null),null==a&&(a={}),s={name:$.trim(n),faction:$.trim(i),serialized:t,additional_data:a},null!=e?d=""+this.server+"/squads/"+e:(d=""+this.server+"/squads/new",s._method="put"),$.post(d,s,function(t){return o({id:t.id,success:t.success,error:t.error})})},t.prototype["delete"]=function(t,e){var n;return n={_method:"delete"},$.post(""+this.server+"/delete/"+t,n,function(t){return e({success:t.success,error:t.error})})},t.prototype.list=function(t,e){var n,i,a,o=this;return null==e&&(e=!1),e?this.squad_list_modal.find(".modal-header h3").text("Everyone's "+t.faction+" Squads"):this.squad_list_modal.find(".modal-header h3").text("Your "+t.faction+" Squads"),n=$(this.squad_list_modal.find("ul.squad-list")),n.text(""),n.hide(),i=$(this.squad_list_modal.find("p.squad-list-loading")),i.show(),this.squad_list_modal.modal("show"),a=e?""+this.server+"/all":""+this.server+"/squads/list",$.get(a,function(e){var a,s,d,l,r;if(0===e[t.faction].length)n.append($.trim("<li>You have no squads saved.  Go save one!</li>"));else for(r=e[t.faction],d=0,l=r.length;l>d;d++)s=r[d],a=$(document.createElement("LI")),a.data("squad_id",s.id),a.data("builder",t),a.data("serialized",s.serialized),n.append(a),a.append($.trim("<h4>"+s.name+"</h4>\n<span>Points: <strong>"+s.additional_data.points+'</strong></span>\n<button class="btn pull-right load-squad">Load</button>')),a.find("button.load-squad").click(function(t){var e;return t.preventDefault(),e=$(t.target),a=e.closest("li"),a.data("builder").loadFromSerialized(a.data("serialized")),o.squad_list_modal.modal("hide")});return i.fadeOut("fast"),n.fadeIn("fast")})},t.prototype.authenticate=function(t){var e,n,i,a,o,s=this;o=__iced_k_noop,i=iced.findDeferral(arguments),null==t&&(t=$.noop),n=this.authenticated,function(t){a=new iced.Deferrals(t,{parent:i,funcname:"SquadBuilderBackend.authenticate"}),$.get(""+s.server+"/ping",a.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:123})),a._fulfill()}(function(){return(e!==void 0&&null!==e?e.success:void 0)?(s.authenticated=!0,t()):s.authenticated=!1,n!==s.authenticated&&$(window).trigger("xwing-backend:authenticationChanged",s.authenticated),s.oauth_window=null,s.authenticated})},t.prototype.login=function(){return this.ui_ready?this.login_modal.modal("show"):void 0},t.prototype.logout=function(t){var e=this;return null==t&&(t=$.noop),$.get(""+this.server+"/auth/logout",function(){return e.authenticated=!1,$(window).trigger("xwing-backend:authenticationChanged",e.authenticated),t()})},t.prototype.setupUI=function(){var t,e=this;return this.login_modal=$(document.createElement("DIV")),this.login_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.login_modal),this.login_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Log in with OAuth</h3>\n</div>\n<div class="modal-body">\n    <p>\n        Select one of the OAuth providers below to log in and start saving squads.\n        <a class="login-help" href="#">What\'s this?</a>\n    </p>\n    <div class="well well-small oauth-explanation">\n        <p>\n            <a href="http://en.wikipedia.org/wiki/OAuth" target="_blank">OAuth</a> is an authorization system which lets you prove your identity at a web site without having to create a new account.  Instead, you tell some provider with whom you already have an account (e.g. Google or Facebook) to prove to this web site that you say who you are.  That way, the next time you visit, this site remembers that you\'re that user from Google.\n        </p>\n        <p>\n            The best part about this is that you don\'t have to come up with a new username and password to remember.  And don\'t worry, I\'m not collecting any data from the providers about you.  I\'ve tried to set the scope of data to be as small as possible, but some places send a bunch of data at minimum.  I throw it away.  All I look at is a unique identifier (usually some giant number).\n        </p>\n        <p>\n            For more information, check out this <a href="http://hueniverse.com/oauth/guide/intro/" target="_blank">introduction to OAuth</a>.\n        </p>\n        <button class="btn">Got it!</button>\n    </div>\n    <ul class="login-providers inline"></ul>\n    <p>\n        This will open a new window to let you authenticate with the chosen provider.  You may have to allow pop ups for this site.  (Sorry.)\n    </p>\n    <p class="login-in-progress">\n        <em>OAuth login is in progress.  Please finish authorization at the specified provider using the window that was just created.</em>\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),t=$(this.login_modal.find(".oauth-explanation")),t.hide(),this.login_modal.find(".login-in-progress").hide(),this.login_modal.find("a.login-help").click(function(e){return e.preventDefault(),t.is(":visible")?void 0:t.slideDown("fast")}),t.find("button").click(function(e){return e.preventDefault(),t.slideUp("fast")}),$.get(""+this.server+"/methods",function(t){var n,i,a,o,s,d,l;for(o=$(e.login_modal.find("ul.login-providers")),l=t.methods,s=0,d=l.length;d>s;s++)a=l[s],n=$(document.createElement("A")),n.addClass("btn btn-inverse"),n.data("url",""+e.server+"/auth/"+a),n.append('<i class="'+e.method_metadata[a].icon+'"></i>&nbsp;'+e.method_metadata[a].text),n.click(function(t){return t.preventDefault(),o.slideUp("fast"),e.login_modal.find(".login-in-progress").slideDown("fast"),e.oauth_window=window.open($(t.target).data("url"),"xwing_login")}),i=$(document.createElement("LI")),i.append(n),o.append(i);return e.ui_ready=!0}),this.squad_list_modal=$(document.createElement("DIV")),this.squad_list_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.squad_list_modal),this.squad_list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3></h3>\n</div>\n<div class="modal-body">\n    <ul class="squad-list"></ul>\n    <p class="pagination-centered squad-list-loading">\n        <i class="icon-spinner icon-spin icon-3x"></i>\n        <br />\n        Fetching squads...\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.squad_list_modal.find("ul.squad-list").hide()},t.prototype.setupHandlers=function(){var t=this;return $(window).on("message",function(e){var n,i,a;if(n=e.originalEvent,n.origin!==t.server)return console.log("Message received from unapproved origin "+n.origin),window.last_ev=e;switch(null!=(i=n.data)?i.command:void 0){case"auth_successful":return t.authenticate(),t.login_modal.modal("hide"),t.login_modal.find(".login-in-progress").hide(),t.login_modal.find("ul.login-providers").show(),n.source.close();default:return console.log("Unexpected command "+(null!=(a=n.data)?a.command:void 0))}})},t}()}).call(this);