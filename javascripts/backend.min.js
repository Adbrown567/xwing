(function(){var t,a=function(t,a){return function(){return t.apply(a,arguments)}};t="undefined"!=typeof exports&&null!==exports?exports:this,t.SquadBuilderBackend=function(){function t(t){this.nameCheck=a(this.nameCheck,this),this.maybeAuthenticationChanged=a(this.maybeAuthenticationChanged,this);var e,n,i,s,d=this;for($.ajaxSetup({dataType:"json",xhrFields:{withCredentials:!0}}),this.server=t.server,this.builders=t.builders,this.login_logout_button=$(t.login_logout_button),this.authenticated=!1,this.ui_ready=!1,this.oauth_window=null,this.method_metadata={google_oauth2:{icon:"icon-google-plus-sign",text:"Google"},facebook:{icon:"icon-facebook-sign",text:"Facebook"},twitter:{icon:"icon-twitter-sign",text:"Twitter"}},this.setupHandlers(),this.setupUI(),this.authenticate(function(){return d.login_logout_button.removeClass("hidden")}),s=this.builders,n=0,i=s.length;i>n;n++)e=s[n],e.setBackend(this);this.updateAuthenticationVisibility()}return t.prototype.updateAuthenticationVisibility=function(){return this.authenticated?($(".show-authenticated").show(),$(".hide-authenticated").hide()):($(".show-authenticated").hide(),$(".hide-authenticated").show())},t.prototype.save=function(t,a,e,n,i,s){var d,o;if(null==a&&(a=null),null==i&&(i={}),""===t)return s({id:null,success:!1,error:"You cannot save an empty squad"});if(""===$.trim(e))return s({id:null,success:!1,error:"Squad name cannot be empty"});if(null==n||""===n)throw"Faction unspecified to save()";return d={name:$.trim(e),faction:$.trim(n),serialized:t,additional_data:i},null!=a?o=""+this.server+"/squads/"+a:(o=""+this.server+"/squads/new",d._method="put"),$.post(o,d,function(t){return s({id:t.id,success:t.success,error:t.error})})},t.prototype["delete"]=function(t,a){var e;return e={_method:"delete"},$.post(""+this.server+"/squads/"+t,e,function(t){return a({success:t.success,error:t.error})})},t.prototype.list=function(t,a){var e,n,i,s=this;return null==a&&(a=!1),a?this.squad_list_modal.find(".modal-header h3").text("Everyone's "+t.faction+" Squads"):this.squad_list_modal.find(".modal-header h3").text("Your "+t.faction+" Squads"),e=$(this.squad_list_modal.find("ul.squad-list")),e.text(""),e.hide(),n=$(this.squad_list_modal.find("p.squad-list-loading")),n.show(),this.squad_list_modal.modal("show"),i=a?""+this.server+"/all":""+this.server+"/squads/list",$.get(i,function(a){var i,d,o,l,r;if(0===a[t.faction].length)e.append($.trim("<li>You have no squads saved.  Go save one!</li>"));else for(r=a[t.faction],o=0,l=r.length;l>o;o++)d=r[o],i=$(document.createElement("LI")),i.data("squad",d),i.data("builder",t),e.append(i),i.append($.trim('<div class="row-fluid">\n    <div class="span9">\n        <h4>'+d.name+'</h4>\n    </div>\n    <div class="span3">\n        <h5>'+d.additional_data.points+' Points</h5>\n    </div>\n</div>\n<div class="row-fluid">\n    <div class="span10">\n        '+d.additional_data.description+'\n    </div>\n    <div class="span2">\n        <button class="btn load-squad">Load</button>\n    </div>\n</div>')),i.find("button.load-squad").click(function(a){var e;return a.preventDefault(),e=$(a.target),i=e.closest("li"),t=i.data("builder"),s.squad_list_modal.modal("hide"),t.current_squad.dirty?s.warnUnsaved(t,function(){return t.container.trigger("xwing-backend:squadLoadRequested",i.data("squad"))}):t.container.trigger("xwing-backend:squadLoadRequested",i.data("squad"))});return n.fadeOut("fast"),e.fadeIn("fast")})},t.prototype.authenticate=function(t){var a,e=this;return null==t&&(t=$.noop),a=this.authenticated,$.ajax({url:""+this.server+"/ping",success:function(n){return e.authenticated=(null!=n?n.success:void 0)?!0:!1,e.maybeAuthenticationChanged(a,t)},error:function(){return e.authenticated=!1,e.maybeAuthenticationChanged(a,t)}})},t.prototype.maybeAuthenticationChanged=function(t,a){return t!==this.authenticated&&$(window).trigger("xwing-backend:authenticationChanged",this.authenticated),this.oauth_window=null,a(this.authenticated),this.authenticated},t.prototype.login=function(){return this.ui_ready?this.login_modal.modal("show"):void 0},t.prototype.logout=function(t){var a=this;return null==t&&(t=$.noop),$.get(""+this.server+"/auth/logout",function(){return a.authenticated=!1,$(window).trigger("xwing-backend:authenticationChanged",a.authenticated),t()})},t.prototype.showSaveAsModal=function(t){return this.save_as_modal.data("builder",t),this.save_as_input.val(t.current_squad.name),this.save_as_save_button.addClass("disabled"),this.nameCheck(),this.save_as_modal.modal("show")},t.prototype.showDeleteModal=function(t){return this.delete_modal.data("builder",t),this.delete_name_container.text(t.current_squad.name),this.delete_modal.modal("show")},t.prototype.nameCheck=function(){var t,a=this;return window.clearInterval(this.save_as_modal.data("timer")),t=$.trim(this.save_as_input.val()),0===t.length?(this.name_availability_container.text(""),this.name_availability_container.append($.trim('<i class="icon-thumbs-down"> A name is required'))):$.post(""+this.server+"/squads/namecheck",{name:t},function(t){return a.name_availability_container.text(""),t.available?(a.name_availability_container.append($.trim('<i class="icon-thumbs-up"> Name is available')),a.save_as_save_button.removeClass("disabled")):(a.name_availability_container.append($.trim('<i class="icon-thumbs-down"> You already have a squad with that name')),a.save_as_save_button.addClass("disabled"))})},t.prototype.warnUnsaved=function(t,a){return this.unsaved_modal.data("builder",t),this.unsaved_modal.data("callback",a),this.unsaved_modal.modal("show")},t.prototype.setupUI=function(){var t,a=this;return this.login_modal=$(document.createElement("DIV")),this.login_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.login_modal),this.login_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Log in with OAuth</h3>\n</div>\n<div class="modal-body">\n    <p>\n        Select one of the OAuth providers below to log in and start saving squads.\n        <a class="login-help" href="#">What\'s this?</a>\n    </p>\n    <div class="well well-small oauth-explanation">\n        <p>\n            <a href="http://en.wikipedia.org/wiki/OAuth" target="_blank">OAuth</a> is an authorization system which lets you prove your identity at a web site without having to create a new account.  Instead, you tell some provider with whom you already have an account (e.g. Google or Facebook) to prove to this web site that you say who you are.  That way, the next time you visit, this site remembers that you\'re that user from Google.\n        </p>\n        <p>\n            The best part about this is that you don\'t have to come up with a new username and password to remember.  And don\'t worry, I\'m not collecting any data from the providers about you.  I\'ve tried to set the scope of data to be as small as possible, but some places send a bunch of data at minimum.  I throw it away.  All I look at is a unique identifier (usually some giant number).\n        </p>\n        <p>\n            For more information, check out this <a href="http://hueniverse.com/oauth/guide/intro/" target="_blank">introduction to OAuth</a>.\n        </p>\n        <button class="btn">Got it!</button>\n    </div>\n    <ul class="login-providers inline"></ul>\n    <p>\n        This will open a new window to let you authenticate with the chosen provider.  You may have to allow pop ups for this site.  (Sorry.)\n    </p>\n    <p class="login-in-progress">\n        <em>OAuth login is in progress.  Please finish authorization at the specified provider using the window that was just created.</em>\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),t=$(this.login_modal.find(".oauth-explanation")),t.hide(),this.login_modal.find(".login-in-progress").hide(),this.login_modal.find("a.login-help").click(function(a){return a.preventDefault(),t.is(":visible")?void 0:t.slideDown("fast")}),t.find("button").click(function(a){return a.preventDefault(),t.slideUp("fast")}),$.get(""+this.server+"/methods",function(t){var e,n,i,s,d,o,l;for(s=$(a.login_modal.find("ul.login-providers")),l=t.methods,d=0,o=l.length;o>d;d++)i=l[d],e=$(document.createElement("A")),e.addClass("btn btn-inverse"),e.data("url",""+a.server+"/auth/"+i),e.append('<i class="'+a.method_metadata[i].icon+'"></i>&nbsp;'+a.method_metadata[i].text),e.click(function(t){return t.preventDefault(),s.slideUp("fast"),a.login_modal.find(".login-in-progress").slideDown("fast"),a.oauth_window=window.open($(t.target).data("url"),"xwing_login")}),n=$(document.createElement("LI")),n.append(e),s.append(n);return a.ui_ready=!0}),this.squad_list_modal=$(document.createElement("DIV")),this.squad_list_modal.addClass("modal hide fade hide-on-print squad-list"),$(document.body).append(this.squad_list_modal),this.squad_list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3></h3>\n</div>\n<div class="modal-body">\n    <ul class="squad-list"></ul>\n    <p class="pagination-centered squad-list-loading">\n        <i class="icon-spinner icon-spin icon-3x"></i>\n        <br />\n        Fetching squads...\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.squad_list_modal.find("ul.squad-list").hide(),this.save_as_modal=$(document.createElement("DIV")),this.save_as_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.save_as_modal),this.save_as_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Save Squad As...</h3>\n</div>\n<div class="modal-body">\n    <label for="xw-be-squad-save-as">\n        New Squad Name\n        <input id="xw-be-squad-save-as"></input>\n    </label>\n    <span class="name-availability"></span>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary save" aria-hidden="true">Save</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.save_as_modal.on("shown",function(){return window.setTimeout(function(){return a.save_as_input.focus(),a.save_as_input.select()},100)}),this.save_as_save_button=this.save_as_modal.find("button.save"),this.save_as_save_button.click(function(t){var e,n,i,s;return t.preventDefault(),a.save_as_save_button.hasClass("disabled")?void 0:(s=a.save_as_modal.data("timer"),null!=s&&window.clearInterval(s),a.save_as_modal.modal("hide"),n=a.save_as_modal.data("builder"),e={points:n.total_points,description:n.describeSquad(),cards:n.listCards()},n.backend_save_list_as_button.addClass("disabled"),n.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Saving squad...')),n.backend_status.show(),i=$.trim(a.save_as_input.val()),a.save(n.serialize(),null,i,n.faction,e,function(t){return t.success?(n.current_squad.id=t.id,n.current_squad.name=i,n.current_squad.dirty=!1,n.container.trigger("xwing-backend:squadDirtinessChanged"),n.container.trigger("xwing-backend:squadNameChanged"),n.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;New squad saved successfully.'))):n.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+t.error)),n.backend_save_list_as_button.removeClass("disabled")}))}),this.save_as_input=$(this.save_as_modal.find("input")),this.save_as_input.keypress(function(t){var e;return 13===t.which?(a.save_as_save_button.click(),!1):(a.name_availability_container.text(""),a.name_availability_container.append($.trim('<i class="icon-spin icon-spinner"></i> Checking name availability...')),e=a.save_as_modal.data("timer"),null!=e&&window.clearInterval(e),a.save_as_modal.data("timer",window.setInterval(a.nameCheck,500)))}),this.name_availability_container=$(this.save_as_modal.find(".name-availability")),this.delete_modal=$(document.createElement("DIV")),this.delete_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.delete_modal),this.delete_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Really Delete <span class="squad-name-placeholder"></span>?</h3>\n</div>\n<div class="modal-body">\n    <p>Are you sure you want to delete this squad?</p>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-danger delete" aria-hidden="true">Yes, Delete <i class="squad-name-placeholder"></i></button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Never Mind</button>\n</div>')),this.delete_name_container=$(this.delete_modal.find(".squad-name-placeholder")),this.delete_button=$(this.delete_modal.find("button.delete")),this.delete_button.click(function(t){var e;return t.preventDefault(),e=a.delete_modal.data("builder"),e.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Deleting squad...')),e.backend_status.show(),e.backend_delete_list_button.addClass("disabled"),a.delete_modal.modal("hide"),a["delete"](e.current_squad.id,function(t){return t.success?(e.resetCurrentSquad(),e.current_squad.dirty=!0,e.container.trigger("xwing-backend:squadDirtinessChanged"),e.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;Squad deleted.'))):(e.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+t.error)),e.backend_delete_list_button.removeClass("disabled"))})}),this.unsaved_modal=$(document.createElement("DIV")),this.unsaved_modal.addClass("modal hide fade hide-on-print"),$(document.body).append(this.unsaved_modal),this.unsaved_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Unsaved Changes</h3>\n</div>\n<div class="modal-body">\n    <p>You have not saved changes to this squad.  Do you want to go back and save?</p>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary" aria-hidden="true" data-dismiss="modal">Go Back</button>\n    <button class="btn btn-danger discard" aria-hidden="true">Discard Changes</button>\n</div>')),this.unsaved_discard_button=$(this.unsaved_modal.find("button.discard")),this.unsaved_discard_button.click(function(t){return t.preventDefault(),a.unsaved_modal.data("builder").current_squad.dirty=!1,a.unsaved_modal.data("callback")(),a.unsaved_modal.modal("hide")})},t.prototype.setupHandlers=function(){var t=this;return $(window).on("xwing-backend:authenticationChanged",function(){return t.updateAuthenticationVisibility()}),this.login_logout_button.click(function(a){return a.preventDefault(),t.authenticated?t.logout():t.login()}),$(window).on("message",function(a){var e,n,i;if(e=a.originalEvent,e.origin!==t.server)return console.log("Message received from unapproved origin "+e.origin),window.last_ev=a;switch(null!=(n=e.data)?n.command:void 0){case"auth_successful":return t.authenticate(),t.login_modal.modal("hide"),t.login_modal.find(".login-in-progress").hide(),t.login_modal.find("ul.login-providers").show(),e.source.close();default:return console.log("Unexpected command "+(null!=(i=e.data)?i.command:void 0))}})},t}()}).call(this);