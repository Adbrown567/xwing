(function(){var e,t=[].slice;window.iced={Deferrals:function(){function e(e){this.continuation=e,this.count=1,this.ret=null}return e.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},e.prototype.defer=function(e){var n=this;return++this.count,function(){var i,o;return i=arguments.length>=1?t.call(arguments,0):[],null!=e&&null!=(o=e.assign_fn)&&o.apply(null,i),n._fulfill()}},e}(),findDeferral:function(){return null},trampoline:function(e){return e()}},window.__iced_k=window.__iced_k_noop=function(){},e="undefined"!=typeof exports&&null!==exports?exports:this,e.SquadBuilderBackend=function(){function e(e){var t,n,i,o;for(this.server=e.server,this.builders=e.builders,this.authenticated=!1,this.ui_ready=!1,this.oauth_window=null,this.method_metadata={google_oauth2:{icon:"icon-google-plus-sign",text:"Google"},facebook:{icon:"icon-facebook-sign",text:"Facebook"}},o=this.builders,n=0,i=o.length;i>n;n++)t=o[n],t.setBackend(this);this.setupHandlers(),this.setupUI(),$.ajaxSetup({xhrFields:{withCredentials:!0}})}return e.prototype.save=function(e,t,n,i,o,r){var a,u;return null==t&&(t=null),null==o&&(o={}),a={name:$.trim(n),faction:$.trim(i),additional_data:o},null!=t?u=""+this.server+"/"+t:(u=""+this.server+"/new",a._method="put"),$.post(a,function(e){return r({id:e.id,success:e.success,error:e.error})})},e.prototype["delete"]=function(e,t){var n;return n={_method:"delete"},$.post(""+this.server+"/"+e,n,function(e){return t({success:e.success,error:e.error})})},e.prototype.list=function(){var e,t,n,i,o=this;i=__iced_k_noop,t=iced.findDeferral(arguments),function(i){n=new iced.Deferrals(i,{parent:t,funcname:"SquadBuilderBackend.list"}),$.get(""+o.server+"/squads/list",n.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:74})),n._fulfill()}(function(){return e})},e.prototype.listAll=function(){var e,t,n,i,o=this;i=__iced_k_noop,t=iced.findDeferral(arguments),function(i){n=new iced.Deferrals(i,{parent:t,funcname:"SquadBuilderBackend.listAll"}),$.get(""+o.server+"/all",n.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:78})),n._fulfill()}(function(){return e})},e.prototype.authenticate=function(e){var t,n,i,o,r=this;o=__iced_k_noop,n=iced.findDeferral(arguments),function(e){i=new iced.Deferrals(e,{parent:n,funcname:"SquadBuilderBackend.authenticate"}),$.get(""+r.server+"/ping",i.defer({assign_fn:function(){return function(){return t=arguments[0]}}(),lineno:82})),i._fulfill()}(function(){return(t!==void 0&&null!==t?t.success:void 0)?(e(),r.authenticated=!0):r.authenticated=!1,r.oauth_window=null,r.authenticated})},e.prototype.login=function(){return this.ui_ready?null:void 0},e.prototype.logout=function(e){var t=this;return $.get(""+this.server+"/auth/logout",function(){return t.authenticated=!1,e()})},e.prototype.setupUI=function(){var e=this;return this.login_modal=$(document.createElement("DIV")),this.login_modal.addClass("modal hide fade"),$(document.body).append(this.login_modal),this.login_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Log in with OAuth</h3>\n</div>\n<div class="modal-body">\n    <p>\n        Select one of the OAuth providers below to log in and start saving squads.\n        <a class="login-help" href="#">What\'s this?</a>\n    </p>\n    <ul class="login-providers inline"></ul>\n    <p>\n        This will cause a new window to pop up and authenticate with the chosen provider.  You may have to allow pop ups just this time.  (Sorry.)\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),$.get(""+this.server+"/methods",function(t){var n,i,o,r,a,u,s;for(r=$(e.login_modal.find("ul.login-providers")),s=t.methods,a=0,u=s.length;u>a;a++)o=s[a],n=$(document.createElement("A")),n.addClass("btn btn-inverse"),n.data("url",""+e.server+"/auth/"+o),n.append('<i class="'+e.method_metadata[o].icon+'"></i>&nbsp;'+e.method_metadata[o].text),n.click(function(t){return t.preventDefault(),e.oauth_window=window.open($(t.target).data("url"),"xwing_login")}),i=$(document.createElement("LI")),i.append(n),r.append(i);return e.ui_ready=!0})},e.prototype.setupHandlers=function(){var e=this;return $(window).on("message",function(t){var n,i,o;if(n=t.originalEvent,n.origin!==e.server)return console.log("Message received from unapproved origin "+n.origin),window.last_ev=t;switch(null!=(i=n.data)?i.command:void 0){case"close_this":return n.source.close();default:return console.log("Unexpected command "+(null!=(o=n.data)?o.command:void 0))}})},e}()}).call(this);