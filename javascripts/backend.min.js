(function(){var t,n=[].slice;window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var e=this;return++this.count,function(){var i,o;return i=arguments.length>=1?n.call(arguments,0):[],null!=t&&null!=(o=t.assign_fn)&&o.apply(null,i),e._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},t="undefined"!=typeof exports&&null!==exports?exports:this,t.SquadBuilderBackend=function(){function t(t){var n,e,i,o;for(this.server=t.server,this.builders=t.builders,this.authenticated=!1,this.ui_ready=!1,this.oauth_window=null,this.method_metadata={google_oauth2:{icon:"icon-google-plus-sign",text:"Google"},facebook:{icon:"icon-facebook-sign",text:"Facebook"}},this.setupHandlers(),this.setupUI(),$.ajaxSetup({xhrFields:{withCredentials:!0}}),this.authenticate($.noop),o=this.builders,e=0,i=o.length;i>e;e++)n=o[e],n.setBackend(this)}return t.prototype.save=function(t,n,e,i,o,r){var a,u;return null==n&&(n=null),null==o&&(o={}),a={name:$.trim(e),faction:$.trim(i),additional_data:o},null!=n?u=""+this.server+"/"+n:(u=""+this.server+"/new",a._method="put"),$.post(a,function(t){return r({id:t.id,success:t.success,error:t.error})})},t.prototype["delete"]=function(t,n){var e;return e={_method:"delete"},$.post(""+this.server+"/"+t,e,function(t){return n({success:t.success,error:t.error})})},t.prototype.list=function(){var t,n,e,i,o=this;i=__iced_k_noop,n=iced.findDeferral(arguments),function(i){e=new iced.Deferrals(i,{parent:n,funcname:"SquadBuilderBackend.list"}),$.get(""+o.server+"/squads/list",e.defer({assign_fn:function(){return function(){return t=arguments[0]}}(),lineno:78})),e._fulfill()}(function(){return t})},t.prototype.listAll=function(){var t,n,e,i,o=this;i=__iced_k_noop,n=iced.findDeferral(arguments),function(i){e=new iced.Deferrals(i,{parent:n,funcname:"SquadBuilderBackend.listAll"}),$.get(""+o.server+"/all",e.defer({assign_fn:function(){return function(){return t=arguments[0]}}(),lineno:82})),e._fulfill()}(function(){return t})},t.prototype.authenticate=function(t){var n,e,i,o,r,a=this;r=__iced_k_noop,i=iced.findDeferral(arguments),null==t&&(t=$.noop),e=this.authenticated,function(t){o=new iced.Deferrals(t,{parent:i,funcname:"SquadBuilderBackend.authenticate"}),$.get(""+a.server+"/ping",o.defer({assign_fn:function(){return function(){return n=arguments[0]}}(),lineno:87})),o._fulfill()}(function(){return(n!==void 0&&null!==n?n.success:void 0)?(a.authenticated=!0,t()):a.authenticated=!1,e!==a.authenticated&&$(window).trigger("xwing-backend:authenticationChanged",a.authenticated),a.oauth_window=null,a.authenticated})},t.prototype.login=function(){return this.ui_ready?this.login_modal.modal("show"):void 0},t.prototype.logout=function(t){var n=this;return null==t&&(t=$.noop),$.get(""+this.server+"/auth/logout",function(){return n.authenticated=!1,$(window).trigger("xwing-backend:authenticationChanged",n.authenticated),t()})},t.prototype.setupUI=function(){var t=this;return this.login_modal=$(document.createElement("DIV")),this.login_modal.addClass("modal hide fade"),$(document.body).append(this.login_modal),this.login_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Log in with OAuth</h3>\n</div>\n<div class="modal-body">\n    <p>\n        Select one of the OAuth providers below to log in and start saving squads.\n        <a class="login-help" href="#">What\'s this?</a>\n    </p>\n    <ul class="login-providers inline"></ul>\n    <p>\n        This will cause a new window to pop up and authenticate with the chosen provider.  You may have to allow pop ups just this time.  (Sorry.)\n    </p>\n</div>\n<div class="modal-footer">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),$.get(""+this.server+"/methods",function(n){var e,i,o,r,a,u,s;for(r=$(t.login_modal.find("ul.login-providers")),s=n.methods,a=0,u=s.length;u>a;a++)o=s[a],e=$(document.createElement("A")),e.addClass("btn btn-inverse"),e.data("url",""+t.server+"/auth/"+o),e.append('<i class="'+t.method_metadata[o].icon+'"></i>&nbsp;'+t.method_metadata[o].text),e.click(function(n){return n.preventDefault(),t.oauth_window=window.open($(n.target).data("url"),"xwing_login")}),i=$(document.createElement("LI")),i.append(e),r.append(i);return t.ui_ready=!0})},t.prototype.setupHandlers=function(){var t=this;return $(window).on("message",function(n){var e,i,o;if(e=n.originalEvent,e.origin!==t.server)return console.log("Message received from unapproved origin "+e.origin),window.last_ev=n;switch(null!=(i=e.data)?i.command:void 0){case"auth_successful":return t.authenticate($.noop),t.login_modal.modal("hide"),e.source.close();default:return console.log("Unexpected command "+(null!=(o=e.data)?o.command:void 0))}})},t}()}).call(this);