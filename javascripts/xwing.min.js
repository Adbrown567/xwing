(function(){var t,i,e,n,s,o,a=[].slice,r=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1},l=function(t,i){return function(){return t.apply(i,arguments)}},c={}.hasOwnProperty,u=function(t,i){function e(){this.constructor=t}for(var n in i)c.call(i,n)&&(t[n]=i[n]);return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var i=this;return++this.count,function(){var e,n;return e=arguments.length>=1?a.call(arguments,0):[],null!=t&&null!=(n=t.assign_fn)&&n.apply(null,e),i._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},o="undefined"!=typeof exports&&null!==exports?exports:this,o.sortHelper=function(t,i){var e,n;return t.points===i.points?(e=t.text.replace(/[^a-z0-9]/gi,""),n=i.text.replace(/[^a-z0-9]/gi,""),e===n?0:e>n?1:-1):t.points>i.points?1:-1},$.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)},$.randomInt=function(t){return Math.floor(Math.random()*t)},$.getParameterByName=function(t){var i,e,n;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e="[\\?&]"+t+"=([^&#]*)",i=RegExp(e),n=i.exec(window.location.search),null===n?"":decodeURIComponent(n[1].replace(/\+/g," "))},Array.prototype.intersects=function(t){var i,e,n;for(e=0,n=this.length;n>e;e++)if(i=this[e],r.call(t,i)>=0)return!0;return!1},o.SquadBuilder=function(){function i(t){this._makeRandomizerLoopFunc=l(this._makeRandomizerLoopFunc,this),this._randomizerLoopBody=l(this._randomizerLoopBody,this),this.releaseUnique=l(this.releaseUnique,this),this.claimUnique=l(this.claimUnique,this),this.onPointsUpdated=l(this.onPointsUpdated,this),this.container=$(t.container),this.faction=$.trim(t.faction),this.printable_container=$(t.printable_container),this.ships=[],this.uniques_in_use={Pilot:[],Upgrade:[],Modification:[],Title:[]},this.suppress_automatic_new_ship=!1,this.tooltip_currently_displaying=null,this.randomizer_options={sources:null,points:100},this.setupUI(),this.setupEventHandlers(),$.getParameterByName("f")===this.faction?this.loadFromSerialized($.getParameterByName("d")):this.addShip()}return i.prototype.setupUI=function(){var t,i,e,n,s,a,r,l,c,u=this;for(i=100,e=2,t=1e3,this.status_container=$(document.createElement("DIV")),this.status_container.addClass("container-fluid"),this.status_container.append($.trim('<div class="span4 points-display-container">Total Points: 0</div>\n<div class="span8 pull-right button-container">\n    <div class="btn-group pull-right">\n        <button class="btn btn-info view-as-text">View as Text</button>\n        <button class="btn btn-info print-list">Print List</button>\n        <a class="btn btn-info permalink">Permalink</a>\n\n        <button class="btn btn-info randomize">Random Squad!</button>\n        <button class="btn btn-info dropdown-toggle" data-toggle="dropdown">\n            <span class="caret"></span>\n        </button>\n        <ul class="dropdown-menu">\n            <li><a class="randomize-options">Randomizer Options...</a></li>\n        <ul>\n    </div>\n</div>')),this.container.append(this.status_container),this.points_container=$(this.status_container.find("div.points-display-container")),this.permalink=$(this.status_container.find("div.button-container a.permalink")),this.view_list_button=$(this.status_container.find("div.button-container button.view-as-text")),this.print_list_button=$(this.status_container.find("div.button-container button.print-list")),this.randomize_button=$(this.status_container.find("div.button-container button.randomize")),this.customize_randomizer=$(this.status_container.find("div.button-container a.randomize-options")),this.randomizer_options_modal=$(document.createElement("DIV")),this.randomizer_options_modal.addClass("modal hide fade"),$(document).append(this.randomizer_options_modal),this.randomizer_options_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Random Squad Builder Options</h3>\n</div>\n<div class="modal-body">\n    <form>\n        <label>\n            Desired Points\n            <input type="number" class="randomizer-points" value="'+i+'" placeholder="'+i+'" />\n        </label>\n        <label>\n            Sets and Expansions (default all)\n            <select class="randomizer-sources" multiple="1" data-placeholder="Use all sets and expansions">\n            </select>\n        </label>\n        <label>\n            Maximum Seconds to Spend Randomizing\n            <input type="number" class="randomizer-timeout" value="'+e+'" placeholder="'+e+'" />\n        </label>\n        <label>\n            Maximum Randomization Iterations\n            <input type="number" class="randomizer-iterations" value="'+t+'" placeholder="'+t+'" />\n        </label>\n    </form>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary do-randomize" aria-hidden="true">Randomize!</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.randomizer_source_selector=$(this.randomizer_options_modal.find("select.randomizer-sources")),c=o.expansions,r=0,l=c.length;l>r;r++)s=c[r],a=$(document.createElement("OPTION")),a.text(s),this.randomizer_source_selector.append(a);return this.randomizer_source_selector.select2({width:"100%"}),this.randomize_button.click(function(n){var s,o,a;return n.preventDefault(),o=parseInt($(u.randomizer_options_modal.find(".randomizer-points")).val()),(isNaN(o)||0>=o)&&(o=i),a=parseInt($(u.randomizer_options_modal.find(".randomizer-timeout")).val()),(isNaN(a)||0>=a)&&(a=e),s=parseInt($(u.randomizer_options_modal.find(".randomizer-iterations")).val()),(isNaN(s)||0>=s)&&(s=t),u.randomSquad(o,u.randomizer_source_selector.val(),1e3*e,s)}),this.randomizer_options_modal.find("button.do-randomize").click(function(t){return t.preventDefault(),u.randomizer_options_modal.modal("hide"),u.randomize_button.click()}),this.customize_randomizer.click(function(t){return t.preventDefault(),u.randomizer_options_modal.modal()}),n=$(document.createElement("DIV")),n.addClass("container-fluid"),this.container.append(n),n.append($.trim('<div class="row-fluid">\n    <div class="span9 ship-container" />\n    <div class="span3 hidden-phone info-container" />\n</div>')),this.ship_container=$(n.find("div.ship-container")),this.info_container=$(n.find("div.info-container")),this.info_container.append($.trim('<div class="well info-well">\n    <span class="info-name"></span>\n    <table>\n        <tbody>\n            <tr class="info-ship">\n                <td>Ship</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-skill">\n                <td>Skill</td>\n                <td class="info-data info-skill"></td>\n            </tr>\n            <tr class="info-attack">\n                <td><img class="icon-attack" src="images/transparent.png" alt="Attack" /></td>\n                <td class="info-data info-attack"></td>\n            </tr>\n            <tr class="info-range">\n                <td>Range</td>\n                <td class="info-data info-range"></td>\n            </tr>\n            <tr class="info-agility">\n                <td><img class="icon-agility" src="images/transparent.png" alt="Agility" /></td>\n                <td class="info-data info-agility"></td>\n            </tr>\n            <tr class="info-hull">\n                <td><img class="icon-hull" src="images/transparent.png" alt="Hull" /></td>\n                <td class="info-data info-hull"></td>\n            </tr>\n            <tr class="info-shields">\n                <td><img class="icon-shields" src="images/transparent.png" alt="Shields" /></td>\n                <td class="info-data info-shields"></td>\n            </tr>\n            <tr class="info-actions">\n                <td>Actions</td>\n                <td class="info-data"></td>\n            </tr>\n        </tbody>\n    </table>\n    <p class="info-text" />\n</div>')),this.info_container.hide(),this.list_modal=$(document.createElement("DIV")),this.list_modal.addClass("modal hide fade text-list-modal"),$(document).append(this.list_modal),this.list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close hide-on-print" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>'+this.faction+': <span class="total-points">0</span> Points </h3>\n</div>\n<div class="modal-body">\n    <ul></ul>\n</div>\n<div class="modal-footer hide-on-print">\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.text_ul=$(this.list_modal.find("div.modal-body ul")),this.text_total_points_container=$(this.list_modal.find("div.modal-header span.total-points"))},i.prototype.setupEventHandlers=function(){var t=this;return this.container.on("xwing:claimUnique",function(i,e,n,s){return t.claimUnique(e,n,s)}).on("xwing:releaseUnique",function(i,e,n,s){return t.releaseUnique(e,n,s)}).on("xwing:pointsUpdated",function(i,e){return null==e&&(e=$.noop),t.onPointsUpdated(e)}),this.view_list_button.click(function(i){return i.preventDefault(),t.showTextListModal()}),this.print_list_button.click(function(i){return i.preventDefault(),t.printable_container.html(t.list_modal.html()),window.print()})},i.prototype.onPointsUpdated=function(t){var i,e,n,s,o,a,r,l,c,u,d,p,h,f,m,g;for(this.total_points=0,p=this.ships,e=a=0,c=p.length;c>a;e=++a)n=p[e],this.total_points+=n.getPoints();for(this.points_container.text("Total Points: "+this.total_points),this.text_total_points_container.text(this.total_points),this.permalink.attr("href",""+window.location.href.split("?")[0]+"?f="+encodeURI(this.faction)+"&d="+encodeURI(this.serialize())),this.text_ul.text(""),h=this.ships,r=0,u=h.length;u>r;r++)if(n=h[r],null!=n.pilot){if(n.getPoints()!==n.pilot.points){for(i="<ul>",null!=(null!=(f=n.title)?f.data:void 0)&&(i+="<li>"+(""+n.title)+"</li>"),m=n.upgrades,l=0,d=m.length;d>l;l++)o=m[l],null!=o.data&&(i+="<li>"+(""+o)+"</li>");null!=(null!=(g=n.modification)?g.data:void 0)&&(i+="<li>"+(""+n.modification)+"</li>"),i+="</ul>",s="Total: "+n.getPoints()}else s="",i="";this.text_ul.append($.trim('<li>\n    <span class="info-name">'+n.pilot.name+" ("+n.pilot.points+")</span>\n    <br />\n    "+i+"\n    <em>"+s+"</em>\n</li>"))}return t(this.total_points)},i.prototype.showTextListModal=function(){return this.list_modal.modal("show")},i.prototype.serialize=function(){var t,i,e,n;return function(){var s,o,a,r,l,c,u,d,p,h;for(a=this.ships,h=[],s=0,o=a.length;o>s;s++)i=a[s],null!=i.pilot&&h.push(""+i.pilot.id+":"+function(){var n,s,o,a,r,l;for(o=i.pilot.slots,l=[],t=n=0,s=o.length;s>n;t=++n)e=o[t],l.push(null!=(a=null!=(r=i.upgrades[t].data)?r.id:void 0)?a:-1);return l}()+":"+(null!=(r=null!=(l=i.title)?null!=(c=l.data)?c.id:void 0:void 0)?r:-1)+":"+function(){var t,e,s,o,a,r,l,c;for(a=null!=(s=null!=(o=i.title)?o.conferredUpgrades:void 0)?s:[],c=[],t=0,e=a.length;e>t;t++)n=a[t],c.push(null!=(r=null!=(l=n.data)?l.id:void 0)?r:-1);return c}()+":"+(null!=(u=null!=(d=i.modification)?null!=(p=d.data)?p.id:void 0:void 0)?u:-1));return h}.call(this).join(";")},i.prototype.loadFromSerialized=function(t){var i,e,n,s,o,a,r,l,c,u,d,p,h,f,m,g,y,k,v;for(this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";for(g=t.split(";"),u=0,h=g.length;h>u;u++){for(o=g[u],y=o.split(":"),s=y[0],c=y[1],r=y[2],a=y[3],e=y[4],n=this.addShip(),n.setPilotById(parseInt(s)),k=c.split(","),i=d=0,f=k.length;f>d;i=++d)l=k[i],l=parseInt(l),l>=0&&n.upgrades[i].setById(l);if(r=parseInt(r),r>=0&&n.title.setById(r),null!=n.title&&n.title.conferredUpgrades.length>0)for(v=a.split(","),i=p=0,m=v.length;m>p;i=++p)l=v[i],l=parseInt(l),l>=0&&n.title.conferredUpgrades[i].setById(l);e=parseInt(e),e>=0&&n.modification.setById(e),n.updateSelections()}return this.suppress_automatic_new_ship=!1,this.addShip()},i.prototype.uniqueIndex=function(t,i){if(!(i in this.uniques_in_use))throw"Invalid unique type '"+i+"'";return this.uniques_in_use[i].indexOf(t)},i.prototype.claimUnique=function(t,i,e){var n,s;if(!(0>this.uniqueIndex(t,i)))throw"Unique "+i+" '"+t.name+"' already claimed";if("Pilot"===i){if(n=o.upgrades[t.name],null!=n&&null!=(null!=n?n.unique:void 0)){if(!(0>this.uniqueIndex(n,"Upgrade")))throw"Unique "+i+" '"+t.name+"' already claimed as crew";this.uniques_in_use.Upgrade.push(n)}}else if("Upgrade"===i&&"Crew"===t.slot&&(s=o.pilots[t.name],null!=s&&null!=(null!=s?s.unique:void 0))){if(!(0>this.uniqueIndex(s,"Pilot")))throw"Unique "+i+" '"+t.name+"' already claimed as pilot";this.uniques_in_use.Pilot.push(s)}return this.uniques_in_use[i].push(t),e()},i.prototype.releaseUnique=function(t,i,e){var n,s,a;if(s=this.uniqueIndex(t,i),!(s>=0))throw"Unique "+i+" '"+t.name+"' not in use";if(this.uniques_in_use[i].splice(s,1),"Pilot"===i){if(n=o.upgrades[t.name],null!=n&&null!=(null!=n?n.unique:void 0)){if(s=this.uniqueIndex(n,"Upgrade"),0>s)throw"Unique crew accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Upgrade.splice(s,1)}}else if("Upgrade"===i&&"Crew"===t.slot&&(a=o.pilots[t.name],null!=a&&null!=(null!=a?a.unique:void 0))){if(s=this.uniqueIndex(a,"Pilot"),0>s)throw"Unique pilot accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Pilot.splice(s,1)}return e()},i.prototype.addShip=function(){var t;return t=new e({builder:this,container:this.ship_container}),this.ships.push(t),t},i.prototype.removeShip=function(t){var i,e,n,s=this;n=__iced_k_noop,i=iced.findDeferral(arguments),function(n){e=new iced.Deferrals(n,{parent:i,funcname:"SquadBuilder.removeShip"}),t.destroy(e.defer({lineno:401})),e._fulfill()}(function(){e=new iced.Deferrals(n,{parent:i,funcname:"SquadBuilder.removeShip"}),s.container.trigger("xwing:pointsUpdated",e.defer({lineno:402})),e._fulfill()})},i.prototype.matcher=function(t,i){return t.toUpperCase().indexOf(i.toUpperCase())>=0},i.prototype.getAvailablePilotsIncluding=function(t,i){var e,n,s,a,l,c,u,d,p,h,f,m,g;for(null==i&&(i=""),u=function(){var t,s;t=o.pilots,s=[];for(n in t)e=t[n],o.ships[e.ship].faction===this.faction&&this.matcher(n,i)&&(null==e.unique||0>r.call(this.uniques_in_use.Pilot,e))&&s.push(e);return s}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,i)&&u.push(t),a={},m=function(){var t,i,n;for(n=[],t=0,i=u.length;i>t;t++)e=u[t],n.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points,ship:e.ship});return n}(),d=0,h=m.length;h>d;d++)s=m[d],s.ship in a||(a[s.ship]=[]),a[s.ship].push(s);for(l=[],g=Object.keys(a).sort(),p=0,f=g.length;f>p;p++)c=g[p],l.push({text:c,children:a[c].sort(o.sortHelper)});return l},i.prototype.getAvailableUpgradesIncluding=function(t,i,e){var n,s,a;return null==e&&(e=""),n=function(){var i,n;i=o.upgrades,n=[];for(a in i)s=i[a],s.slot===t&&this.matcher(a,e)&&(null==s.unique||0>r.call(this.uniques_in_use.Upgrade,s))&&(null==s.faction||s.faction===this.faction)&&n.push(s);return n}.call(this),null!=i&&null!=i.unique&&this.matcher(i.name,e)&&n.push(i),function(){var t,i,e;for(e=[],t=0,i=n.length;i>t;t++)s=n[t],e.push({id:s.id,text:""+s.name+" ("+s.points+")",points:s.points});return e}().sort(o.sortHelper)},i.prototype.getAvailableModificationsIncluding=function(t,i){var e,n,s;return null==i&&(i=""),s=function(){var t,s;t=o.modifications,s=[];for(n in t)e=t[n],this.matcher(n,i)&&(null==e.unique||0>r.call(this.uniques_in_use.Modification,e))&&(null==e.faction||e.faction===this.faction)&&s.push(e);return s}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,i)&&s.push(t),function(){var t,i,n;for(n=[],t=0,i=s.length;i>t;t++)e=s[t],n.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points});return n}().sort(o.sortHelper)},i.prototype.getAvailableTitlesIncluding=function(t,i,e){var n,s,a;return null==e&&(e=""),a=function(){var i,a;i=o.titles,a=[];for(s in i)n=i[s],n.ship===t&&this.matcher(s,e)&&0>r.call(this.uniques_in_use.Title,n)&&(null==n.faction||n.faction===this.faction)&&a.push(n);return a}.call(this),null!=i&&this.matcher(i.name,e)&&a.push(i),function(){var t,i,e;for(e=[],t=0,i=a.length;i>t;t++)n=a[t],e.push({id:n.id,text:""+n.name+" ("+n.points+")",points:n.points});return e}().sort(o.sortHelper)},i.prototype.showTooltip=function(t,i){var e;if(i!==this.tooltip_currently_displaying){switch(this.info_container.find(".info-name").text(i.name),this.info_container.find("p.info-text").html(null!=(e=i.text)?e:""),t){case"Pilot":this.info_container.find("tr.info-ship td.info-data").text(i.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(i.skill),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(o.ships[i.ship].attack),this.info_container.find("tr.info-attack").show(),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(o.ships[i.ship].agility),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(o.ships[i.ship].hull),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(o.ships[i.ship].shields),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").text(o.ships[i.ship].actions.join(", ")),this.info_container.find("tr.info-actions").show();break;case"Addon":this.info_container.find("tr.info-ship").hide(),this.info_container.find("tr.info-skill").hide(),null!=i.attack?(this.info_container.find("tr.info-attack td.info-data").text(i.attack),this.info_container.find("tr.info-attack").show()):this.info_container.find("tr.info-attack").hide(),null!=i.range?(this.info_container.find("tr.info-range td.info-data").text(i.range),this.info_container.find("tr.info-range").show()):this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility").hide(),this.info_container.find("tr.info-hull").hide(),this.info_container.find("tr.info-shields").hide(),this.info_container.find("tr.info-actions").hide()}return this.info_container.show(),this.tooltip_currently_displaying=i}},i.prototype._randomizerLoopBody=function(i){var n,s,a,r,l,c,u,d,p,h,f,m,g,y,k,v,_,x,b,E,I,w,P,T,S,q,A,C,B,W,D,U,M;if(i.keep_running&&i.iterations<i.max_iterations){if(i.iterations++,this.total_points===i.max_points)i.keep_running=!1;else if(this.total_points<i.max_points){for(k=[],A=this.ships,_=0,I=A.length;I>_;_++){for(f=A[_],C=f.upgrades,x=0,w=C.length;w>x;x++)v=C[x],null==v.data&&k.push(v);null!=f.title&&null==f.title.data&&k.push(f.title),null!=f.modification&&null==f.modification.data&&k.push(f.modification)}if(c=$.randomInt(1+k.length),0===c)a=this.getAvailablePilotsIncluding(),m=a[$.randomInt(a.length)],p=m.children[$.randomInt(m.children.length)],o.pilotsById[p.id].sources.intersects(i.allowed_sources)&&(d=this.addShip(),d.setPilotById(p.id));else switch(n=k[c-1],n.type){case"Upgrade":l=function(){var t,e,s,a;for(s=this.getAvailableUpgradesIncluding(n.slot),a=[],t=0,e=s.length;e>t;t++)v=s[t],o.upgradesById[v.id].sources.intersects(i.allowed_sources)&&a.push(v);return a}.call(this),l.length>0&&n.setById(l[$.randomInt(l.length)].id);break;case"Title":r=function(){var t,e,s,a;for(s=this.getAvailableTitlesIncluding(n.ship.name),a=[],t=0,e=s.length;e>t;t++)y=s[t],o.titlesById[y.id].sources.intersects(i.allowed_sources)&&a.push(y);return a}.call(this),r.length>0&&n.setById(r[$.randomInt(r.length)].id);break;case"Modification":s=function(){var t,e,n,s;for(n=this.getAvailableModificationsIncluding(),s=[],t=0,e=n.length;e>t;t++)u=n[t],o.modificationsById[u.id].sources.intersects(i.allowed_sources)&&s.push(u);return s}.call(this),s.length>0&&n.setById(s[$.randomInt(s.length)].id);break;default:throw"Invalid addon type "+n.type}}else{for(h=[],B=this.ships,b=0,P=B.length;P>b;b++){for(f=B[b],h.push(f),W=f.upgrades,E=0,T=W.length;T>E;E++)v=W[E],null!=v.data&&h.push(v);null!=(null!=(D=f.title)?D.data:void 0)&&h.push(f.title),null!=(null!=(U=f.modification)?U.data:void 0)&&h.push(f.modification)}if(h.length>0)if(g=h[$.randomInt(h.length)],g instanceof e)this.removeShip(g);else{if(!(g instanceof t))throw"Unknown thing to remove "+g;g.setData(null)}}return window.setTimeout(this._makeRandomizerLoopFunc(i),0)}for(window.clearTimeout(i.timer),M=this.ships,q=0,S=M.length;S>q;q++)f=M[q],f.updateSelections();return this.suppress_automatic_new_ship=!1,this.addShip()},i.prototype._makeRandomizerLoopFunc=function(t){var i=this;return function(){return i._randomizerLoopBody(t)}},i.prototype.randomSquad=function(t,i,e,n){var s,a;for(null==t&&(t=100),null==i&&(i=null),null==e&&(e=1e3),null==n&&(n=1e3),this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";return s={iterations:0,max_points:t,allowed_sources:i,max_iterations:n,keep_running:!0,allowed_sources:null!=i?i:o.expansions},a=function(){return s.keep_running=!1},s.timer=window.setTimeout(a,e),window.setTimeout(this._makeRandomizerLoopFunc(s),0)},i}(),e=function(){function t(t){this.builder=t.builder,this.container=t.container,this.pilot=null,this.data=null,this.upgrades=[],this.modification=null,this.title=null,this.setupUI()}return t.prototype.destroy=function(t){var i;if(this.resetPilot(),this.resetAddons(),this.teardownUI(),i=this.builder.ships.indexOf(this),0>i)throw"Ship not registered with builder";return this.builder.ships.splice(i,1),t()},t.prototype.setPilotById=function(t){return this.setPilot(o.pilotsById[parseInt(t)])},t.prototype.setPilotByName=function(t){return this.setPilot(o.pilots[$.trim(t)])},t.prototype.setPilot=function(t){var i,e,n,s,a=this;return s=__iced_k_noop,e=iced.findDeferral(arguments),t===this.pilot?s():(null==this.pilot&&(this.builder.suppress_automatic_new_ship||this.builder.addShip(),this.remove_button.fadeIn("fast")),this.resetPilot(),this.resetAddons(),this.data=o.ships[null!=t?t.ship:void 0],function(i){return null==(null!=t?t.unique:void 0)?i():(function(i){n=new iced.Deferrals(i,{parent:e,funcname:"Ship.setPilot"}),a.builder.container.trigger("xwing:claimUnique",[t,"Pilot",n.defer({lineno:631})]),n._fulfill()}(i),void 0)}(function(){var e,n,o;for(a.pilot=t,null!=a.pilot&&a.setupAddons(),a.builder.container.trigger("xwing:pointsUpdated"),o=a.row.attr("class").split(" "),e=0,n=o.length;n>e;e++)i=o[e],0===i.indexOf("ship-")&&a.row.removeClass(i);return s(a.row.addClass("ship-"+a.data.name.toLowerCase().replace(/[^a-z0-9]/gi,"")+"0"))}),void 0)},t.prototype.resetPilot=function(){var t,i,e,n=this;e=__iced_k_noop,t=iced.findDeferral(arguments),function(e){var s;return null==(null!=(s=n.pilot)?s.unique:void 0)?e():(function(e){i=new iced.Deferrals(e,{parent:t,funcname:"Ship.resetPilot"}),n.builder.container.trigger("xwing:releaseUnique",[n.pilot,"Pilot",i.defer({lineno:643})]),i._fulfill()}(e),void 0)}(function(){return n.pilot=null})},t.prototype.setupAddons=function(){var t,e,a,r,l;for(l=null!=(r=this.pilot.slots)?r:[],e=0,a=l.length;a>e;e++)t=l[e],this.upgrades.push(new s({ship:this,container:this.addon_container,slot:t}));return this.pilot.ship in o.titlesByShip&&(this.title=new n({ship:this,container:this.addon_container})),this.modification=new i({ship:this,container:this.addon_container})},t.prototype.resetAddons=function(){var t,i,e,n,s,o=this;s=__iced_k_noop,e=iced.findDeferral(arguments),function(s){var a,r,l;for(n=new iced.Deferrals(s,{parent:e,funcname:"Ship.resetAddons"}),l=o.upgrades,t=a=0,r=l.length;r>a;t=++a)i=l[t],i.destroy(n.defer({lineno:666}));null!=o.modification&&o.modification.destroy(n.defer({lineno:667})),null!=o.title&&o.title.destroy(n.defer({lineno:668})),n._fulfill()}(function(){return o.upgrades=[],o.modification=null,o.title=null})},t.prototype.getPoints=function(){var t,i,e,n,s,o,a,r,l,c,u;for(t=(null!=(s=null!=(o=this.pilot)?o.points:void 0)?s:0)+(null!=(a=null!=(r=this.modification)?r.getPoints():void 0)?a:0)+(null!=(l=null!=(c=this.title)?c.getPoints():void 0)?l:0),u=this.upgrades,e=0,n=u.length;n>e;e++)i=u[e],t+=i.getPoints();return this.points_container.text(t),null!=this.pilot&&this.points_container.show(),t},t.prototype.updateSelections=function(){var t,i,e,n;if(null==this.pilot)return this.pilot_selector.select2("data",null);for(this.pilot_selector.select2("data",{id:this.pilot.id,text:""+this.pilot.name+" ("+this.pilot.points+")"}),n=this.upgrades,i=0,e=n.length;e>i;i++)t=n[i],t.updateSelection();return null!=this.title&&this.title.updateSelection(),null!=this.modification?this.modification.updateSelection():void 0},t.prototype.setupUI=function(){var t=this;return this.row=$(document.createElement("DIV")),this.row.addClass("row-fluid ship"),this.container.append(this.row),this.row.append($.trim('<div class="span3 pilot-selector-container">\n    <input type="hidden" />\n</div>\n<div class="span1 points-display-container">\n    <span></span>\n</div>\n<div class="span7 addon-container" />\n<div class="span1 remove-btn-container">\n    <button class="btn btn-danger"><span class="visible-desktop visible-tablet hidden-phone">&times;</span><span class="hidden-desktop hidden-tablet visible-phone">Remove Pilot</span></button>\n</div>')),this.pilot_selector=$(this.row.find("div.pilot-selector-container input[type=hidden]")),this.pilot_selector.select2({width:"100%",placeholder:"Select a pilot",query:function(i){return i.callback({more:!1,results:t.builder.getAvailablePilotsIncluding(t.pilot,i.term)})}}),this.pilot_selector.on("change",function(){return t.setPilotById(t.pilot_selector.select2("val"))}),this.pilot_selector.data("select2").results.on("mousemove-filtered",function(i){var e;return e=$(i.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=e?e.id:void 0)?t.builder.showTooltip("Pilot",o.pilotsById[e.id]):void 0}),this.pilot_selector.data("select2").container.on("mouseover",function(){return null!=t.pilot?t.builder.showTooltip("Pilot",t.pilot):void 0}),this.points_container=$(this.row.find(".points-display-container span")),this.points_container.hide(),this.addon_container=$(this.row.find("div.addon-container")),this.remove_button=$(this.row.find("div.remove-btn-container button")),this.remove_button.click(function(i){return i.preventDefault(),t.row.slideUp("fast",function(){return t.builder.removeShip(t)})}),this.remove_button.hide()},t.prototype.teardownUI=function(){return this.row.text(""),this.row.remove()},t.prototype.toString=function(){return null!=this.pilot?"Pilot "+this.pilot.name+" flying "+this.data.name:"Ship without pilot"},t}(),t=function(){function t(t){this.ship=t.ship,this.container=$(t.container),this.data=null,this.type=null,this.dataByName=null,this.dataById=null}return t.prototype.destroy=function(){var t,i,e,n,s,o=this;s=__iced_k_noop,e=iced.findDeferral(arguments),i=arguments[0],t=arguments.length>=2?a.call(arguments,1):[],function(t){var i;return null==(null!=(i=o.data)?i.unique:void 0)?t():(function(t){n=new iced.Deferrals(t,{parent:e,funcname:"GenericAddon.destroy"}),o.ship.builder.container.trigger("xwing:releaseUnique",[o.data,o.type,n.defer({lineno:766})]),n._fulfill()}(t),void 0)}(function(){return o.selector.select2("destroy"),i(t)})},t.prototype.setupSelector=function(t){var i=this;return this.selector=$(document.createElement("INPUT")),this.selector.attr("type","hidden"),this.container.append(this.selector),this.selector.select2(t),this.selector.on("change",function(){return i.setById(i.selector.select2("val"))}),this.selector.data("select2").results.on("mousemove-filtered",function(t){var e;return e=$(t.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=e?e.id:void 0)?i.ship.builder.showTooltip("Addon",i.dataById[e.id]):void 0}),this.selector.data("select2").container.on("mouseover",function(){return null!=i.data?i.ship.builder.showTooltip("Addon",i.data):void 0})},t.prototype.setById=function(t){return this.setData(this.dataById[parseInt(t)])},t.prototype.setByName=function(t){return this.setData(this.dataByName[$.trim(t)])},t.prototype.setData=function(t){var i,e,n,s=this;return n=__iced_k_noop,i=iced.findDeferral(arguments),t===this.data?n():(function(t){var n;return null==(null!=(n=s.data)?n.unique:void 0)?t():(function(t){e=new iced.Deferrals(t,{parent:i,funcname:"GenericAddon.setData"}),s.ship.builder.container.trigger("xwing:releaseUnique",[s.data,s.type,e.defer({lineno:792})]),e._fulfill()}(t),void 0)}(function(){(function(n){return null==(null!=t?t.unique:void 0)?n():(function(n){e=new iced.Deferrals(n,{parent:i,funcname:"GenericAddon.setData"}),s.ship.builder.container.trigger("xwing:claimUnique",[t,s.type,e.defer({lineno:794})]),e._fulfill()}(n),void 0)})(function(){return s.data=t,n(s.ship.builder.container.trigger("xwing:pointsUpdated"))})}),void 0)},t.prototype.getPoints=function(){var t,i;return null!=(t=null!=(i=this.data)?i.points:void 0)?t:0},t.prototype.updateSelection=function(){return null!=this.data?this.selector.select2("data",{id:this.data.id,text:""+this.data.name+" ("+this.data.points+")"}):this.selector.select2("data",null)},t.prototype.toString=function(){return null!=this.data?""+this.data.name+" ("+this.data.points+")":"No "+this.type},t}(),s=function(t){function i(t){i.__super__.constructor.call(this,t),this.slot=t.slot,this.type="Upgrade",this.dataById=o.upgradesById,this.dataByName=o.upgrades,this.setupSelector()}return u(i,t),i.prototype.setupSelector=function(){var t=this;return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No "+this.slot+" Upgrade",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableUpgradesIncluding(t.slot,t.data,i.term)})}})},i}(t),i=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Modification",this.dataById=o.modificationsById,this.dataByName=o.modifications,this.setupSelector()}return u(i,t),i.prototype.setupSelector=function(){var t=this;return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Modification",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableModificationsIncluding(t.data,i.term)})}})},i}(t),n=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Title",this.dataById=o.titlesById,this.dataByName=o.titles,this.conferredUpgrades=[],this.setupSelector()}return u(i,t),i.prototype.setData=function(t){var i,e,n,o,a,r,l=this;return r=__iced_k_noop,o=iced.findDeferral(arguments),t===this.data?r():(function(t){return null==l.data?t():(function(t){a=new iced.Deferrals(t,{parent:o,funcname:"Title.setData"}),l.ship.builder.container.trigger("xwing:releaseUnique",[l.data,"Title",a.defer({lineno:869})]),a._fulfill()}(function(){(function(t){var i,e,s;for(a=new iced.Deferrals(t,{parent:o,funcname:"Title.setData"}),s=l.conferredUpgrades,i=0,e=s.length;e>i;i++)n=s[i],n.destroy(a.defer({lineno:873}));a._fulfill()})(function(){var e,s,o;for(o=l.conferredUpgrades,e=0,s=o.length;s>e;e++)n=o[e],i=l.ship.upgrades.indexOf(n),l.ship.upgrades.splice(i,1);return t(l.conferredUpgrades=[])})}),void 0)}(function(){(function(i){return null==t?i():(function(i){a=new iced.Deferrals(i,{parent:o,funcname:"Title.setData"}),l.ship.builder.container.trigger("xwing:claimUnique",[t,"Title",a.defer({lineno:878})]),a._fulfill()}(i),void 0)})(function(){var i,o,a,c;if(l.data=t,l.ship.builder.container.trigger("xwing:pointsUpdated"),null!=(null!=(a=l.data)?a.slots:void 0)&&l.data.slots.length>0)for(c=l.data.slots,i=0,o=c.length;o>i;i++)e=c[i],n=new s({ship:l.ship,container:l.container,slot:e}),l.ship.upgrades.push(n),l.conferredUpgrades.push(n);return r()})}),void 0)},i.prototype.setupSelector=function(){var t=this;
return i.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Title",allowClear:!0,query:function(i){return i.callback({more:!1,results:t.ship.builder.getAvailableTitlesIncluding(t.ship.data.name,t.data,i.term)})}})},i}(t)}).call(this);