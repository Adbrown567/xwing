(function(){var t,n,e,i,a,s,o,r=[].slice,l=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1},d=function(t,n){return function(){return t.apply(n,arguments)}},u={}.hasOwnProperty,c=function(t,n){function e(){this.constructor=t}for(var i in n)u.call(n,i)&&(t[i]=n[i]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var n=this;return++this.count,function(){var e,i;return e=arguments.length>=1?r.call(arguments,0):[],null!=t&&null!=(i=t.assign_fn)&&i.apply(null,e),n._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},o="undefined"!=typeof exports&&null!==exports?exports:this,o.sortHelper=function(t,n){var e,i;return t.points===n.points?(e=t.text.replace(/[^a-z0-9]/gi,""),i=n.text.replace(/[^a-z0-9]/gi,""),e===i?0:e>i?1:-1):t.points>n.points?1:-1},$.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)},$.randomInt=function(t){return Math.floor(Math.random()*t)},$.getParameterByName=function(t){var n,e,i;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e="[\\?&]"+t+"=([^&#]*)",n=RegExp(e),i=n.exec(window.location.search),null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},Array.prototype.intersects=function(t){var n,e,i;for(e=0,i=this.length;i>e;e++)if(n=this[e],l.call(t,n)>=0)return!0;return!1},e=24,o.SquadBuilder=function(){function n(t){this._makeRandomizerLoopFunc=d(this._makeRandomizerLoopFunc,this),this._randomizerLoopBody=d(this._randomizerLoopBody,this),this.releaseUnique=d(this.releaseUnique,this),this.claimUnique=d(this.claimUnique,this),this.onSquadNameChanged=d(this.onSquadNameChanged,this),this.onSquadDirtinessChanged=d(this.onSquadDirtinessChanged,this),this.onSquadLoadRequested=d(this.onSquadLoadRequested,this),this.onPointsUpdated=d(this.onPointsUpdated,this),this.container=$(t.container),this.faction=$.trim(t.faction),this.printable_container=$(t.printable_container),this.ships=[],this.uniques_in_use={Pilot:[],Upgrade:[],Modification:[],Title:[]},this.suppress_automatic_new_ship=!1,this.tooltip_currently_displaying=null,this.randomizer_options={sources:null,points:100},this.backend=null,this.current_squad={},this.setupUI(),this.setupEventHandlers(),this.resetCurrentSquad(),$.getParameterByName("f")===this.faction?this.loadFromSerialized($.getParameterByName("d")):this.addShip()}return n.prototype.resetCurrentSquad=function(){return this.current_squad={id:null,name:$.trim(this.squad_name_input.val()),dirty:!1,additional_data:{points:this.total_points,description:"",cards:[]},faction:this.faction}},n.prototype.setupUI=function(){var t,n,e,i,a,s,r,l,d,u=this;for(n=100,e=2,t=1e3,this.status_container=$(document.createElement("DIV")),this.status_container.addClass("container-fluid"),this.status_container.append($.trim('<div class="span3 squad-name-container">\n    <div class="row">\n        <div class="span12">\n            <div class="display-name">\n                <span class="squad-name">Unnamed Squadron</span>\n                <i class="icon-pencil"></i>\n            </div>\n            <div class="input-append">\n                <input type="text" maxlength="64" placeholder="Name your squad..." />\n                <button class="btn save"><i class="icon-edit"></i></button>\n            </div>\n        </div>\n    </div class="row">\n    <div class="row show-authenticated">\n        <div class="span12">\n            <button class="btn btn-primary save-list"><i class="icon-save"></i>&nbsp;Save</button>\n            <button class="btn btn-primary save-list-as"><i class="icon-copy"></i>&nbsp;Save As...</button>\n            <button class="btn btn-primary delete-list disabled"><i class="icon-trash"></i>&nbsp;Delete</button>\n            <span class="backend-status"></span>\n        </div>\n    </div>\n</div>\n<div class="span2 points-display-container">Total Points: 0</div>\n<div class="span7 pull-right button-container">\n    <div class="btn-group pull-right">\n        <button class="btn btn-primary backend-login-logout">\n            <span class="hide-authenticated"><i class="icon-signin"></i> Log In</span>\n            <span class="show-authenticated"><i class="icon-signout"></i> Log Out</span>\n        </button>\n        <button class="btn btn-primary backend-list-my-squads show-authenticated">Your Squads</button>\n        <!-- <button class="btn btn-primary backend-list-all-squads show-authenticated">Everyone\'s Squads</button> -->\n        <button class="btn btn-primary view-as-text">View as Text</button>\n        <button class="btn btn-primary print-list hidden-phone"><i class="icon-print"></i>&nbsp;Print</button>\n        <a class="btn btn-primary permalink"><i class="icon-link"></i>&nbsp;Permalink</a>\n\n        <button class="btn btn-primary randomize" ><i class="icon-random"></i>&nbsp;Random Squad!</button>\n        <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">\n            <span class="caret"></span>\n        </button>\n        <ul class="dropdown-menu">\n            <li><a class="randomize-options">Randomizer Options...</a></li>\n        </ul>\n    </div>\n</div>')),this.container.append(this.status_container),this.list_modal=$(document.createElement("DIV")),this.list_modal.addClass("modal hide fade text-list-modal"),this.container.append(this.list_modal),this.list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close hide-on-print" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3><span class="squad-name"></span> ('+this.faction+'): <span class="total-points">0</span> Points </h3>\n</div>\n<div class="modal-body">\n    <ul></ul>\n</div>\n<div class="modal-footer hide-on-print">\n    <button class="btn print-list hidden-phone"><i class="icon-print"></i>&nbsp;Print</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.text_ul=$(this.list_modal.find("div.modal-body ul")),this.text_total_points_container=$(this.list_modal.find("div.modal-header span.total-points")),this.squad_name_container=$(this.status_container.find("div.squad-name-container")),this.squad_name_display=$(this.container.find(".display-name")),this.squad_name_placeholder=$(this.container.find(".squad-name")),this.squad_name_input=$(this.squad_name_container.find("input")),this.squad_name_save_button=$(this.squad_name_container.find("button.save")),this.squad_name_input.closest("div").hide(),this.points_container=$(this.status_container.find("div.points-display-container")),this.permalink=$(this.status_container.find("div.button-container a.permalink")),this.view_list_button=$(this.status_container.find("div.button-container button.view-as-text")),this.randomize_button=$(this.status_container.find("div.button-container button.randomize")),this.customize_randomizer=$(this.status_container.find("div.button-container a.randomize-options")),this.backend_status=$(this.status_container.find(".backend-status")),this.backend_status.hide(),this.squad_name_input.keypress(function(t){return 13===t.which?(u.squad_name_save_button.click(),!1):void 0}),this.squad_name_input.change(function(){return u.current_squad.dirty=!0,u.container.trigger("xwing-backend:squadDirtinessChanged"),u.backend_status.fadeOut("slow")}),this.squad_name_input.blur(function(){return u.squad_name_input.change(),u.squad_name_save_button.click()}),this.squad_name_display.click(function(t){return t.preventDefault(),u.squad_name_display.hide(),u.squad_name_input.val($.trim(u.current_squad.name)),window.setTimeout(function(){return u.squad_name_input.focus(),u.squad_name_input.select()},100),u.squad_name_input.closest("div").show()}),this.squad_name_save_button.click(function(t){var n;return t.preventDefault(),n=u.current_squad.name=$.trim(u.squad_name_input.val()),n.length>0?(u.squad_name_display.show(),u.container.trigger("xwing-backend:squadNameChanged"),u.squad_name_input.closest("div").hide()):void 0}),this.randomizer_options_modal=$(document.createElement("DIV")),this.randomizer_options_modal.addClass("modal hide fade"),$(document).append(this.randomizer_options_modal),this.randomizer_options_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Random Squad Builder Options</h3>\n</div>\n<div class="modal-body">\n    <form>\n        <label>\n            Desired Points\n            <input type="number" class="randomizer-points" value="'+n+'" placeholder="'+n+'" />\n        </label>\n        <label>\n            Sets and Expansions (default all)\n            <select class="randomizer-sources" multiple="1" data-placeholder="Use all sets and expansions">\n            </select>\n        </label>\n        <label>\n            Maximum Seconds to Spend Randomizing\n            <input type="number" class="randomizer-timeout" value="'+e+'" placeholder="'+e+'" />\n        </label>\n        <label>\n            Maximum Randomization Iterations\n            <input type="number" class="randomizer-iterations" value="'+t+'" placeholder="'+t+'" />\n        </label>\n    </form>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary do-randomize" aria-hidden="true">Randomize!</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.randomizer_source_selector=$(this.randomizer_options_modal.find("select.randomizer-sources")),d=o.expansions,r=0,l=d.length;l>r;r++)a=d[r],s=$(document.createElement("OPTION")),s.text(a),this.randomizer_source_selector.append(s);return this.randomizer_source_selector.select2({width:"100%"}),this.randomize_button.click(function(i){var a,s,o;return i.preventDefault(),u.current_squad.dirty&&null!=u.backend?u.backend.warnUnsaved(u,function(){return u.randomize_button.click()}):(s=parseInt($(u.randomizer_options_modal.find(".randomizer-points")).val()),(isNaN(s)||0>=s)&&(s=n),o=parseInt($(u.randomizer_options_modal.find(".randomizer-timeout")).val()),(isNaN(o)||0>=o)&&(o=e),a=parseInt($(u.randomizer_options_modal.find(".randomizer-iterations")).val()),(isNaN(a)||0>=a)&&(a=t),u.randomSquad(s,u.randomizer_source_selector.val(),1e3*e,a))}),this.randomizer_options_modal.find("button.do-randomize").click(function(t){return t.preventDefault(),u.randomizer_options_modal.modal("hide"),u.randomize_button.click()}),this.customize_randomizer.click(function(t){return t.preventDefault(),u.randomizer_options_modal.modal()}),this.backend_login_logout_button=$(this.container.find("button.backend-login-logout")),this.backend_login_logout_button.click(function(t){return t.preventDefault(),null!=u.backend?u.backend.authenticated?u.backend.logout():u.backend.login():void 0}),this.backend_list_squads_button=$(this.container.find("button.backend-list-my-squads")),this.backend_list_squads_button.click(function(t){return t.preventDefault(),null!=u.backend?u.backend.list(u):void 0}),this.backend_save_list_button=$(this.container.find("button.save-list")),this.backend_save_list_button.click(function(t){var n,e,i,a,s;return s=__iced_k_noop,i=iced.findDeferral(arguments),t.preventDefault(),null==u.backend||$(t.target).hasClass("disabled")?s():(n={points:u.total_points,description:u.describeSquad(),cards:u.listCards()},u.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Saving squad...')),u.backend_status.show(),u.backend_save_list_button.addClass("disabled"),function(t){a=new iced.Deferrals(t,{parent:i}),u.backend.save(u.serialize(),u.current_squad.id,u.current_squad.name,u.faction,n,a.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:311})),a._fulfill()}(function(){return s(e.success?(u.current_squad.dirty=!1,null!=u.current_squad.id?u.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;Squad updated successfully.')):(u.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;New squad saved successfully.')),u.current_squad.id=e.id),u.container.trigger("xwing-backend:squadDirtinessChanged")):(u.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+e.error)),u.backend_save_list_button.removeClass("disabled")))}),void 0)}),this.backend_save_list_as_button=$(this.container.find("button.save-list-as")),this.backend_save_list_as_button.click(function(t){return t.preventDefault(),null==u.backend||$(t.target).hasClass("disabled")?void 0:u.backend.showSaveAsModal(u)}),this.backend_delete_list_button=$(this.container.find("button.delete-list")),this.backend_delete_list_button.click(function(t){return t.preventDefault(),null==u.backend||$(t.target).hasClass("disabled")?void 0:u.backend.showDeleteModal(u)}),i=$(document.createElement("DIV")),i.addClass("container-fluid"),this.container.append(i),i.append($.trim('<div class="row-fluid">\n    <div class="span9 ship-container" />\n    <div class="span3 hidden-phone info-container" />\n</div>')),this.ship_container=$(i.find("div.ship-container")),this.info_container=$(i.find("div.info-container")),this.info_container.append($.trim('<div class="well well-small info-well">\n    <span class="info-name"></span>\n    <table>\n        <tbody>\n            <tr class="info-ship">\n                <td>Ship</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-skill">\n                <td>Skill</td>\n                <td class="info-data info-skill"></td>\n            </tr>\n            <tr class="info-attack">\n                <td><img class="icon-attack" src="images/transparent.png" alt="Attack" /></td>\n                <td class="info-data info-attack"></td>\n            </tr>\n            <tr class="info-range">\n                <td>Range</td>\n                <td class="info-data info-range"></td>\n            </tr>\n            <tr class="info-agility">\n                <td><img class="icon-agility" src="images/transparent.png" alt="Agility" /></td>\n                <td class="info-data info-agility"></td>\n            </tr>\n            <tr class="info-hull">\n                <td><img class="icon-hull" src="images/transparent.png" alt="Hull" /></td>\n                <td class="info-data info-hull"></td>\n            </tr>\n            <tr class="info-shields">\n                <td><img class="icon-shields" src="images/transparent.png" alt="Shields" /></td>\n                <td class="info-data info-shields"></td>\n            </tr>\n            <tr class="info-actions">\n                <td>Actions</td>\n                <td class="info-data"></td>\n            </tr>\n        </tbody>\n    </table>\n    <p class="info-text" />\n</div>')),this.info_container.hide(),this.print_list_button=$(this.container.find("button.print-list")),this.container.find("[rel=tooltip]").tooltip()},n.prototype.setupEventHandlers=function(){var t=this;return this.container.on("xwing:claimUnique",function(n,e,i,a){return t.claimUnique(e,i,a)}).on("xwing:releaseUnique",function(n,e,i,a){return t.releaseUnique(e,i,a)}).on("xwing:pointsUpdated",function(n,e){return null==e&&(e=$.noop),t.onPointsUpdated(e)}).on("xwing-backend:squadLoadRequested",function(n,e){return t.onSquadLoadRequested(e)}).on("xwing-backend:squadDirtinessChanged",function(){return t.onSquadDirtinessChanged()}).on("xwing-backend:squadNameChanged",function(){return t.onSquadNameChanged()}),this.view_list_button.click(function(n){return n.preventDefault(),t.showTextListModal()}),this.print_list_button.click(function(n){return n.preventDefault(),t.printable_container.html(t.list_modal.html()),window.print()})},n.prototype.onPointsUpdated=function(t){var n,e,i,a,s,o,r,l,d,u,c,h,p,m,f,g,_,v;for(this.total_points=0,h=this.ships,e=o=0,d=h.length;d>o;e=++o)i=h[e],this.total_points+=i.getPoints();for(this.points_container.text("Total Points: "+this.total_points),this.text_total_points_container.text(this.total_points),this.permalink.attr("href",""+window.location.href.split("?")[0]+"?f="+encodeURI(this.faction)+"&d="+encodeURI(this.serialize())),this.text_ul.text(""),p=this.ships,r=0,u=p.length;u>r;r++)if(i=p[r],null!=i.pilot){if(function(){var t,n,e,a;for(e=i.upgrades,a=[],t=0,n=e.length;n>t;t++)s=e[t],null!=s.data&&a.push(s);return a}().length>0||null!=(null!=(m=i.modification)?m.data:void 0)||null!=(null!=(f=i.title)?f.data:void 0)){for(n="<ul>",null!=(null!=(g=i.title)?g.data:void 0)&&(n+="<li>"+(""+i.title)+"</li>"),_=i.upgrades,l=0,c=_.length;c>l;l++)s=_[l],null!=s.data&&(n+="<li>"+(""+s)+"</li>");null!=(null!=(v=i.modification)?v.data:void 0)&&(n+="<li>"+(""+i.modification)+"</li>"),n+="</ul>",a="Total: "+i.getPoints()}else a="",n="";this.text_ul.append($.trim('<li>\n    <span class="info-name">'+i.pilot.name+" ("+i.pilot.points+")</span>\n    <br />\n    "+n+"\n    <em>"+a+"</em>\n</li>"))}return t(this.total_points)},n.prototype.onSquadLoadRequested=function(t){return this.current_squad=t,this.current_squad.dirty=!1,this.container.trigger("xwing-backend:squadDirtinessChanged"),this.backend_delete_list_button.removeClass("disabled"),this.squad_name_input.val(this.current_squad.name),this.squad_name_placeholder.text(this.current_squad.name),this.loadFromSerialized(t.serialized)},n.prototype.onSquadDirtinessChanged=function(){return this.current_squad.dirty?this.backend_save_list_button.removeClass("disabled"):this.backend_save_list_button.addClass("disabled"),null!=this.current_squad.id?this.backend_delete_list_button.removeClass("disabled"):this.backend_delete_list_button.addClass("disabled")},n.prototype.onSquadNameChanged=function(){var t;return t=this.current_squad.name.length>e?""+this.current_squad.name.substr(0,e)+"&hellip;":this.current_squad.name,this.squad_name_placeholder.text(""),this.squad_name_placeholder.append(t),this.squad_name_input.val(this.current_squad.name)},n.prototype.showTextListModal=function(){return this.list_modal.modal("show")},n.prototype.serialize=function(){var t,n,e,i;return function(){var a,s,o,r,l,d,u,c,h,p;for(o=this.ships,p=[],a=0,s=o.length;s>a;a++)n=o[a],null!=n.pilot&&p.push(""+n.pilot.id+":"+function(){var i,a,s,o,r,l;for(s=n.pilot.slots,l=[],t=i=0,a=s.length;a>i;t=++i)e=s[t],l.push(null!=(o=null!=(r=n.upgrades[t].data)?r.id:void 0)?o:-1);return l}()+":"+(null!=(r=null!=(l=n.title)?null!=(d=l.data)?d.id:void 0:void 0)?r:-1)+":"+function(){var t,e,a,s,o,r,l,d;for(o=null!=(a=null!=(s=n.title)?s.conferredUpgrades:void 0)?a:[],d=[],t=0,e=o.length;e>t;t++)i=o[t],d.push(null!=(r=null!=(l=i.data)?l.id:void 0)?r:-1);return d}()+":"+(null!=(u=null!=(c=n.modification)?null!=(h=c.data)?h.id:void 0:void 0)?u:-1));return p}.call(this).join(";")},n.prototype.loadFromSerialized=function(t){var n,e,i,a,s,o,r,l,d,u,c,h,p,m,f,g,_,v,b;for(this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";for(g=t.split(";"),u=0,p=g.length;p>u;u++){for(s=g[u],_=s.split(":"),a=_[0],d=_[1],r=_[2],o=_[3],e=_[4],i=this.addShip(),i.setPilotById(parseInt(a)),v=d.split(","),n=c=0,m=v.length;m>c;n=++c)l=v[n],l=parseInt(l),l>=0&&i.upgrades[n].setById(l);if(r=parseInt(r),r>=0&&i.title.setById(r),null!=i.title&&i.title.conferredUpgrades.length>0)for(b=o.split(","),n=h=0,f=b.length;f>h;n=++h)l=b[n],l=parseInt(l),l>=0&&i.title.conferredUpgrades[n].setById(l);e=parseInt(e),e>=0&&i.modification.setById(e),i.updateSelections()}return this.suppress_automatic_new_ship=!1,this.addShip()},n.prototype.uniqueIndex=function(t,n){if(!(n in this.uniques_in_use))throw"Invalid unique type '"+n+"'";return this.uniques_in_use[n].indexOf(t)},n.prototype.claimUnique=function(t,n,e){var i,a;if(!(0>this.uniqueIndex(t,n)))throw"Unique "+n+" '"+t.name+"' already claimed";if("Pilot"===n){if(i=o.upgrades[t.name],null!=i&&null!=(null!=i?i.unique:void 0)){if(!(0>this.uniqueIndex(i,"Upgrade")))throw"Unique "+n+" '"+t.name+"' already claimed as crew";this.uniques_in_use.Upgrade.push(i)}}else if("Upgrade"===n&&"Crew"===t.slot&&(a=o.pilots[t.name],null!=a&&null!=(null!=a?a.unique:void 0))){if(!(0>this.uniqueIndex(a,"Pilot")))throw"Unique "+n+" '"+t.name+"' already claimed as pilot";this.uniques_in_use.Pilot.push(a)}return this.uniques_in_use[n].push(t),e()},n.prototype.releaseUnique=function(t,n,e){var i,a,s;if(a=this.uniqueIndex(t,n),!(a>=0))throw"Unique "+n+" '"+t.name+"' not in use";if(this.uniques_in_use[n].splice(a,1),"Pilot"===n){if(i=o.upgrades[t.name],null!=i&&null!=(null!=i?i.unique:void 0)){if(a=this.uniqueIndex(i,"Upgrade"),0>a)throw"Unique crew accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Upgrade.splice(a,1)}}else if("Upgrade"===n&&"Crew"===t.slot&&(s=o.pilots[t.name],null!=s&&null!=(null!=s?s.unique:void 0))){if(a=this.uniqueIndex(s,"Pilot"),0>a)throw"Unique pilot accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Pilot.splice(a,1)}return e()},n.prototype.addShip=function(){var t;return t=new i({builder:this,container:this.ship_container}),this.ships.push(t),t},n.prototype.removeShip=function(t){var n,e,i,a=this;i=__iced_k_noop,n=iced.findDeferral(arguments),function(i){e=new iced.Deferrals(i,{parent:n,funcname:"SquadBuilder.removeShip"}),t.destroy(e.defer({lineno:592})),e._fulfill()}(function(){e=new iced.Deferrals(i,{parent:n,funcname:"SquadBuilder.removeShip"}),a.container.trigger("xwing:pointsUpdated",e.defer({lineno:593})),e._fulfill()})},n.prototype.matcher=function(t,n){return t.toUpperCase().indexOf(n.toUpperCase())>=0},n.prototype.getAvailablePilotsIncluding=function(t,n){var e,i,a,s,r,d,u,c,h,p,m,f,g;for(null==n&&(n=""),u=function(){var t,a;t=o.pilots,a=[];for(i in t)e=t[i],o.ships[e.ship].faction===this.faction&&this.matcher(i,n)&&(null==e.unique||0>l.call(this.uniques_in_use.Pilot,e))&&a.push(e);return a}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,n)&&u.push(t),s={},f=function(){var t,n,i;for(i=[],t=0,n=u.length;n>t;t++)e=u[t],i.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points,ship:e.ship});return i}(),c=0,p=f.length;p>c;c++)a=f[c],a.ship in s||(s[a.ship]=[]),s[a.ship].push(a);for(r=[],g=Object.keys(s).sort(),h=0,m=g.length;m>h;h++)d=g[h],r.push({text:d,children:s[d].sort(o.sortHelper)});return r},n.prototype.getAvailableUpgradesIncluding=function(t,n,e){var i,a,s;return null==e&&(e=""),i=function(){var n,i;n=o.upgrades,i=[];for(s in n)a=n[s],a.slot===t&&this.matcher(s,e)&&(null==a.unique||0>l.call(this.uniques_in_use.Upgrade,a))&&(null==a.faction||a.faction===this.faction)&&i.push(a);return i}.call(this),null!=n&&null!=n.unique&&this.matcher(n.name,e)&&i.push(n),function(){var t,n,e;for(e=[],t=0,n=i.length;n>t;t++)a=i[t],e.push({id:a.id,text:""+a.name+" ("+a.points+")",points:a.points});return e}().sort(o.sortHelper)},n.prototype.getAvailableModificationsIncluding=function(t,n){var e,i,a;return null==n&&(n=""),a=function(){var t,a;t=o.modifications,a=[];for(i in t)e=t[i],this.matcher(i,n)&&(null==e.unique||0>l.call(this.uniques_in_use.Modification,e))&&(null==e.faction||e.faction===this.faction)&&a.push(e);return a}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,n)&&a.push(t),function(){var t,n,i;for(i=[],t=0,n=a.length;n>t;t++)e=a[t],i.push({id:e.id,text:""+e.name+" ("+e.points+")",points:e.points});return i}().sort(o.sortHelper)},n.prototype.getAvailableTitlesIncluding=function(t,n,e){var i,a,s;return null==e&&(e=""),s=function(){var n,s;n=o.titles,s=[];for(a in n)i=n[a],i.ship===t&&this.matcher(a,e)&&0>l.call(this.uniques_in_use.Title,i)&&(null==i.faction||i.faction===this.faction)&&s.push(i);return s}.call(this),null!=n&&this.matcher(n.name,e)&&s.push(n),function(){var t,n,e;for(e=[],t=0,n=s.length;n>t;t++)i=s[t],e.push({id:i.id,text:""+i.name+" ("+i.points+")",points:i.points});return e}().sort(o.sortHelper)},n.prototype.showTooltip=function(t,n){var e,i,a,s,r,l,d,u,c,h;if(n!==this.tooltip_currently_displaying){switch(this.info_container.find(".info-name").text(n.name),this.info_container.find("p.info-text").html(null!=(i=n.text)?i:""),t){case"Pilot":e=o.ships[n.ship],this.info_container.find("tr.info-ship td.info-data").text(n.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(n.skill),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(null!=(a=null!=(s=n.ship_override)?s.attack:void 0)?a:e.attack),this.info_container.find("tr.info-attack").show(),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(null!=(r=null!=(l=n.ship_override)?l.agility:void 0)?r:e.agility),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(null!=(d=null!=(u=n.ship_override)?u.hull:void 0)?d:e.hull),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(null!=(c=null!=(h=n.ship_override)?h.shields:void 0)?c:e.shields),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").text(o.ships[n.ship].actions.join(", ")),this.info_container.find("tr.info-actions").show();break;case"Addon":this.info_container.find("tr.info-ship").hide(),this.info_container.find("tr.info-skill").hide(),null!=n.attack?(this.info_container.find("tr.info-attack td.info-data").text(n.attack),this.info_container.find("tr.info-attack").show()):this.info_container.find("tr.info-attack").hide(),null!=n.range?(this.info_container.find("tr.info-range td.info-data").text(n.range),this.info_container.find("tr.info-range").show()):this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility").hide(),this.info_container.find("tr.info-hull").hide(),this.info_container.find("tr.info-shields").hide(),this.info_container.find("tr.info-actions").hide()}return this.info_container.show(),this.tooltip_currently_displaying=n}},n.prototype._randomizerLoopBody=function(n){var e,a,s,r,l,d,u,c,h,p,m,f,g,_,v,b,y,k,w,q,x,I,E,P,S,C,A,T,D,B,U,W,M;if(n.keep_running&&n.iterations<n.max_iterations){if(n.iterations++,this.total_points===n.max_points)n.keep_running=!1;else if(this.total_points<n.max_points){for(v=[],A=this.ships,y=0,x=A.length;x>y;y++){for(m=A[y],T=m.upgrades,k=0,I=T.length;I>k;k++)b=T[k],null==b.data&&v.push(b);null!=m.title&&null==m.title.data&&v.push(m.title),null!=m.modification&&null==m.modification.data&&v.push(m.modification)}if(d=$.randomInt(1+v.length),0===d)s=this.getAvailablePilotsIncluding(),f=s[$.randomInt(s.length)],h=f.children[$.randomInt(f.children.length)],o.pilotsById[h.id].sources.intersects(n.allowed_sources)&&(c=this.addShip(),c.setPilotById(h.id));else switch(e=v[d-1],e.type){case"Upgrade":l=function(){var t,i,a,s;for(a=this.getAvailableUpgradesIncluding(e.slot),s=[],t=0,i=a.length;i>t;t++)b=a[t],o.upgradesById[b.id].sources.intersects(n.allowed_sources)&&s.push(b);return s}.call(this),l.length>0&&e.setById(l[$.randomInt(l.length)].id);break;case"Title":r=function(){var t,i,a,s;for(a=this.getAvailableTitlesIncluding(e.ship.name),s=[],t=0,i=a.length;i>t;t++)_=a[t],o.titlesById[_.id].sources.intersects(n.allowed_sources)&&s.push(_);return s}.call(this),r.length>0&&e.setById(r[$.randomInt(r.length)].id);break;case"Modification":a=function(){var t,e,i,a;for(i=this.getAvailableModificationsIncluding(),a=[],t=0,e=i.length;e>t;t++)u=i[t],o.modificationsById[u.id].sources.intersects(n.allowed_sources)&&a.push(u);return a}.call(this),a.length>0&&e.setById(a[$.randomInt(a.length)].id);break;default:throw"Invalid addon type "+e.type}}else{for(p=[],D=this.ships,w=0,E=D.length;E>w;w++){for(m=D[w],p.push(m),B=m.upgrades,q=0,P=B.length;P>q;q++)b=B[q],null!=b.data&&p.push(b);null!=(null!=(U=m.title)?U.data:void 0)&&p.push(m.title),null!=(null!=(W=m.modification)?W.data:void 0)&&p.push(m.modification)}if(p.length>0)if(g=p[$.randomInt(p.length)],g instanceof i)this.removeShip(g);else{if(!(g instanceof t))throw"Unknown thing to remove "+g;g.setData(null)}}return window.setTimeout(this._makeRandomizerLoopFunc(n),0)}for(window.clearTimeout(n.timer),M=this.ships,C=0,S=M.length;S>C;C++)m=M[C],m.updateSelections();return this.suppress_automatic_new_ship=!1,this.addShip()},n.prototype._makeRandomizerLoopFunc=function(t){var n=this;return function(){return n._randomizerLoopBody(t)}},n.prototype.randomSquad=function(t,n,e,i){var a,s;for(null==t&&(t=100),null==n&&(n=null),null==e&&(e=1e3),null==i&&(i=1e3),this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";return a={iterations:0,max_points:t,allowed_sources:n,max_iterations:i,keep_running:!0,allowed_sources:null!=n?n:o.expansions},s=function(){return a.keep_running=!1},a.timer=window.setTimeout(s,e),window.setTimeout(this._makeRandomizerLoopFunc(a),0),this.resetCurrentSquad(),this.current_squad.name="Random Squad",this.container.trigger("xwing-backend:squadNameChanged")},n.prototype.setBackend=function(t){var n=this;return this.backend=t,this.updateAuthenticationVisibility(),$(window).on("xwing-backend:authenticationChanged",function(){return n.updateAuthenticationVisibility()})},n.prototype.updateAuthenticationVisibility=function(){return this.backend.authenticated?(this.container.find(".show-authenticated").show(),this.container.find(".hide-authenticated").hide()):(this.container.find(".show-authenticated").hide(),this.container.find(".hide-authenticated").show())},n.prototype.describeSquad=function(){var t;return function(){var n,e,i,a;for(i=this.ships,a=[],n=0,e=i.length;e>n;n++)t=i[n],null!=t.pilot&&a.push(t.pilot.name);return a}.call(this).join(", ")},n.prototype.listCards=function(){var t,n,e,i,a,s,o,r,l,d,u;for(t={},r=this.ships,i=0,s=r.length;s>i;i++)if(n=r[i],null!=n.pilot){for(t[n.pilot.name]=null,l=n.upgrades,a=0,o=l.length;o>a;a++)e=l[a],null!=e.data&&(t[e.data.name]=null);null!=(null!=(d=n.title)?d.data:void 0)&&(t[n.title.data.name]=null),null!=(null!=(u=n.modification)?u.data:void 0)&&(t[n.modification.data.name]=null)}return Object.keys(t).sort()},n}(),i=function(){function t(t){this.builder=t.builder,this.container=t.container,this.pilot=null,this.data=null,this.upgrades=[],this.modification=null,this.title=null,this.setupUI()}return t.prototype.destroy=function(t){var n;if(this.resetPilot(),this.resetAddons(),this.teardownUI(),n=this.builder.ships.indexOf(this),0>n)throw"Ship not registered with builder";return this.builder.ships.splice(n,1),t()},t.prototype.setPilotById=function(t){return this.setPilot(o.pilotsById[parseInt(t)])},t.prototype.setPilotByName=function(t){return this.setPilot(o.pilots[$.trim(t)])},t.prototype.setPilot=function(t){var n,e,i,a,s=this;return a=__iced_k_noop,e=iced.findDeferral(arguments),t===this.pilot?a():(null==this.pilot&&(this.builder.suppress_automatic_new_ship||this.builder.addShip(),this.remove_button.fadeIn("fast")),this.resetPilot(),this.resetAddons(),this.data=o.ships[null!=t?t.ship:void 0],function(n){return null==(null!=t?t.unique:void 0)?n():(function(n){i=new iced.Deferrals(n,{parent:e,funcname:"Ship.setPilot"}),s.builder.container.trigger("xwing:claimUnique",[t,"Pilot",i.defer({lineno:854})]),i._fulfill()}(n),void 0)}(function(){var e,i,o;for(s.pilot=t,null!=s.pilot&&s.setupAddons(),s.builder.container.trigger("xwing:pointsUpdated"),o=s.row.attr("class").split(" "),e=0,i=o.length;i>e;e++)n=o[e],0===n.indexOf("ship-")&&s.row.removeClass(n);return a(s.row.addClass("ship-"+s.data.name.toLowerCase().replace(/[^a-z0-9]/gi,"")+"0"))}),void 0)},t.prototype.resetPilot=function(){var t,n,e,i=this;e=__iced_k_noop,t=iced.findDeferral(arguments),function(e){var a;return null==(null!=(a=i.pilot)?a.unique:void 0)?e():(function(e){n=new iced.Deferrals(e,{parent:t,funcname:"Ship.resetPilot"}),i.builder.container.trigger("xwing:releaseUnique",[i.pilot,"Pilot",n.defer({lineno:866})]),n._fulfill()
}(e),void 0)}(function(){return i.pilot=null})},t.prototype.setupAddons=function(){var t,e,i,r,l;for(l=null!=(r=this.pilot.slots)?r:[],e=0,i=l.length;i>e;e++)t=l[e],this.upgrades.push(new s({ship:this,container:this.addon_container,slot:t}));return this.pilot.ship in o.titlesByShip&&(this.title=new a({ship:this,container:this.addon_container})),this.modification=new n({ship:this,container:this.addon_container})},t.prototype.resetAddons=function(){var t,n,e,i,a,s=this;a=__iced_k_noop,e=iced.findDeferral(arguments),function(a){var o,r,l;for(i=new iced.Deferrals(a,{parent:e,funcname:"Ship.resetAddons"}),l=s.upgrades,t=o=0,r=l.length;r>o;t=++o)n=l[t],n.destroy(i.defer({lineno:889}));null!=s.modification&&s.modification.destroy(i.defer({lineno:890})),null!=s.title&&s.title.destroy(i.defer({lineno:891})),i._fulfill()}(function(){return s.upgrades=[],s.modification=null,s.title=null})},t.prototype.getPoints=function(){var t,n,e,i,a,s,o,r,l,d,u;for(t=(null!=(a=null!=(s=this.pilot)?s.points:void 0)?a:0)+(null!=(o=null!=(r=this.modification)?r.getPoints():void 0)?o:0)+(null!=(l=null!=(d=this.title)?d.getPoints():void 0)?l:0),u=this.upgrades,e=0,i=u.length;i>e;e++)n=u[e],t+=n.getPoints();return this.points_container.text(t),null!=this.pilot&&this.points_container.show(),t},t.prototype.updateSelections=function(){var t,n,e,i;if(null==this.pilot)return this.pilot_selector.select2("data",null);for(this.pilot_selector.select2("data",{id:this.pilot.id,text:""+this.pilot.name+" ("+this.pilot.points+")"}),i=this.upgrades,n=0,e=i.length;e>n;n++)t=i[n],t.updateSelection();return null!=this.title&&this.title.updateSelection(),null!=this.modification?this.modification.updateSelection():void 0},t.prototype.setupUI=function(){var t=this;return this.row=$(document.createElement("DIV")),this.row.addClass("row-fluid ship"),this.container.append(this.row),this.row.append($.trim('<div class="span3 pilot-selector-container">\n    <input type="hidden" />\n</div>\n<div class="span1 points-display-container">\n    <span></span>\n</div>\n<div class="span7 addon-container" />\n<div class="span1 remove-btn-container">\n    <button class="btn btn-danger"><span class="visible-desktop visible-tablet hidden-phone">&times;</span><span class="hidden-desktop hidden-tablet visible-phone">Remove Pilot</span></button>\n</div>')),this.pilot_selector=$(this.row.find("div.pilot-selector-container input[type=hidden]")),this.pilot_selector.select2({width:"100%",placeholder:"Select a pilot",query:function(n){return n.callback({more:!1,results:t.builder.getAvailablePilotsIncluding(t.pilot,n.term)})}}),this.pilot_selector.on("change",function(){return t.setPilotById(t.pilot_selector.select2("val")),t.builder.current_squad.dirty=!0,t.builder.container.trigger("xwing-backend:squadDirtinessChanged"),t.builder.backend_status.fadeOut("slow")}),this.pilot_selector.data("select2").results.on("mousemove-filtered",function(n){var e;return e=$(n.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=e?e.id:void 0)?t.builder.showTooltip("Pilot",o.pilotsById[e.id]):void 0}),this.pilot_selector.data("select2").container.on("mouseover",function(){return null!=t.pilot?t.builder.showTooltip("Pilot",t.pilot):void 0}),this.points_container=$(this.row.find(".points-display-container span")),this.points_container.hide(),this.addon_container=$(this.row.find("div.addon-container")),this.remove_button=$(this.row.find("div.remove-btn-container button")),this.remove_button.click(function(n){return n.preventDefault(),t.row.slideUp("fast",function(){return t.builder.removeShip(t)})}),this.remove_button.hide()},t.prototype.teardownUI=function(){return this.row.text(""),this.row.remove()},t.prototype.toString=function(){return null!=this.pilot?"Pilot "+this.pilot.name+" flying "+this.data.name:"Ship without pilot"},t}(),t=function(){function t(t){this.ship=t.ship,this.container=$(t.container),this.data=null,this.type=null,this.dataByName=null,this.dataById=null}return t.prototype.destroy=function(){var t,n,e,i,a,s=this;a=__iced_k_noop,e=iced.findDeferral(arguments),n=arguments[0],t=arguments.length>=2?r.call(arguments,1):[],function(t){var n;return null==(null!=(n=s.data)?n.unique:void 0)?t():(function(t){i=new iced.Deferrals(t,{parent:e,funcname:"GenericAddon.destroy"}),s.ship.builder.container.trigger("xwing:releaseUnique",[s.data,s.type,i.defer({lineno:992})]),i._fulfill()}(t),void 0)}(function(){return s.selector.select2("destroy"),n(t)})},t.prototype.setupSelector=function(t){var n=this;return this.selector=$(document.createElement("INPUT")),this.selector.attr("type","hidden"),this.container.append(this.selector),this.selector.select2(t),this.selector.on("change",function(){return n.setById(n.selector.select2("val")),n.ship.builder.current_squad.dirty=!0,n.ship.builder.container.trigger("xwing-backend:squadDirtinessChanged"),n.ship.builder.backend_status.fadeOut("slow")}),this.selector.data("select2").results.on("mousemove-filtered",function(t){var e;return e=$(t.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=e?e.id:void 0)?n.ship.builder.showTooltip("Addon",n.dataById[e.id]):void 0}),this.selector.data("select2").container.on("mouseover",function(){return null!=n.data?n.ship.builder.showTooltip("Addon",n.data):void 0})},t.prototype.setById=function(t){return this.setData(this.dataById[parseInt(t)])},t.prototype.setByName=function(t){return this.setData(this.dataByName[$.trim(t)])},t.prototype.setData=function(t){var n,e,i,a=this;return i=__iced_k_noop,n=iced.findDeferral(arguments),t===this.data?i():(function(t){var i;return null==(null!=(i=a.data)?i.unique:void 0)?t():(function(t){e=new iced.Deferrals(t,{parent:n,funcname:"GenericAddon.setData"}),a.ship.builder.container.trigger("xwing:releaseUnique",[a.data,a.type,e.defer({lineno:1021})]),e._fulfill()}(t),void 0)}(function(){(function(i){return null==(null!=t?t.unique:void 0)?i():(function(i){e=new iced.Deferrals(i,{parent:n,funcname:"GenericAddon.setData"}),a.ship.builder.container.trigger("xwing:claimUnique",[t,a.type,e.defer({lineno:1023})]),e._fulfill()}(i),void 0)})(function(){return a.data=t,i(a.ship.builder.container.trigger("xwing:pointsUpdated"))})}),void 0)},t.prototype.getPoints=function(){var t,n;return null!=(t=null!=(n=this.data)?n.points:void 0)?t:0},t.prototype.updateSelection=function(){return null!=this.data?this.selector.select2("data",{id:this.data.id,text:""+this.data.name+" ("+this.data.points+")"}):this.selector.select2("data",null)},t.prototype.toString=function(){return null!=this.data?""+this.data.name+" ("+this.data.points+")":"No "+this.type},t}(),s=function(t){function n(t){n.__super__.constructor.call(this,t),this.slot=t.slot,this.type="Upgrade",this.dataById=o.upgradesById,this.dataByName=o.upgrades,this.setupSelector()}return c(n,t),n.prototype.setupSelector=function(){var t=this;return n.__super__.setupSelector.call(this,{width:"50%",placeholder:"No "+this.slot+" Upgrade",allowClear:!0,query:function(n){return n.callback({more:!1,results:t.ship.builder.getAvailableUpgradesIncluding(t.slot,t.data,n.term)})}})},n}(t),n=function(t){function n(t){n.__super__.constructor.call(this,t),this.type="Modification",this.dataById=o.modificationsById,this.dataByName=o.modifications,this.setupSelector()}return c(n,t),n.prototype.setupSelector=function(){var t=this;return n.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Modification",allowClear:!0,query:function(n){return n.callback({more:!1,results:t.ship.builder.getAvailableModificationsIncluding(t.data,n.term)})}})},n}(t),a=function(t){function n(t){n.__super__.constructor.call(this,t),this.type="Title",this.dataById=o.titlesById,this.dataByName=o.titles,this.conferredUpgrades=[],this.setupSelector()}return c(n,t),n.prototype.setData=function(t){var n,e,i,a,o,r,l=this;return r=__iced_k_noop,a=iced.findDeferral(arguments),t===this.data?r():(function(t){return null==l.data?t():(function(t){o=new iced.Deferrals(t,{parent:a,funcname:"Title.setData"}),l.ship.builder.container.trigger("xwing:releaseUnique",[l.data,"Title",o.defer({lineno:1098})]),o._fulfill()}(function(){(function(t){var n,e,s;for(o=new iced.Deferrals(t,{parent:a,funcname:"Title.setData"}),s=l.conferredUpgrades,n=0,e=s.length;e>n;n++)i=s[n],i.destroy(o.defer({lineno:1102}));o._fulfill()})(function(){var e,a,s;for(s=l.conferredUpgrades,e=0,a=s.length;a>e;e++)i=s[e],n=l.ship.upgrades.indexOf(i),l.ship.upgrades.splice(n,1);return t(l.conferredUpgrades=[])})}),void 0)}(function(){(function(n){return null==t?n():(function(n){o=new iced.Deferrals(n,{parent:a,funcname:"Title.setData"}),l.ship.builder.container.trigger("xwing:claimUnique",[t,"Title",o.defer({lineno:1107})]),o._fulfill()}(n),void 0)})(function(){var n,a,o,d;if(l.data=t,l.ship.builder.container.trigger("xwing:pointsUpdated"),null!=(null!=(o=l.data)?o.slots:void 0)&&l.data.slots.length>0)for(d=l.data.slots,n=0,a=d.length;a>n;n++)e=d[n],i=new s({ship:l.ship,container:l.container,slot:e}),l.ship.upgrades.push(i),l.conferredUpgrades.push(i);return r()})}),void 0)},n.prototype.setupSelector=function(){var t=this;return n.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Title",allowClear:!0,query:function(n){return n.callback({more:!1,results:t.ship.builder.getAvailableTitlesIncluding(t.ship.data.name,t.data,n.term)})}})},n}(t)}).call(this);