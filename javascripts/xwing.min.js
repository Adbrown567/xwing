(function(){var t,e,n,i,a,s,o=[].slice,r=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},l=function(t,e){return function(){return t.apply(e,arguments)}},c={}.hasOwnProperty,d=function(t,e){function n(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){var e=this;return++this.count,function(){var n,i;return n=arguments.length>=1?o.call(arguments,0):[],null!=t&&null!=(i=t.assign_fn)&&i.apply(null,n),e._fulfill()}},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},a="undefined"!=typeof exports&&null!==exports?exports:this,null==a.loadCards&&(a.loadCards=function(t){return a.cardLoaders[t]()}),a.sortHelper=function(t,e){var n,i;return t.points===e.points?(n=t.text.replace(/[^a-z0-9]/gi,""),i=e.text.replace(/[^a-z0-9]/gi,""),n===i?0:n>i?1:-1):t.points>e.points?1:-1},$.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)},$.randomInt=function(t){return Math.floor(Math.random()*t)},$.getParameterByName=function(t){var e,n,i;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n="[\\?&]"+t+"=([^&#]*)",e=RegExp(n),i=e.exec(window.location.search),null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},Array.prototype.intersects=function(t){var e,n,i;for(n=0,i=this.length;i>n;n++)if(e=this[n],r.call(t,e)>=0)return!0;return!1},Array.prototype.removeItem=function(t){var e;return e=this.indexOf(t),-1!==e&&this.splice(e,1),this},n=24,s=function(t,e,n){return""+t+(e[n]!==t?" ("+e[n]+")":"")},a.SquadBuilder=function(){function e(t){this._makeRandomizerLoopFunc=l(this._makeRandomizerLoopFunc,this),this._randomizerLoopBody=l(this._randomizerLoopBody,this),this.releaseUnique=l(this.releaseUnique,this),this.claimUnique=l(this.claimUnique,this),this.onSquadNameChanged=l(this.onSquadNameChanged,this),this.onSquadDirtinessChanged=l(this.onSquadDirtinessChanged,this),this.onSquadLoadRequested=l(this.onSquadLoadRequested,this),this.onPointsUpdated=l(this.onPointsUpdated,this),this.container=$(t.container),this.faction=$.trim(t.faction),this.printable_container=$(t.printable_container),this.ships=[],this.uniques_in_use={Pilot:[],Upgrade:[],Modification:[],Title:[]},this.suppress_automatic_new_ship=!1,this.tooltip_currently_displaying=null,this.randomizer_options={sources:null,points:100},this.total_points=0,this.backend=null,this.current_squad={},this.setupUI(),this.setupEventHandlers(),this.resetCurrentSquad(),$.getParameterByName("f")===this.faction?this.loadFromSerialized($.getParameterByName("d")):this.addShip()}return e.prototype.resetCurrentSquad=function(){return this.current_squad={id:null,name:$.trim(this.squad_name_input.val())||"Unnamed Squadron",dirty:!1,additional_data:{points:this.total_points,description:"",cards:[]},faction:this.faction},this.total_points>0&&(this.current_squad.name="Unsaved Squadron",this.current_squad.dirty=!0),this.container.trigger("xwing-backend:squadNameChanged"),this.container.trigger("xwing-backend:squadDirtinessChanged")},e.prototype.newSquadFromScratch=function(){return this.squad_name_input.val("New Squadron"),this.removeAllShips(),this.addShip(),this.resetCurrentSquad()},e.prototype.setupUI=function(){var t,e,n,i,s,o,r,l,c,d=this;for(e=100,n=2,t=1e3,this.status_container=$(document.createElement("DIV")),this.status_container.addClass("container-fluid"),this.status_container.append($.trim('<div class="row-fluid">\n    <div class="span4 squad-name-container">\n        <div class="display-name">\n            <span class="squad-name"></span>\n            <i class="icon-pencil"></i>\n        </div>\n        <div class="input-append">\n            <input type="text" maxlength="64" placeholder="Name your squad..." />\n            <button class="btn save"><i class="icon-edit"></i></button>\n        </div>\n    </div>\n    <div class="span2 points-display-container">Total Points: 0</div>\n    <div class="span6 pull-right button-container">\n        <div class="btn-group pull-right">\n\n            <button class="btn btn-primary view-as-text"><span class="hidden-phone">View as </span>Text</button>\n            <button class="btn btn-primary print-list hidden-phone hidden-tablet"><i class="icon-print"></i>&nbsp;Print</button>\n            <a class="btn btn-primary permalink"><i class="icon-link hidden-phone hidden-tablet"></i>&nbsp;Permalink</a>\n\n            <button class="btn btn-primary randomize" ><i class="icon-random hidden-phone hidden-tablet"></i>&nbsp;Random<span class="hidden-phone"> Squad!</span></button>\n            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">\n                <span class="caret"></span>\n            </button>\n            <ul class="dropdown-menu">\n                <li><a class="randomize-options">Randomizer Options...</a></li>\n            </ul>\n        </div>\n    </div>\n</div>\n\n<div class="row-fluid style="display: none;">\n    <div class="span12">\n        <button class="show-authenticated btn btn-primary save-list"><i class="icon-save"></i>&nbsp;Save</button>\n        <button class="show-authenticated btn btn-primary save-list-as"><i class="icon-copy"></i>&nbsp;Save As...</button>\n        <button class="show-authenticated btn btn-primary delete-list disabled"><i class="icon-trash"></i>&nbsp;Delete</button>\n        <button class="show-authenticated btn btn-primary backend-list-my-squads show-authenticated">Load Squad</button>\n        <button class="btn btn-danger clear-squad">New Squad</button>\n        <span class="show-authenticated backend-status"></span>\n    </div>\n</div>')),this.container.append(this.status_container),this.list_modal=$(document.createElement("DIV")),this.list_modal.addClass("modal hide fade text-list-modal"),this.container.append(this.list_modal),this.list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close hidden-print" data-dismiss="modal" aria-hidden="true">&times;</button>\n\n    <div class="hidden-phone hidden-print">\n        <div class="fancy-header">\n            <div class="squad-name"></div>\n            <div class="mask">\n                <div class="outer-circle">\n                    <div class="inner-circle">\n                        <span class="total-points"></span>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="fancy-under-header"></div>\n    </div>\n\n    <div class="visible-print">\n        <div class="fancy-header">\n            <div class="squad-name"></div>\n            <div class="mask">\n                <div class="outer-circle">\n                    <div class="inner-circle">\n                        <span class="total-points"></span>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="fancy-under-header"></div>\n    </div>\n\n    <div class="visible-phone hidden-print">\n        <h4><span class="squad-name"></span> (<span class="total-points"></span>)<h4>\n    </div>\n\n</div>\n<div class="modal-body">\n    <div class="fancy-list hidden-phone"></div>\n    <div class="simple-list"></div>\n</div>\n<div class="modal-footer hidden-print">\n    <button class="btn toggle-simple-view hidden-phone">Simple View</button>\n    <button class="btn print-list hidden-phone"><i class="icon-print"></i>&nbsp;Print</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.fancy_container=$(this.list_modal.find("div.modal-body .fancy-list")),this.fancy_total_points_container=$(this.list_modal.find("div.modal-header .total-points")),this.simple_container=$(this.list_modal.find("div.modal-body .simple-list")),$(window).width()>=768&&this.simple_container.hide(),this.simple_toggle_button=$(this.list_modal.find(".toggle-simple-view")),this.simple_toggle_button.data("showingSimpleView",!1),this.simple_toggle_button.click(function(){return d.simple_toggle_button.blur(),d.simple_toggle_button.data("showingSimpleView")?(d.simple_toggle_button.data("showingSimpleView",!1),d.simple_toggle_button.text("Simple View"),d.fancy_container.show(),d.simple_container.hide()):(d.simple_toggle_button.data("showingSimpleView",!0),d.simple_toggle_button.text("Fancy View"),d.fancy_container.hide(),d.simple_container.show())}),this.clear_squad_button=$(this.status_container.find(".clear-squad")),this.clear_squad_button.click(function(){return d.current_squad.dirty&&null!=d.backend?d.backend.warnUnsaved(d,function(){return d.newSquadFromScratch()}):d.newSquadFromScratch()}),this.squad_name_container=$(this.status_container.find("div.squad-name-container")),this.squad_name_display=$(this.container.find(".display-name")),this.squad_name_placeholder=$(this.container.find(".squad-name")),this.squad_name_input=$(this.squad_name_container.find("input")),this.squad_name_save_button=$(this.squad_name_container.find("button.save")),this.squad_name_input.closest("div").hide(),this.points_container=$(this.status_container.find("div.points-display-container")),this.permalink=$(this.status_container.find("div.button-container a.permalink")),this.view_list_button=$(this.status_container.find("div.button-container button.view-as-text")),this.randomize_button=$(this.status_container.find("div.button-container button.randomize")),this.customize_randomizer=$(this.status_container.find("div.button-container a.randomize-options")),this.backend_status=$(this.status_container.find(".backend-status")),this.backend_status.hide(),this.squad_name_input.keypress(function(t){return 13===t.which?(d.squad_name_save_button.click(),!1):void 0}),this.squad_name_input.change(function(){return d.backend_status.fadeOut("slow")}),this.squad_name_input.blur(function(){return d.squad_name_input.change(),d.squad_name_save_button.click()}),this.squad_name_display.click(function(t){return t.preventDefault(),d.squad_name_display.hide(),d.squad_name_input.val($.trim(d.current_squad.name)),window.setTimeout(function(){return d.squad_name_input.focus(),d.squad_name_input.select()},100),d.squad_name_input.closest("div").show()}),this.squad_name_save_button.click(function(t){var e;return t.preventDefault(),d.current_squad.dirty=!0,d.container.trigger("xwing-backend:squadDirtinessChanged"),e=d.current_squad.name=$.trim(d.squad_name_input.val()),e.length>0?(d.squad_name_display.show(),d.container.trigger("xwing-backend:squadNameChanged"),d.squad_name_input.closest("div").hide()):void 0}),this.randomizer_options_modal=$(document.createElement("DIV")),this.randomizer_options_modal.addClass("modal hide fade"),$(document).append(this.randomizer_options_modal),this.randomizer_options_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Random Squad Builder Options</h3>\n</div>\n<div class="modal-body">\n    <form>\n        <label>\n            Desired Points\n            <input type="number" class="randomizer-points" value="'+e+'" placeholder="'+e+'" />\n        </label>\n        <label>\n            Sets and Expansions (default all)\n            <select class="randomizer-sources" multiple="1" data-placeholder="Use all sets and expansions">\n            </select>\n        </label>\n        <label>\n            Maximum Seconds to Spend Randomizing\n            <input type="number" class="randomizer-timeout" value="'+n+'" placeholder="'+n+'" />\n        </label>\n        <label>\n            Maximum Randomization Iterations\n            <input type="number" class="randomizer-iterations" value="'+t+'" placeholder="'+t+'" />\n        </label>\n    </form>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary do-randomize" aria-hidden="true">Randomize!</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.randomizer_source_selector=$(this.randomizer_options_modal.find("select.randomizer-sources")),c=a.expansions,r=0,l=c.length;l>r;r++)s=c[r],o=$(document.createElement("OPTION")),o.text(s),this.randomizer_source_selector.append(o);return this.randomizer_source_selector.select2({width:"100%",minimumResultsForSearch:$.isMobile()?-1:0}),this.randomize_button.click(function(i){var a,s,o;return i.preventDefault(),d.current_squad.dirty&&null!=d.backend?d.backend.warnUnsaved(d,function(){return d.randomize_button.click()}):(s=parseInt($(d.randomizer_options_modal.find(".randomizer-points")).val()),(isNaN(s)||0>=s)&&(s=e),o=parseInt($(d.randomizer_options_modal.find(".randomizer-timeout")).val()),(isNaN(o)||0>=o)&&(o=n),a=parseInt($(d.randomizer_options_modal.find(".randomizer-iterations")).val()),(isNaN(a)||0>=a)&&(a=t),d.randomSquad(s,d.randomizer_source_selector.val(),1e3*n,a))}),this.randomizer_options_modal.find("button.do-randomize").click(function(t){return t.preventDefault(),d.randomizer_options_modal.modal("hide"),d.randomize_button.click()}),this.customize_randomizer.click(function(t){return t.preventDefault(),d.randomizer_options_modal.modal()}),this.backend_list_squads_button=$(this.container.find("button.backend-list-my-squads")),this.backend_list_squads_button.click(function(t){return t.preventDefault(),null!=d.backend?d.backend.list(d):void 0}),this.backend_save_list_button=$(this.container.find("button.save-list")),this.backend_save_list_button.click(function(t){var e,n,i,a,s;return s=__iced_k_noop,i=iced.findDeferral(arguments),t.preventDefault(),null==d.backend||$(t.target).hasClass("disabled")?s():(e={points:d.total_points,description:d.describeSquad(),cards:d.listCards()},d.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Saving squad...')),d.backend_status.show(),d.backend_save_list_button.addClass("disabled"),function(t){a=new iced.Deferrals(t,{parent:i,filename:"coffeescripts/xwing.coffee"}),d.backend.save(d.serialize(),d.current_squad.id,d.current_squad.name,d.faction,e,a.defer({assign_fn:function(){return function(){return n=arguments[0]}}(),lineno:382})),a._fulfill()}(function(){return s(n.success?(d.current_squad.dirty=!1,null!=d.current_squad.id?d.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;Squad updated successfully.')):(d.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;New squad saved successfully.')),d.current_squad.id=n.id),d.container.trigger("xwing-backend:squadDirtinessChanged")):(d.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+n.error)),d.backend_save_list_button.removeClass("disabled")))}),void 0)}),this.backend_save_list_as_button=$(this.container.find("button.save-list-as")),this.backend_save_list_as_button.addClass("disabled"),this.backend_save_list_as_button.click(function(t){return t.preventDefault(),null==d.backend||$(t.target).hasClass("disabled")?void 0:d.backend.showSaveAsModal(d)}),this.backend_delete_list_button=$(this.container.find("button.delete-list")),this.backend_delete_list_button.click(function(t){return t.preventDefault(),null==d.backend||$(t.target).hasClass("disabled")?void 0:d.backend.showDeleteModal(d)}),i=$(document.createElement("DIV")),i.addClass("container-fluid"),this.container.append(i),i.append($.trim('<div class="row-fluid">\n    <div class="span9 ship-container" />\n    <div class="span3 hidden-phone info-container" />\n</div>')),this.ship_container=$(i.find("div.ship-container")),this.info_container=$(i.find("div.info-container")),this.info_container.append($.trim('<div class="well well-small info-well">\n    <span class="info-name"></span>\n    <br />\n    <span class="info-sources"></span>\n    <table>\n        <tbody>\n            <tr class="info-ship">\n                <td>Ship</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-skill">\n                <td>Skill</td>\n                <td class="info-data info-skill"></td>\n            </tr>\n            <tr class="info-attack">\n                <td><img class="icon-attack" src="images/transparent.png" alt="Attack" /></td>\n                <td class="info-data info-attack"></td>\n            </tr>\n            <tr class="info-range">\n                <td>Range</td>\n                <td class="info-data info-range"></td>\n            </tr>\n            <tr class="info-agility">\n                <td><img class="icon-agility" src="images/transparent.png" alt="Agility" /></td>\n                <td class="info-data info-agility"></td>\n            </tr>\n            <tr class="info-hull">\n                <td><img class="icon-hull" src="images/transparent.png" alt="Hull" /></td>\n                <td class="info-data info-hull"></td>\n            </tr>\n            <tr class="info-shields">\n                <td><img class="icon-shields" src="images/transparent.png" alt="Shields" /></td>\n                <td class="info-data info-shields"></td>\n            </tr>\n            <tr class="info-actions">\n                <td>Actions</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-upgrades">\n                <td>Upgrades</td>\n                <td class="info-data"></td>\n            </tr>\n        </tbody>\n    </table>\n    <p class="info-text" />\n</div>')),this.info_container.hide(),this.print_list_button=$(this.container.find("button.print-list")),this.container.find("[rel=tooltip]").tooltip()},e.prototype.setupEventHandlers=function(){var t=this;return this.container.on("xwing:claimUnique",function(e,n,i,a){return t.claimUnique(n,i,a)}).on("xwing:releaseUnique",function(e,n,i,a){return t.releaseUnique(n,i,a)}).on("xwing:pointsUpdated",function(e,n){return null==n&&(n=$.noop),t.onPointsUpdated(n)}).on("xwing-backend:squadLoadRequested",function(e,n){return t.onSquadLoadRequested(n)}).on("xwing-backend:squadDirtinessChanged",function(){return t.onSquadDirtinessChanged()}).on("xwing-backend:squadNameChanged",function(){return t.onSquadNameChanged()}),$(window).on("xwing-backend:authenticationChanged",function(){return t.resetCurrentSquad()}).on("xwing:updateText",function(e,n){var i,a,s,o,r;for(null==n&&(n=$.noop),i=t.serialize(),t.loadFromSerialized(i),r=t.ships,s=0,o=r.length;o>s;s++)a=r[s],a.updateSelections();return n()}),this.view_list_button.click(function(e){return e.preventDefault(),t.showTextListModal()}),this.print_list_button.click(function(e){var n,i,a,s;for(e.preventDefault(),t.printable_container.find(".printable-header").html(t.list_modal.find(".modal-header").html()),t.printable_container.find(".printable-body").html(t.list_modal.find(".modal-body").html()),t.printable_container.find(".printable-body").text(""),s=t.ships,i=0,a=s.length;a>i;i++)n=s[i],null!=n.pilot&&t.printable_container.find(".printable-body").append(n.toHTML());return window.print()}),$(window).resize(function(){return 768>$(window).width()&&!t.simple_toggle_button.data("showingSimpleView")?t.simple_toggle_button.click():void 0})},e.prototype.onPointsUpdated=function(t){var e,n,i,a,s,o,r,l;for(this.total_points=0,r=this.ships,e=i=0,s=r.length;s>i;e=++i)n=r[e],n.validate(),this.total_points+=n.getPoints();for(this.points_container.text("Total Points: "+this.total_points),this.fancy_total_points_container.text(this.total_points),this.permalink.attr("href",""+window.location.href.split("?")[0]+"?f="+encodeURI(this.faction)+"&d="+encodeURI(this.serialize())),this.fancy_container.text(""),this.simple_container.html("<table></table>"),l=this.ships,a=0,o=l.length;o>a;a++)n=l[a],null!=n.pilot&&this.fancy_container.append(n.toHTML()),null!=n.pilot&&this.simple_container.find("table").append(n.toTableRow());return t(this.total_points)},e.prototype.onSquadLoadRequested=function(t){return this.current_squad=t,this.backend_delete_list_button.removeClass("disabled"),this.squad_name_input.val(this.current_squad.name),this.squad_name_placeholder.text(this.current_squad.name),this.loadFromSerialized(t.serialized),this.backend_status.fadeOut("slow"),this.current_squad.dirty=!1,this.container.trigger("xwing-backend:squadDirtinessChanged")},e.prototype.onSquadDirtinessChanged=function(){return this.backend_save_list_button.toggleClass("disabled",!(this.current_squad.dirty&&this.total_points>0)),this.backend_save_list_as_button.toggleClass("disabled",0===this.total_points),this.backend_delete_list_button.toggleClass("disabled",null==this.current_squad.id)},e.prototype.onSquadNameChanged=function(){var t;return t=this.current_squad.name.length>n?""+this.current_squad.name.substr(0,n)+"&hellip;":this.current_squad.name,this.squad_name_placeholder.text(""),this.squad_name_placeholder.append(t),this.squad_name_input.val(this.current_squad.name)},e.prototype.removeAllShips=function(){for(;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied"},e.prototype.showTextListModal=function(){return this.list_modal.modal("show")},e.prototype.serialize=function(){var t,e;return t=2,"v"+t+"!"+function(){var t,n,i,a;for(i=this.ships,a=[],t=0,n=i.length;n>t;t++)e=i[t],null!=e.pilot&&a.push(e.toSerialized());return a}.call(this).join(";")},e.prototype.loadFromSerialized=function(t){var e,n,i,a,s,o,r,l,c,d;if(this.suppress_automatic_new_ship=!0,this.removeAllShips(),i=/^v(\d+)!(.*)/,e=i.exec(t),null!=e)for(c=e[2].split(";"),s=0,r=c.length;r>s;s++)a=c[s],""!==a&&(n=this.addShip(),n.fromSerialized(parseInt(e[1]),a));else for(d=t.split(";"),o=0,l=d.length;l>o;o++)a=d[o],""!==t&&(n=this.addShip(),n.fromSerialized(1,a));return this.suppress_automatic_new_ship=!1,this.addShip()},e.prototype.uniqueIndex=function(t,e){if(!(e in this.uniques_in_use))throw"Invalid unique type '"+e+"'";return this.uniques_in_use[e].indexOf(t)},e.prototype.claimUnique=function(t,e,n){var i,s;if(!(0>this.uniqueIndex(t,e)))throw"Unique "+e+" '"+t.name+"' already claimed";if("Pilot"===e){if(i=a.upgrades[t.name],null!=i&&null!=(null!=i?i.unique:void 0)){if(!(0>this.uniqueIndex(i,"Upgrade")))throw"Unique "+e+" '"+t.name+"' already claimed as crew";this.uniques_in_use.Upgrade.push(i)}}else if("Upgrade"===e&&"Crew"===t.slot&&(s=a.pilots[t.name],null!=s&&null!=(null!=s?s.unique:void 0))){if(!(0>this.uniqueIndex(s,"Pilot")))throw"Unique "+e+" '"+t.name+"' already claimed as pilot";this.uniques_in_use.Pilot.push(s)}return this.uniques_in_use[e].push(t),n()},e.prototype.releaseUnique=function(t,e,n){var i,s,o;if(s=this.uniqueIndex(t,e),!(s>=0))throw"Unique "+e+" '"+t.name+"' not in use";if(this.uniques_in_use[e].splice(s,1),"Pilot"===e){if(i=a.upgrades[t.name],null!=i&&null!=(null!=i?i.unique:void 0)){if(s=this.uniqueIndex(i,"Upgrade"),0>s)throw"Unique crew accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Upgrade.splice(s,1)}}else if("Upgrade"===e&&"Crew"===t.slot&&(o=a.pilots[t.name],null!=o&&null!=(null!=o?o.unique:void 0))){if(s=this.uniqueIndex(o,"Pilot"),0>s)throw"Unique pilot accompanying "+t.name+" was not also claimed!";this.uniques_in_use.Pilot.splice(s,1)}return n()},e.prototype.addShip=function(){var t;return t=new i({builder:this,container:this.ship_container}),this.ships.push(t),t},e.prototype.removeShip=function(t){var e,n,i,a=this;i=__iced_k_noop,e=iced.findDeferral(arguments),function(i){n=new iced.Deferrals(i,{parent:e,filename:"coffeescripts/xwing.coffee",funcname:"SquadBuilder.removeShip"}),t.destroy(n.defer({lineno:665})),n._fulfill()}(function(){(function(t){n=new iced.Deferrals(t,{parent:e,filename:"coffeescripts/xwing.coffee",funcname:"SquadBuilder.removeShip"}),a.container.trigger("xwing:pointsUpdated",n.defer({lineno:666})),n._fulfill()})(function(){return a.current_squad.dirty=!0,a.container.trigger("xwing-backend:squadDirtinessChanged")})})},e.prototype.matcher=function(t,e){return t.toUpperCase().indexOf(e.toUpperCase())>=0},e.prototype.getAvailablePilotsIncluding=function(t,e){var n,i,s,o,l,c,d,u,p,h,m,f,g;for(null==e&&(e=""),d=function(){var t,s;t=a.pilots,s=[];for(i in t)n=t[i],a.ships[n.ship].faction===this.faction&&this.matcher(i,e)&&(null==n.unique||0>r.call(this.uniques_in_use.Pilot,n))&&s.push(n);return s}.call(this),null!=t&&null!=t.unique&&this.matcher(t.name,e)&&d.push(t),o={},f=function(){var t,e,i;for(i=[],t=0,e=d.length;e>t;t++)n=d[t],i.push({id:n.id,text:""+n.name+" ("+n.points+")",points:n.points,ship:n.ship});return i}(),u=0,h=f.length;h>u;u++)s=f[u],s.ship in o||(o[s.ship]=[]),o[s.ship].push(s);for(l=[],g=Object.keys(o).sort(),p=0,m=g.length;m>p;p++)c=g[p],l.push({text:c,children:o[c].sort(a.sortHelper)});return l},e.prototype.getAvailableUpgradesIncluding=function(t,e,n){var i,s,o;return null==n&&(n=""),i=function(){var e,i;e=a.upgrades,i=[];for(o in e)s=e[o],s.slot===t&&this.matcher(o,n)&&(null==s.unique||0>r.call(this.uniques_in_use.Upgrade,s))&&(null==s.faction||s.faction===this.faction)&&i.push(s);return i}.call(this),null!=e&&null!=e.unique&&this.matcher(e.name,n)&&i.push(e),function(){var t,e,n;for(n=[],t=0,e=i.length;e>t;t++)s=i[t],n.push({id:s.id,text:""+s.name+" ("+s.points+")",points:s.points});return n}().sort(a.sortHelper)},e.prototype.getAvailableModificationsIncluding=function(t,e,n){var i,s,o,l,c,d,u,p,h,m;if(null==n&&(n=""),c=function(){var t,i;t=a.modifications,i=[];for(l in t)o=t[l],!this.matcher(l,n)||!(null==o.unique||0>r.call(this.uniques_in_use.Modification,o))||null!=o.faction&&o.faction!==this.faction||null!=e&&null!=o.restriction_func&&!o.restriction_func(e)||i.push(o);return i}.call(this),i=!1,"Royal Guard TIE"===(null!=e?null!=(p=e.title)?null!=(h=p.data)?h.name:void 0:void 0:void 0))for(m=function(){var t,n,i,a;for(i=e.modifications,a=[],t=0,n=i.length;n>t;t++)o=i[t],null!=(null!=o?o.data:void 0)&&a.push(o.data);return a}(),d=0,u=m.length;u>d;d++)s=m[d],c.removeItem(s),s===t&&(i=!0);return null!=t&&(null!=t.unique&&this.matcher(t.name,n)||i)&&c.push(t),function(){var t,e,n;for(n=[],t=0,e=c.length;e>t;t++)o=c[t],n.push({id:o.id,text:""+o.name+" ("+o.points+")",points:o.points});return n}().sort(a.sortHelper)},e.prototype.getAvailableTitlesIncluding=function(t,e,n){var i,s,o;return null==n&&(n=""),o=function(){var e,o;e=a.titles,o=[];for(s in e)i=e[s],i.ship!==t.data.name||!this.matcher(s,n)||!(null==i.unique||0>r.call(this.uniques_in_use.Title,i))||null!=i.faction&&i.faction!==this.faction||null!=t&&null!=i.restriction_func&&!i.restriction_func(t)||o.push(i);return o}.call(this),null!=e&&null!=e.unique&&this.matcher(e.name,n)&&o.push(e),function(){var t,e,n;for(n=[],t=0,e=o.length;e>t;t++)i=o[t],n.push({id:i.id,text:""+i.name+" ("+i.points+")",points:i.points});return n}().sort(a.sortHelper)},e.prototype.showTooltip=function(t,e){var n,i,o,l,c,d,u,p,h,m,f,g,y,k,v,b,_,x,w,E,I,P,q;if(e!==this.tooltip_currently_displaying){switch(t){case"Ship":this.info_container.find(".info-sources").text(e.pilot.sources.sort().join(", ")),i=e.effectiveStats(),o=$.grep(i.actions,function(t){return 0>r.call(e.data.actions,t)}),this.info_container.find(".info-name").html(""+(e.pilot.unique?"&middot;&nbsp;":"")+e.pilot.name),this.info_container.find("p.info-text").html(null!=(c=e.pilot.text)?c:""),this.info_container.find("tr.info-ship td.info-data").text(e.pilot.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(s(e.pilot.skill,i,"skill")),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(s(null!=(d=null!=(b=e.pilot.ship_override)?b.attack:void 0)?d:e.data.attack,i,"attack")),this.info_container.find("tr.info-attack").show(),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(s(null!=(_=null!=(x=e.pilot.ship_override)?x.agility:void 0)?_:e.data.agility,i,"agility")),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(s(null!=(w=null!=(E=e.pilot.ship_override)?E.hull:void 0)?w:e.data.hull,i,"hull")),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(s(null!=(I=null!=(P=e.pilot.ship_override)?P.shields:void 0)?I:e.data.shields,i,"shields")),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").html(e.data.actions.concat(function(){var t,e,i;for(i=[],t=0,e=o.length;e>t;t++)n=o[t],i.push("<strong>"+n+"</strong>");return i}()).join(", ")),this.info_container.find("tr.info-actions").show(),this.info_container.find("tr.info-upgrades").show(),this.info_container.find("tr.info-upgrades td.info-data").text(e.pilot.slots.join(", ")||"None");break;case"Pilot":this.info_container.find(".info-sources").text(e.sources.sort().join(", ")),this.info_container.find(".info-name").html(""+(e.unique?"&middot;&nbsp;":"")+e.name),this.info_container.find("p.info-text").html(null!=(q=e.text)?q:""),l=a.ships[e.ship],this.info_container.find("tr.info-ship td.info-data").text(e.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(e.skill),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(null!=(u=null!=(p=e.ship_override)?p.attack:void 0)?u:l.attack),this.info_container.find("tr.info-attack").show(),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(null!=(h=null!=(m=e.ship_override)?m.agility:void 0)?h:l.agility),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(null!=(f=null!=(g=e.ship_override)?g.hull:void 0)?f:l.hull),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(null!=(y=null!=(k=e.ship_override)?k.shields:void 0)?y:l.shields),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").text(a.ships[e.ship].actions.join(", ")),this.info_container.find("tr.info-actions").show(),this.info_container.find("tr.info-upgrades").show(),this.info_container.find("tr.info-upgrades td.info-data").text(e.slots.join(", ")||"None");break;case"Addon":this.info_container.find(".info-sources").text(e.sources.sort().join(", ")),this.info_container.find(".info-name").html(""+(e.unique?"&middot;&nbsp;":"")+e.name),this.info_container.find("p.info-text").html(null!=(v=e.text)?v:""),this.info_container.find("tr.info-ship").hide(),this.info_container.find("tr.info-skill").hide(),null!=e.attack?(this.info_container.find("tr.info-attack td.info-data").text(e.attack),this.info_container.find("tr.info-attack").show()):this.info_container.find("tr.info-attack").hide(),null!=e.range?(this.info_container.find("tr.info-range td.info-data").text(e.range),this.info_container.find("tr.info-range").show()):this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility").hide(),this.info_container.find("tr.info-hull").hide(),this.info_container.find("tr.info-shields").hide(),this.info_container.find("tr.info-actions").hide(),this.info_container.find("tr.info-upgrades").hide()}return this.info_container.show(),this.tooltip_currently_displaying=e}},e.prototype._randomizerLoopBody=function(e){var n,s,o,r,l,c,d,u,p,h,m,f,g,y,k,v,b,_,x,w,E,I,P,q,S,T,C,A,W,B,R,F,M,D,L,U;if(e.keep_running&&e.iterations<e.max_iterations){if(e.iterations++,this.total_points===e.max_points)e.keep_running=!1;else if(this.total_points<e.max_points){for(k=[],W=this.ships,b=0,E=W.length;E>b;b++){for(m=W[b],B=m.upgrades,_=0,I=B.length;I>_;_++)v=B[_],null==v.data&&k.push(v);for(null!=m.title&&null==m.title.data&&k.push(m.title),R=m.modifications,x=0,P=R.length;P>x;x++)d=R[x],null==d.data&&k.push(d)}if(c=$.randomInt(1+k.length),0===c)o=this.getAvailablePilotsIncluding(),f=o[$.randomInt(o.length)],p=f.children[$.randomInt(f.children.length)],a.pilotsById[p.id].sources.intersects(e.allowed_sources)&&(u=this.addShip(),u.setPilotById(p.id));
else switch(n=k[c-1],n.type){case"Upgrade":l=function(){var t,i,s,o;for(s=this.getAvailableUpgradesIncluding(n.slot),o=[],t=0,i=s.length;i>t;t++)v=s[t],a.upgradesById[v.id].sources.intersects(e.allowed_sources)&&o.push(v);return o}.call(this),l.length>0&&n.setById(l[$.randomInt(l.length)].id);break;case"Title":r=function(){var t,i,s,o;for(s=this.getAvailableTitlesIncluding(n.ship),o=[],t=0,i=s.length;i>t;t++)y=s[t],a.titlesById[y.id].sources.intersects(e.allowed_sources)&&o.push(y);return o}.call(this),r.length>0&&n.setById(r[$.randomInt(r.length)].id);break;case"Modification":s=function(){var t,i,s,o;for(s=this.getAvailableModificationsIncluding(null,n.ship),o=[],t=0,i=s.length;i>t;t++)d=s[t],a.modificationsById[d.id].sources.intersects(e.allowed_sources)&&o.push(d);return o}.call(this),s.length>0&&n.setById(s[$.randomInt(s.length)].id);break;default:throw"Invalid addon type "+n.type}}else{for(h=[],F=this.ships,w=0,q=F.length;q>w;w++){for(m=F[w],h.push(m),M=m.upgrades,C=0,S=M.length;S>C;C++)v=M[C],null!=v.data&&h.push(v);null!=(null!=(D=m.title)?D.data:void 0)&&h.push(m.title),null!=(null!=(L=m.modification)?L.data:void 0)&&h.push(m.modification)}if(h.length>0)if(g=h[$.randomInt(h.length)],g instanceof i)this.removeShip(g);else{if(!(g instanceof t))throw"Unknown thing to remove "+g;g.setData(null)}}return window.setTimeout(this._makeRandomizerLoopFunc(e),0)}for(window.clearTimeout(e.timer),U=this.ships,A=0,T=U.length;T>A;A++)m=U[A],m.updateSelections();return this.suppress_automatic_new_ship=!1,this.addShip()},e.prototype._makeRandomizerLoopFunc=function(t){var e=this;return function(){return e._randomizerLoopBody(t)}},e.prototype.randomSquad=function(t,e,n,i){var s,o;for(null==t&&(t=100),null==e&&(e=null),null==n&&(n=1e3),null==i&&(i=1e3),this.backend_status.fadeOut("slow"),this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw"Ships not emptied";return s={iterations:0,max_points:t,allowed_sources:e,max_iterations:i,keep_running:!0,allowed_sources:null!=e?e:a.expansions},o=function(){return s.keep_running=!1},s.timer=window.setTimeout(o,n),window.setTimeout(this._makeRandomizerLoopFunc(s),0),this.resetCurrentSquad(),this.current_squad.name="Random Squad",this.container.trigger("xwing-backend:squadNameChanged")},e.prototype.setBackend=function(t){return this.backend=t},e.prototype.describeSquad=function(){var t;return function(){var e,n,i,a;for(i=this.ships,a=[],e=0,n=i.length;n>e;e++)t=i[e],null!=t.pilot&&a.push(t.pilot.name);return a}.call(this).join(", ")},e.prototype.listCards=function(){var t,e,n,i,a,s,o,r,l,c,d;for(t={},r=this.ships,i=0,s=r.length;s>i;i++)if(e=r[i],null!=e.pilot){for(t[e.pilot.name]=null,l=e.upgrades,a=0,o=l.length;o>a;a++)n=l[a],null!=n.data&&(t[n.data.name]=null);null!=(null!=(c=e.title)?c.data:void 0)&&(t[e.title.data.name]=null),null!=(null!=(d=e.modification)?d.data:void 0)&&(t[e.modification.data.name]=null)}return Object.keys(t).sort()},e}(),i=function(){function t(t){this.builder=t.builder,this.container=t.container,this.pilot=null,this.data=null,this.upgrades=[],this.modifications=[],this.title=null,this.setupUI()}return t.prototype.destroy=function(t){var e;if(this.resetPilot(),this.resetAddons(),this.teardownUI(),e=this.builder.ships.indexOf(this),0>e)throw"Ship not registered with builder";return this.builder.ships.splice(e,1),t()},t.prototype.copyFrom=function(t){var e,n,i,a,s,o,l,c,d,u,p,h,m,f,g,y;if(t===this)throw"Cannot copy from self";if(null!=t.pilot&&null!=t.data&&!t.pilot.unique){for(this.setPilotById(t.pilot.id),i=[],null!=t.title&&t.title.conferredAddons.length>0&&i.concat(t.title.conferred_addons),null!=(null!=(p=t.modifications[0])?p.data:void 0)&&i.concat(t.modifications[0].conferred_addons),h=t.upgrades,e=s=0,c=h.length;c>s;e=++s)a=h[e],null!=a.data&&0>r.call(i,a)&&!a.data.unique&&this.upgrades[e].setById(a.data.id);if(null==(null!=(m=t.title)?m.data:void 0)||t.title.data.unique||this.title.setById(t.title.data.id),(null!=(f=t.modifications[0])?f.data:void 0)&&!t.modifications[0].data.unique&&this.modifications[0].setById(t.modifications[0].data.id),null!=t.title&&t.title.conferredAddons.length>0)for(g=t.title.conferredAddons,e=o=0,d=g.length;d>o;e=++o)n=g[e],n.data.unique||this.title.conferredAddons[e].setById(n.data.id);if(null!=t.modifications[0]&&t.modifications[0].conferredAddons.length>0)for(y=t.modifications[0].conferredAddons,e=l=0,u=y.length;u>l;e=++l)n=y[e],n.data.unique||this.modifications[0].conferredAddons[e].setById(n.data.id);return this.updateSelections(),this.builder.container.trigger("xwing:pointsUpdated"),this.builder.current_squad.dirty=!0,this.builder.container.trigger("xwing-backend:squadDirtinessChanged")}},t.prototype.setPilotById=function(t){return this.setPilot(a.pilotsById[parseInt(t)])},t.prototype.setPilotByName=function(t){return this.setPilot(a.pilots[$.trim(t)])},t.prototype.setPilot=function(t){var e,n,i,s,o=this;return s=__iced_k_noop,n=iced.findDeferral(arguments),t===this.pilot?s():(null==this.pilot&&(this.builder.suppress_automatic_new_ship||this.builder.addShip(),this.remove_button.fadeIn("fast")),this.resetPilot(),this.resetAddons(),this.data=a.ships[null!=t?t.ship:void 0],function(e){return null==(null!=t?t.unique:void 0)?e():(function(e){i=new iced.Deferrals(e,{parent:n,filename:"coffeescripts/xwing.coffee",funcname:"Ship.setPilot"}),o.builder.container.trigger("xwing:claimUnique",[t,"Pilot",i.defer({lineno:998})]),i._fulfill()}(e),void 0)}(function(){var n,i,a,r;for(o.pilot=t,null!=o.pilot&&o.setupAddons(),o.builder.container.trigger("xwing:pointsUpdated"),a=o.row.attr("class").split(" "),n=0,i=a.length;i>n;n++)e=a[n],0===e.indexOf("ship-")&&o.row.removeClass(e);return o.row.addClass("ship-"+o.data.name.toLowerCase().replace(/[^a-z0-9]/gi,"")+"0"),s(o.copy_button.toggle(!(null!=(r=o.pilot)?r.unique:void 0)))}),void 0)},t.prototype.resetPilot=function(){var t,e,n,i=this;n=__iced_k_noop,t=iced.findDeferral(arguments),function(n){var a;return null==(null!=(a=i.pilot)?a.unique:void 0)?n():(function(n){e=new iced.Deferrals(n,{parent:t,filename:"coffeescripts/xwing.coffee",funcname:"Ship.resetPilot"}),i.builder.container.trigger("xwing:releaseUnique",[i.pilot,"Pilot",e.defer({lineno:1011})]),e._fulfill()}(n),void 0)}(function(){return i.pilot=null})},t.prototype.setupAddons=function(){var t,e,n,i,s;for(s=null!=(i=this.pilot.slots)?i:[],e=0,n=s.length;n>e;e++)t=s[e],this.upgrades.push(new a.Upgrade({ship:this,container:this.addon_container,slot:t}));return this.pilot.ship in a.titlesByShip&&(this.title=new a.Title({ship:this,container:this.addon_container})),this.modifications.push(new a.Modification({ship:this,container:this.addon_container}))},t.prototype.resetAddons=function(){var t,e,n,i,a,s=this;a=__iced_k_noop,n=iced.findDeferral(arguments),function(a){var o,r,l,c,d,u;for(i=new iced.Deferrals(a,{parent:n,filename:"coffeescripts/xwing.coffee",funcname:"Ship.resetAddons"}),null!=s.title&&s.title.destroy(i.defer({lineno:1033})),d=s.upgrades,o=0,l=d.length;l>o;o++)e=d[o],e.destroy(i.defer({lineno:1035}));for(u=s.modifications,r=0,c=u.length;c>r;r++)t=u[r],null!=t&&t.destroy(i.defer({lineno:1037}));i._fulfill()}(function(){return s.upgrades=[],s.modifications=[],s.title=null})},t.prototype.getPoints=function(){var t,e,n,i,a,s,o,r,l,c,d,u,p,h;for(e=(null!=(r=null!=(l=this.pilot)?l.points:void 0)?r:0)+(null!=(c=null!=(d=this.title)?d.getPoints():void 0)?c:0),u=this.upgrades,i=0,s=u.length;s>i;i++)n=u[i],e+=n.getPoints();for(p=this.modifications,a=0,o=p.length;o>a;a++)t=p[a],e+=null!=(h=null!=t?t.getPoints():void 0)?h:0;return this.points_container.text(e),null!=this.pilot&&this.points_container.show(),e},t.prototype.updateSelections=function(){var t,e,n,i,a,s,o,r,l;if(null!=this.pilot){for(this.pilot_selector.select2("data",{id:this.pilot.id,text:""+this.pilot.name+" ("+this.pilot.points+")"}),o=this.upgrades,n=0,a=o.length;a>n;n++)e=o[n],e.updateSelection();for(null!=this.title&&this.title.updateSelection(),r=this.modifications,l=[],i=0,s=r.length;s>i;i++)t=r[i],null!=t?l.push(t.updateSelection()):l.push(void 0);return l}return this.pilot_selector.select2("data",null)},t.prototype.setupUI=function(){var t=this;return this.row=$(document.createElement("DIV")),this.row.addClass("row-fluid ship"),this.container.append(this.row),this.row.append($.trim('<div class="span3 pilot-selector-container">\n    <input type="hidden" />\n</div>\n<div class="span1 points-display-container">\n    <span></span>\n</div>\n<div class="span6 addon-container" />\n<div class="span2 button-container">\n    <button class="btn btn-danger remove-pilot"><span class="visible-desktop visible-tablet hidden-phone" data-toggle="tooltip" title="Remove Pilot"><i class="icon-remove"></i></span><span class="hidden-desktop hidden-tablet visible-phone">Remove Pilot</span></button>\n    <button class="btn copy-pilot"><span class="visible-desktop visible-tablet hidden-phone" data-toggle="tooltip" title="Clone Pilot"><i class="icon-copy"></i></span><span class="hidden-desktop hidden-tablet visible-phone">Clone Pilot</span></button>\n</div>')),this.row.find(".button-container span").tooltip(),this.pilot_selector=$(this.row.find("div.pilot-selector-container input[type=hidden]")),this.pilot_selector.select2({width:"100%",placeholder:"Select a pilot",query:function(e){return e.callback({more:!1,results:t.builder.getAvailablePilotsIncluding(t.pilot,e.term)})},minimumResultsForSearch:$.isMobile()?-1:0}),this.pilot_selector.on("change",function(){return t.setPilotById(t.pilot_selector.select2("val")),t.builder.current_squad.dirty=!0,t.builder.container.trigger("xwing-backend:squadDirtinessChanged"),t.builder.backend_status.fadeOut("slow")}),this.pilot_selector.data("select2").results.on("mousemove-filtered",function(e){var n;return n=$(e.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=n?n.id:void 0)?t.builder.showTooltip("Pilot",a.pilotsById[n.id]):void 0}),this.pilot_selector.data("select2").container.on("mouseover",function(){return null!=t.data?t.builder.showTooltip("Ship",t):void 0}),this.points_container=$(this.row.find(".points-display-container span")),this.points_container.hide(),this.addon_container=$(this.row.find("div.addon-container")),this.remove_button=$(this.row.find("button.remove-pilot")),this.remove_button.click(function(e){return e.preventDefault(),t.row.slideUp("fast",function(){var e;return t.builder.removeShip(t),null!=(e=t.backend_status)?e.fadeOut("slow"):void 0})}),this.remove_button.hide(),this.copy_button=$(this.row.find("button.copy-pilot")),this.copy_button.click(function(){var e;return e=t.builder.ships[t.builder.ships.length-1],e.copyFrom(t)}),this.copy_button.hide()},t.prototype.teardownUI=function(){return this.row.text(""),this.row.remove()},t.prototype.toString=function(){return null!=this.pilot?"Pilot "+this.pilot.name+" flying "+this.data.name:"Ship without pilot"},t.prototype.toHTML=function(){var t,e,n,i,a,o,r,l,c,d,u,p,h,m,f,g,y,k,v,b,_;for(n=this.effectiveStats(),e="",p=n.actions,l=0,d=p.length;d>l;l++)t=p[l],e+=function(){switch(t){case"Focus":return'<img class="icon-focus" src="images/transparent.png" />';case"Evade":return'<img class="icon-evade" src="images/transparent.png" />';case"Barrel Roll":return'<img class="icon-barrel-roll" src="images/transparent.png" />';case"Target Lock":return'<img class="icon-target-lock" src="images/transparent.png" />';case"Boost":return'<img class="icon-boost" src="images/transparent.png" />';default:return"<span>&nbsp;"+t+"<span>"}}();if(i=$.trim('<div class="fancy-pilot-header">\n    <div class="pilot-header-text">'+this.pilot.name+" / "+this.data.name+'</div>\n    <div class="mask">\n        <div class="outer-circle">\n            <div class="inner-circle pilot-points">'+this.pilot.points+'</div>\n        </div>\n    </div>\n</div>\n<div class="fancy-pilot-stats">\n    <div class="pilot-stats-content">\n        <span class="info-data info-skill">'+s(this.pilot.skill,n,"skill")+'</span>\n        <img class="icon-attack" src="images/transparent.png" />\n        <span class="info-data info-attack">'+s(null!=(h=null!=(m=this.pilot.ship_override)?m.attack:void 0)?h:this.data.attack,n,"attack")+'</span>\n        <img class="icon-agility" src="images/transparent.png" />\n        <span class="info-data info-agility">'+s(null!=(f=null!=(g=this.pilot.ship_override)?g.agility:void 0)?f:this.data.agility,n,"agility")+'</span>\n        <img class="icon-hull" src="images/transparent.png" />\n        <span class="info-data info-hull">'+s(null!=(y=null!=(k=this.pilot.ship_override)?k.hull:void 0)?y:this.data.hull,n,"hull")+'</span>\n        <img class="icon-shields" src="images/transparent.png" />\n        <span class="info-data info-shields">'+s(null!=(v=null!=(b=this.pilot.ship_override)?b.shields:void 0)?v:this.data.shields,n,"shields")+"</span>\n        &nbsp;\n        "+e+"\n    </div>\n</div>"),this.pilot.text&&(i+=$.trim('<div class="fancy-pilot-text">'+this.pilot.text+"</div>")),o=function(){var t,e,n,i;for(n=this.upgrades,i=[],t=0,e=n.length;e>t;t++)r=n[t],null!=r.data&&i.push(r);return i}.call(this).concat(function(){var t,e,n,i;for(n=this.modifications,i=[],t=0,e=n.length;e>t;t++)a=n[t],null!=a.data&&i.push(a);return i}.call(this)),null!=(null!=(_=this.title)?_.data:void 0)&&o.push(this.title),o.length>0){for(i+=$.trim('<div class="fancy-upgrade-container">'),c=0,u=o.length;u>c;c++)r=o[c],i+=r.toHTML();i+=$.trim("</div>")}return'<div class="fancy-ship">'+i+"</div>"},t.prototype.toTableRow=function(){var t,e,n,i,a,s,o;if(n=$.trim('<tr class="simple-pilot">\n    <td class="name">'+this.pilot.name+" &mdash; "+this.data.name+'</td>\n    <td class="points">'+this.pilot.points+"</td>\n</tr>"),e=function(){var t,e,n,a;for(n=this.upgrades,a=[],t=0,e=n.length;e>t;t++)i=n[t],null!=i.data&&a.push(i);return a}.call(this).concat(function(){var e,n,i,a;for(i=this.modifications,a=[],e=0,n=i.length;n>e;e++)t=i[e],null!=t.data&&a.push(t);return a}.call(this)),null!=(null!=(o=this.title)?o.data:void 0)&&e.push(this.title),e.length>0)for(a=0,s=e.length;s>a;a++)i=e[a],n+=i.toTableRow();return n+="<tr><td>&nbsp;</td><td></td></tr>"},t.prototype.toSerialized=function(){var t,e,n,i,a,s,o,l,c,d,u,p,h,m,f,g,y,k;if(n=null!=(c=null!=(d=this.title)?d.conferredAddons:void 0)?c:[],s=""+function(){var t,e,s,o,l,c;for(s=this.upgrades,c=[],i=t=0,e=s.length;e>t;i=++t)a=s[i],0>r.call(n,a)&&c.push(null!=(o=null!=a?null!=(l=a.data)?l.id:void 0:void 0)?o:-1);return c}.call(this),e=[],(null!=(u=this.title)?u.conferredAddons:void 0)&&this.title.conferredAddons.length>0)for(p=this.title.conferredAddons,o=0,l=p.length;l>o;o++)t=p[o],e.push(t.toSerialized());return[this.pilot.id,s,null!=(h=null!=(m=this.title)?null!=(f=m.data)?f.id:void 0:void 0)?h:-1,null!=(g=null!=(y=this.modifications[0])?null!=(k=y.data)?k.id:void 0:void 0)?g:-1,e.join(",")].join(":")},t.prototype.fromSerialized=function(t,n){var i,a,s,o,r,l,c,d,u,p,h,m,f,g,y,k,v,b,_,x,w,E,I,P,q,S,T,C;switch(t){case 1:for(E=n.split(":"),u=E[0],f=E[1],h=E[2],p=E[3],d=E[4],this.setPilotById(parseInt(u)),I=f.split(","),c=g=0,b=I.length;b>g;c=++g)m=I[c],m=parseInt(m),m>=0&&this.upgrades[c].setById(m);if(h=parseInt(h),h>=0&&this.title.setById(h),null!=this.title&&this.title.conferredAddons.length>0)for(P=p.split(","),c=y=0,_=P.length;_>y;c=++y)m=P[c],m=parseInt(m),m>=0&&this.title.conferredAddons[c].setById(m);d=parseInt(d),d>=0&&this.modifications[0].setById(d);break;case 2:for(q=n.split(":"),u=q[0],f=q[1],h=q[2],d=q[3],l=q[4],this.setPilotById(parseInt(u)),S=f.split(","),c=k=0,x=S.length;x>k;c=++k)m=S[c],m=parseInt(m),m>=0&&this.upgrades[c].setById(m);if(h=parseInt(h),h>=0&&this.title.setById(h),d=parseInt(d),d>=0&&this.modifications[0].setById(d),null!=this.title&&this.title.conferredAddons.length>0)for(T=l.split(","),c=v=0,w=T.length;w>v;c=++v){if(r=T[c],C=r.split("."),s=C[0],a=C[1],a=parseInt(a),i=e[s],o=this.title.conferredAddons[c],!(o instanceof i))throw"Expected addon class "+i.constructor.name+" for conferred addon at index "+c+" but "+o.constructor.name+" is there";o.setById(a)}}return this.updateSelections()},t.prototype.effectiveStats=function(){var t,e,n,i,a,s,o,r,l,c,d,u,p,h,m,f,g,y,k,v,b;for(e={skill:this.pilot.skill,attack:null!=(r=null!=(l=this.pilot.ship_override)?l.attack:void 0)?r:this.data.attack,agility:null!=(h=null!=(m=this.pilot.ship_override)?m.agility:void 0)?h:this.data.agility,hull:null!=(f=null!=(g=this.pilot.ship_override)?g.hull:void 0)?f:this.data.hull,shields:null!=(y=null!=(k=this.pilot.ship_override)?k.shields:void 0)?y:this.data.shields,actions:this.data.actions.slice(0)},v=this.upgrades,i=0,s=v.length;s>i;i++)n=v[i],null!=(null!=n?null!=(b=n.data)?b.modifier_func:void 0:void 0)&&n.data.modifier_func(e);for(null!=(null!=(c=this.title)?null!=(d=c.data)?d.modifier_func:void 0:void 0)&&this.title.data.modifier_func(e),u=this.modifications,a=0,o=u.length;o>a;a++)t=u[a],null!=(null!=t?null!=(p=t.data)?p.modifier_func:void 0:void 0)&&t.data.modifier_func(e);return e},t.prototype.validate=function(){var t,e,n,i,a,s,o,r,l,c,d,u,p,h,m,f,g,y,k;for(e=32,t=s=0;e>=0?e>=s:s>=e;t=e>=0?++s:--s){for(a=!0,d=this.upgrades,o=0,l=d.length;l>o;o++)if(i=d[o],null!=(null!=i?null!=(u=i.data)?u.restriction_func:void 0:void 0)&&!(null!=i?null!=(p=i.data)?p.restriction_func(this):void 0:void 0)){i.setById(null),a=!1;break}if(null==(null!=(h=this.title)?null!=(m=h.data)?m.restriction_func:void 0:void 0)||(null!=(f=this.title)?null!=(g=f.data)?g.restriction_func(this):void 0:void 0)){for(y=this.modifications,r=0,c=y.length;c>r;r++)if(n=y[r],null!=(null!=n?null!=(k=n.data)?k.restriction_func:void 0:void 0)&&!n.data.restriction_func(this)){n.setById(null),a=!1;break}if(a)break}else this.title.setById(null)}return this.updateSelections()},t}(),t=function(){function t(t){this.ship=t.ship,this.container=$(t.container),this.data=null,this.conferredAddons=[],this.serialization_code="X",this.type=null,this.dataByName=null,this.dataById=null}return t.prototype.destroy=function(){var t,e,n,i,a,s=this;a=__iced_k_noop,n=iced.findDeferral(arguments),e=arguments[0],t=arguments.length>=2?o.call(arguments,1):[],function(t){var e;return null==(null!=(e=s.data)?e.unique:void 0)?t():(function(t){i=new iced.Deferrals(t,{parent:n,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.destroy"}),s.ship.builder.container.trigger("xwing:releaseUnique",[s.data,s.type,i.defer({lineno:1346})]),i._fulfill()}(t),void 0)}(function(){return s.selector.select2("destroy"),e(t)})},t.prototype.setupSelector=function(t){var e=this;return this.selector=$(document.createElement("INPUT")),this.selector.attr("type","hidden"),this.container.append(this.selector),$.isMobile()&&(t.minimumResultsForSearch=-1),this.selector.select2(t),this.selector.on("change",function(){return e.setById(e.selector.select2("val")),e.ship.builder.current_squad.dirty=!0,e.ship.builder.container.trigger("xwing-backend:squadDirtinessChanged"),e.ship.builder.backend_status.fadeOut("slow")}),this.selector.data("select2").results.on("mousemove-filtered",function(t){var n;return n=$(t.target).closest(".select2-result-selectable").data("select2-data"),null!=(null!=n?n.id:void 0)?e.ship.builder.showTooltip("Addon",e.dataById[n.id]):void 0}),this.selector.data("select2").container.on("mouseover",function(){return null!=e.data?e.ship.builder.showTooltip("Addon",e.data):void 0})},t.prototype.setById=function(t){return this.setData(this.dataById[parseInt(t)])},t.prototype.setByName=function(t){return this.setData(this.dataByName[$.trim(t)])},t.prototype.setData=function(t){var e,n,i,a=this;return i=__iced_k_noop,e=iced.findDeferral(arguments),t===this.data?i():(function(t){var i;return null==(null!=(i=a.data)?i.unique:void 0)?t():(function(t){n=new iced.Deferrals(t,{parent:e,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.setData"}),a.ship.builder.container.trigger("xwing:releaseUnique",[a.data,a.type,n.defer({lineno:1376})]),n._fulfill()}(t),void 0)}(function(){a.rescindAddons(),function(i){return null==(null!=t?t.unique:void 0)?i():(function(i){n=new iced.Deferrals(i,{parent:e,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.setData"}),a.ship.builder.container.trigger("xwing:claimUnique",[t,a.type,n.defer({lineno:1379})]),n._fulfill()}(i),void 0)}(function(){return a.data=t,a.ship.builder.container.trigger("xwing:pointsUpdated"),i(a.conferAddons())})}),void 0)},t.prototype.conferAddons=function(){var t,e,n,i,s,o,r,l;if(null!=(null!=(o=this.data)?o.confersAddons:void 0)&&this.data.confersAddons.length>0){for(r=this.data.confersAddons,l=[],i=0,s=r.length;s>i;i++){if(t=r[i],n=t.type,e={ship:this.ship,container:this.container},null!=t.slot&&(e.slot=t.slot),t=new n(e),t instanceof a.Upgrade)this.ship.upgrades.push(t);else{if(!(t instanceof a.Modification))throw"Unexpected addon type for addon "+t;this.ship.modifications.push(t)}l.push(this.conferredAddons.push(t))}return l}},t.prototype.rescindAddons=function(){var t,e,n,i,s=this;i=__iced_k_noop,e=iced.findDeferral(arguments),function(i){var a,o,r;for(n=new iced.Deferrals(i,{parent:e,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.rescindAddons"}),r=s.conferredAddons,a=0,o=r.length;o>a;a++)t=r[a],t.destroy(n.defer({lineno:1404}));n._fulfill()}(function(){var e,n,i;for(i=s.conferredAddons,e=0,n=i.length;n>e;e++)if(t=i[e],t instanceof a.Upgrade)s.ship.upgrades.removeItem(t);else{if(!(t instanceof a.Modification))throw"Unexpected addon type for addon "+t;s.ship.modifications.removeItem(t)}return s.conferredAddons=[]})},t.prototype.getPoints=function(){var t,e;return null!=(t=null!=(e=this.data)?e.points:void 0)?t:0},t.prototype.updateSelection=function(){return null!=this.data?this.selector.select2("data",{id:this.data.id,text:""+this.data.name+" ("+this.data.points+")"}):this.selector.select2("data",null)},t.prototype.toString=function(){return null!=this.data?""+this.data.name+" ("+this.data.points+")":"No "+this.type},t.prototype.toHTML=function(){return null!=this.data?$.trim('<div class="upgrade-container">\n    <div class="mask">\n        <div class="outer-circle">\n            <div class="inner-circle upgrade-points">'+this.data.points+'</div>\n        </div>\n    </div>\n    <div class="upgrade-name">'+this.data.name+"</div>\n</div>"):""},t.prototype.toTableRow=function(){return null!=this.data?$.trim('<tr class="simple-addon">\n    <td class="name">'+this.data.name+'</td>\n    <td class="points">'+this.data.points+"</td>\n</tr>"):""},t.prototype.toSerialized=function(){var t,e;return""+this.serialization_code+"."+(null!=(t=null!=(e=this.data)?e.id:void 0)?t:-1)},t}(),a.Upgrade=function(t){function e(t){e.__super__.constructor.call(this,t),this.slot=t.slot,this.type="Upgrade",this.dataById=a.upgradesById,this.dataByName=a.upgrades,this.serialization_code="U",this.setupSelector()}return d(e,t),e.prototype.setupSelector=function(){var t=this;return e.__super__.setupSelector.call(this,{width:"50%",placeholder:"No "+this.slot+" Upgrade",allowClear:!0,query:function(e){return e.callback({more:!1,results:t.ship.builder.getAvailableUpgradesIncluding(t.slot,t.data,e.term)})}})},e}(t),a.Modification=function(t){function e(t){e.__super__.constructor.call(this,t),this.type="Modification",this.dataById=a.modificationsById,this.dataByName=a.modifications,this.serialization_code="M",this.setupSelector()}return d(e,t),e.prototype.setupSelector=function(){var t=this;return e.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Modification",allowClear:!0,query:function(e){return e.callback({more:!1,results:t.ship.builder.getAvailableModificationsIncluding(t.data,t.ship,e.term)})}})},e}(t),a.Title=function(t){function e(t){e.__super__.constructor.call(this,t),this.type="Title",this.dataById=a.titlesById,this.dataByName=a.titles,this.serialization_code="T",this.setupSelector()}return d(e,t),e.prototype.setupSelector=function(){var t=this;return e.__super__.setupSelector.call(this,{width:"50%",placeholder:"No Title",allowClear:!0,query:function(e){return e.callback({more:!1,results:t.ship.builder.getAvailableTitlesIncluding(t.ship,t.data,e.term)})}})},e}(t),e={M:a.Modification,T:a.Title,U:a.Upgrade}}).call(this);
//@ sourceMappingURL=xwing.min.map